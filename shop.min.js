let db=null;const dbReady=async function(){try{const e=await fetch("/api/firebase-config"),n=await e.json();return firebase.apps.length||firebase.initializeApp(n),db=firebase.database(),console.log("Firebase initialized successfully"),db}catch(e){return console.error("Firebase initialization failed:",e),null}}();function sanitizeHTML(e){if("string"!=typeof e)return e;const n=document.createElement("div");return n.textContent=e,n.innerHTML}function safeSetHTML(e,n){const t=["b","i","u","strong","em","span","div","br","p","small"],a=n.replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,(e,n)=>t.includes(n.toLowerCase())?e:sanitizeHTML(e));e.innerHTML=a}const EDUCATION={0:"Cahil",1:"Ä°lkokul",2:"Ortaokul",3:"Lise",4:"Ãœniversite",5:"YÃ¼ksek Lisans",6:"Doktora",7:"ProfesÃ¶r"},EDU_XP=[0,2500,5e3,1e4,25e3,4e4,75e3,2e5],CLIENT_CITIES=[{id:"ADANA",name:"Adana",x:50,y:81},{id:"ADIYAMAN",name:"AdÄ±yaman",x:66,y:72},{id:"AFYONKARAHISAR",name:"Afyon",x:25,y:53},{id:"AGRI",name:"AÄŸrÄ±",x:91,y:38},{id:"AMASYA",name:"Amasya",x:53,y:23},{id:"ANKARA",name:"Ankara",x:38,y:34},{id:"ANTALYA",name:"Antalya",x:26,y:83},{id:"ARTVIN",name:"Artvin",x:84,y:15},{id:"AYDIN",name:"AydÄ±n",x:11,y:68},{id:"BALIKESIR",name:"BalÄ±kesir",x:12,y:39},{id:"BILECIK",name:"Bilecik",x:23,y:31},{id:"BINGOL",name:"BingÃ¶l",x:77,y:51},{id:"BITLIS",name:"Bitlis",x:86,y:59},{id:"BOLU",name:"Bolu",x:31,y:22},{id:"BURDUR",name:"Burdur",x:24,y:70},{id:"BURSA",name:"Bursa",x:18,y:30},{id:"CANAKKALE",name:"Ã‡anakkale",x:4,y:31},{id:"CANKIRI",name:"Ã‡ankÄ±rÄ±",x:42,y:24},{id:"CORUM",name:"Ã‡orum",x:49,y:25},{id:"DENIZLI",name:"Denizli",x:18,y:69},{id:"DIYARBAKIR",name:"DiyarbakÄ±r",x:76,y:66},{id:"EDIRNE",name:"Edirne",x:5,y:7},{id:"ELAZIG",name:"ElazÄ±ÄŸ",x:71,y:54},{id:"ERZINCAN",name:"Erzincan",x:72,y:37},{id:"ERZURUM",name:"Erzurum",x:81,y:35},{id:"ESKISEHIR",name:"EskiÅŸehir",x:25,y:37},{id:"GAZIANTEP",name:"Gaziantep",x:61,y:80},{id:"GIRESUN",name:"Giresun",x:66,y:19},{id:"GUMUSHANE",name:"GÃ¼mÃ¼ÅŸhane",x:72,y:26},{id:"HAKKARI",name:"Hakkari",x:94,y:72},{id:"HATAY",name:"Hatay",x:55,y:94},{id:"ISPARTA",name:"Isparta",x:26,y:69},{id:"MERSIN",name:"Mersin",x:47,y:84},{id:"ISTANBUL",name:"Ä°stanbul",x:17,y:17},{id:"IZMIR",name:"Ä°zmir",x:8,y:58},{id:"KARS",name:"Kars",x:91,y:24},{id:"KASTAMONU",name:"Kastamonu",x:42,y:12},{id:"KAYSERI",name:"Kayseri",x:52,y:48},{id:"KIRKLARELI",name:"KÄ±rklareli",x:8,y:6},{id:"KIRSEHIR",name:"KÄ±rÅŸehir",x:44,y:47},{id:"KOCAELI",name:"Kocaeli",x:22,y:21},{id:"KONYA",name:"Konya",x:36,y:67},{id:"KUTAHYA",name:"KÃ¼tahya",x:23,y:43},{id:"MALATYA",name:"Malatya",x:66,y:60},{id:"MANISA",name:"Manisa",x:9,y:55},{id:"KAHRAMANMARAS",name:"KahramanmaraÅŸ",x:59,y:72},{id:"MARDIN",name:"Mardin",x:79,y:76},{id:"MUGLA",name:"MuÄŸla",x:14,y:78},{id:"MUS",name:"MuÅŸ",x:83,y:54},{id:"NEVSEHIR",name:"NevÅŸehir",x:47,y:55},{id:"NIGDE",name:"NiÄŸde",x:47,y:66},{id:"ORDU",name:"Ordu",x:64,y:18},{id:"RIZE",name:"Rize",x:78,y:17},{id:"SAKARYA",name:"Sakarya",x:25,y:21},{id:"SAMSUN",name:"Samsun",x:56,y:13},{id:"SIIRT",name:"Siirt",x:85,y:66},{id:"SINOP",name:"Sinop",x:50,y:1},{id:"SIVAS",name:"Sivas",x:59,y:37},{id:"TEKIRDAG",name:"TekirdaÄŸ",x:10,y:18},{id:"TOKAT",name:"Tokat",x:57,y:28},{id:"TRABZON",name:"Trabzon",x:73,y:17},{id:"TUNCELI",name:"Tunceli",x:72,y:48},{id:"SANLIURFA",name:"ÅanlÄ±urfa",x:69,y:78},{id:"USAK",name:"UÅŸak",x:20,y:54},{id:"VAN",name:"Van",x:92,y:57},{id:"YOZGAT",name:"Yozgat",x:48,y:36},{id:"ZONGULDAK",name:"Zonguldak",x:32,y:10},{id:"AKSARAY",name:"Aksaray",x:44,y:59},{id:"BAYBURT",name:"Bayburt",x:76,y:29},{id:"KARAMAN",name:"Karaman",x:39,y:78},{id:"KIRIKKALE",name:"KÄ±rÄ±kkale",x:41,y:36},{id:"BATMAN",name:"Batman",x:81,y:67},{id:"SIRNAK",name:"ÅÄ±rnak",x:88,y:73},{id:"BARTIN",name:"BartÄ±n",x:35,y:7},{id:"ARDAHAN",name:"Ardahan",x:89,y:16},{id:"IGDIR",name:"IÄŸdÄ±r",x:96,y:35},{id:"YALOVA",name:"Yalova",x:19,y:23},{id:"KARABUK",name:"KarabÃ¼k",x:36,y:14},{id:"KILIS",name:"Kilis",x:60,y:86},{id:"OSMANIYE",name:"Osmaniye",x:55,y:80},{id:"DUZCE",name:"DÃ¼zce",x:29,y:20}];function calculateCityDistance(e,n){if(!e||!n)return 500;if(e===n)return 0;const t=e=>void 0===CLIENT_CITIES?null:CLIENT_CITIES.find(n=>n.name===e||n.id===e.toUpperCase()||n.name.toLowerCase()===e.toLowerCase()),a=t(e),i=t(n);if(!a||!i)return 500;const r=16*(i.x-a.x),s=6*(i.y-a.y);return Math.round(Math.sqrt(r*r+s*s))}const RPG_WEAPONS={yumruk:{name:"Ã‡Ä±plak El",dmg:5,price:0,icon:"âœŠ"},sopa:{name:"Tahta Sopa",dmg:12,price:5e3,icon:"ğŸªµ"},bicak:{name:"PaslÄ± BÄ±Ã§ak",dmg:20,price:15e3,icon:"ğŸ”ª"},kilic:{name:"Demir KÄ±lÄ±Ã§",dmg:35,price:5e4,icon:"âš”ï¸"},balta:{name:"SavaÅŸ BaltasÄ±",dmg:55,price:12e4,icon:"ğŸª“"},katana:{name:"Katana",dmg:80,price:3e5,icon:"ğŸ—¡ï¸"},lazer:{name:"Lazer TabancasÄ±",dmg:150,price:1e6,icon:"ğŸ”«"}},RPG_ARMORS={tisort:{name:"YÄ±rtÄ±k TiÅŸÃ¶rt",def:0,hp:0,price:0,icon:"ğŸ‘•"},deri:{name:"Deri Ceket",def:5,hp:50,price:7500,icon:"ğŸ§¥"},yelek:{name:"Ã‡elik Yelek",def:15,hp:150,price:4e4,icon:"ğŸ¦º"},zirh:{name:"ÅÃ¶valye ZÄ±rhÄ±",def:30,hp:400,price:15e4,icon:"ğŸ›¡ï¸"},nano:{name:"Nano Suit",def:60,hp:1e3,price:5e5,icon:"ğŸ¤–"},kral:{name:"Kraliyet ZÄ±rhÄ±",def:100,hp:2500,price:2e6,icon:"ğŸ‘‘"}},JOBS={"Ä°ÅŸsiz":{reward:0,icon:"ğŸ‘¤",req_edu:0,req_item:null},Dilenci:{reward:300,icon:"ğŸª£",req_edu:0,req_item:"YÄ±rtÄ±k Karton",price:50},"Mendil SatÄ±cÄ±sÄ±":{reward:350,icon:"ğŸ§»",req_edu:0,req_item:"Mendil Paketi",price:100},"Su SatÄ±cÄ±sÄ±":{reward:400,icon:"ğŸ’§",req_edu:0,req_item:"Su Kolisi",price:150},"Seyyar SatÄ±cÄ±":{reward:450,icon:"ğŸ¥’",req_edu:0,req_item:"El ArabasÄ±",price:250},"PazarcÄ±":{reward:500,icon:"ğŸ‹",req_edu:0,req_item:"Pazar TezgahÄ±",price:400},"Sokak MÃ¼zisyeni":{reward:550,icon:"ğŸ¸",req_edu:0,req_item:"Gitar",price:500},"KaÄŸÄ±t ToplayÄ±cÄ±":{reward:600,icon:"ğŸ¥¡",req_edu:0,req_item:"Ã‡ekÃ§ek",price:600},"SimitÃ§i":{reward:650,icon:"ğŸ¥¯",req_edu:0,req_item:"Simit Tepsisi",price:750},"BroÅŸÃ¼rcÃ¼":{reward:700,icon:"ğŸ“„",req_edu:0,req_item:"El Ä°lanlarÄ±",price:850},"BoyacÄ±":{reward:750,icon:"ğŸ‘",req_edu:0,req_item:"Boya SandÄ±ÄŸÄ±",price:1e3},"Oto YÄ±kamacÄ±":{reward:800,icon:"ğŸ§½",req_edu:0,req_item:"SÃ¼nger",price:1200},Hamal:{reward:850,icon:"ğŸ‹ï¸",req_edu:0,req_item:"SÄ±rtlÄ±k",price:1500},"Ã‡Ã¶pÃ§Ã¼":{reward:900,icon:"ğŸ§¹",req_edu:0,req_item:"SÃ¼pÃ¼rge",price:1800},"BulaÅŸÄ±kÃ§Ä±":{reward:1e3,icon:"ğŸ½ï¸",req_edu:0,req_item:"Eldiven",price:2e3},Amele:{reward:1100,icon:"ğŸ§±",req_edu:0,req_item:"Baret",price:2200},"Ã‡iftÃ§i":{reward:1150,icon:"ğŸšœ",req_edu:0,req_item:"Ã‡apa",price:2500},"BalÄ±kÃ§Ä±":{reward:1200,icon:"ğŸ£",req_edu:0,req_item:"Olta",price:3e3},Tezgahtar:{reward:2e3,icon:"ğŸ·ï¸",req_edu:1,req_item:"Yazar Kasa",price:4e3},"BekÃ§i":{reward:2150,icon:"ğŸ”¦",req_edu:1,req_item:"Fener",price:5e3},Vale:{reward:2300,icon:"ğŸ”‘",req_edu:1,req_item:"Vale KartÄ±",price:5500},"BahÃ§Ä±van":{reward:2450,icon:"ğŸŒ»",req_edu:1,req_item:"Budama MakasÄ±",price:6e3},"Garaj Sorumlusu":{reward:2600,icon:"ğŸ…¿ï¸",req_edu:1,req_item:"DÃ¼dÃ¼k",price:6500},Depocu:{reward:2800,icon:"ğŸ“¦",req_edu:1,req_item:"Transpalet",price:7e3},Kurye:{reward:3e3,icon:"ğŸ›µ",req_edu:1,req_item:"Eski Motor",price:8e3},"Market GÃ¶revlisi":{reward:3200,icon:"ğŸª",req_edu:1,req_item:"Maket BÄ±Ã§aÄŸÄ±",price:8500},Benzinci:{reward:3400,icon:"â›½",req_edu:1,req_item:"Pompa",price:9e3},"ÅofÃ¶r":{reward:3600,icon:"ğŸš•",req_edu:1,req_item:"Taksi PlakasÄ±",price:1e4},Kasiyer:{reward:3800,icon:"ğŸ’µ",req_edu:1,req_item:"Barkod Okuyucu",price:12e3},"TabelacÄ±":{reward:4e3,icon:"ğŸ—ï¸",req_edu:1,req_item:"FÄ±rÃ§a Seti",price:13e3},Terzi:{reward:4250,icon:"ğŸ§µ",req_edu:1,req_item:"DikiÅŸ Makinesi",price:14e3},"GÃ¼venlik":{reward:4750,icon:"ğŸ‘®",req_edu:2,req_item:"Telsiz",price:18e3},Bodyguard:{reward:5e3,icon:"ğŸ•¶ï¸",req_edu:2,req_item:"KulaklÄ±k",price:2e4},Garson:{reward:5250,icon:"â˜•",req_edu:2,req_item:"Ã–nlÃ¼k",price:22e3},"Makyaj Artisti":{reward:5500,icon:"ğŸ’„",req_edu:2,req_item:"Makyaj Ã‡antasÄ±",price:25e3},"KuafÃ¶r":{reward:5750,icon:"ğŸ’‡",req_edu:2,req_item:"FÃ¶n Makinesi",price:28e3},"Tattoo Artisti":{reward:6e3,icon:"âœ’ï¸",req_edu:2,req_item:"DÃ¶vme Makinesi",price:3e4},Berber:{reward:6250,icon:"âœ‚ï¸",req_edu:2,req_item:"Makas Seti",price:32e3},"Fitness EÄŸitmeni":{reward:6500,icon:"ğŸ’ª",req_edu:2,req_item:"Halter",price:35e3},Barista:{reward:6750,icon:"â˜•ï¸",req_edu:2,req_item:"Kahve Makinesi",price:38e3},DJ:{reward:7e3,icon:"ğŸ§",req_edu:2,req_item:"DJ Setup",price:4e4},"FotoÄŸrafÃ§Ä±":{reward:7250,icon:"ğŸ“¸",req_edu:2,req_item:"Kamera",price:45e3},Youtuber:{reward:7500,icon:"â–¶ï¸",req_edu:2,req_item:"YayÄ±ncÄ± EkipmanÄ±",price:5e4},Cankurtaran:{reward:8e3,icon:"ğŸ†˜",req_edu:2,req_item:"Can Simidi",price:55e3},"ElektrikÃ§i":{reward:1e4,icon:"âš¡",req_edu:3,req_item:"Kontrol Kalemi",price:7e4},"TesisatÃ§Ä±":{reward:10400,icon:"ğŸš°",req_edu:3,req_item:"Ä°ngiliz AnahtarÄ±",price:75e3},Marangoz:{reward:10800,icon:"ğŸªš",req_edu:3,req_item:"Testere",price:8e4},"HemÅŸire":{reward:11200,icon:"ğŸ’‰",req_edu:3,req_item:"ÅÄ±rÄ±nga",price:85e3},Sekreter:{reward:11600,icon:"ğŸ“",req_edu:3,req_item:"Telefon",price:9e4},"KÃ¼tÃ¼phaneci":{reward:12100,icon:"ğŸ“š",req_edu:3,req_item:"Barkod Okuyucu",price:95e3},Tamirci:{reward:12600,icon:"ğŸ”§",req_edu:3,req_item:"Alet Ã‡antasÄ±",price:1e5},Laborant:{reward:13100,icon:"ğŸ”¬",req_edu:3,req_item:"TÃ¼p",price:11e4},"TÄ±bbi Laboratuvar":{reward:13600,icon:"ğŸ§ª",req_edu:3,req_item:"MikrosantrifÃ¼j",price:12e4},"AÅŸÃ§Ä±":{reward:14100,icon:"ğŸ‘¨â€ğŸ³",req_edu:3,req_item:"AÅŸÃ§Ä± BÄ±Ã§aÄŸÄ±",price:125e3},"Kabin Memuru":{reward:14600,icon:"ğŸ’",req_edu:3,req_item:"UÃ§uÅŸ KartÄ±",price:13e4},"Ä°tfaiyeci":{reward:15100,icon:"ğŸš’",req_edu:3,req_item:"YangÄ±n TÃ¼pÃ¼",price:14e4},"GÃ¼mrÃ¼k Memuru":{reward:15600,icon:"ğŸ›‚",req_edu:3,req_item:"MÃ¼hÃ¼r",price:15e4},Polis:{reward:16100,icon:"ğŸ‘®â€â™‚ï¸",req_edu:3,req_item:"Silah RuhsatÄ±",price:18e4},Grafiker:{reward:16500,icon:"ğŸ¨",req_edu:3,req_item:"Ã‡izim Tableti",price:2e5},"EmlakÃ§Ä±":{reward:16900,icon:"ğŸ ",req_edu:3,req_item:"Ajanda",price:22e4},"DalgÄ±Ã§":{reward:17200,icon:"ğŸ¤¿",req_edu:3,req_item:"Oksijen TÃ¼pÃ¼",price:24e4},"KaynakÃ§Ä±":{reward:17500,icon:"ğŸ‘¨â€ğŸ­",req_edu:3,req_item:"Kaynak Maskesi",price:25e4},"BankacÄ±":{reward:21e3,icon:"ğŸ¦",req_edu:4,req_item:"Hesap Makinesi",price:35e4},Arkeolog:{reward:21500,icon:"ğŸº",req_edu:4,req_item:"FÄ±rÃ§a",price:37e4},Muhasebeci:{reward:22e3,icon:"ğŸ“‰",req_edu:4,req_item:"Mali MÃ¼hÃ¼r",price:4e5},Sosyolog:{reward:22500,icon:"ğŸ‘¥",req_edu:4,req_item:"Anket Formu",price:42e4},"Ã–ÄŸretmen":{reward:23e3,icon:"ğŸ‘¨â€ğŸ«",req_edu:4,req_item:"Kitap Seti",price:45e4},"Psikolojik DanÄ±ÅŸman":{reward:23500,icon:"ğŸ—£ï¸",req_edu:4,req_item:"Not Defteri",price:48e4},Gazeteci:{reward:24e3,icon:"ğŸ“°",req_edu:4,req_item:"Mikrofon",price:5e5},"YatÄ±rÄ±m UzmanÄ±":{reward:24500,icon:"ğŸ“ˆ",req_edu:4,req_item:"Borsa EkranÄ±",price:55e4},"EditÃ¶r":{reward:25e3,icon:"âœï¸",req_edu:4,req_item:"Laptop",price:6e5},"YazÄ±lÄ±mcÄ±":{reward:25500,icon:"ğŸ’»",req_edu:4,req_item:"YazÄ±lÄ±m LisansÄ±",price:75e4},Mimar:{reward:26e3,icon:"ğŸ“",req_edu:4,req_item:"Ã‡izim MasasÄ±",price:85e4},"MÃ¼hendis":{reward:26500,icon:"ğŸ‘·",req_edu:4,req_item:"MÃ¼hendislik DiplomasÄ±",price:1e6},Avukat:{reward:27e3,icon:"âš–ï¸",req_edu:4,req_item:"CÃ¼bbe",price:12e5},Diyetisyen:{reward:27500,icon:"ğŸ¥—",req_edu:4,req_item:"Diyet Listesi",price:14e5},"DenetÃ§i":{reward:28e3,icon:"ğŸ“",req_edu:4,req_item:"Audit DosyasÄ±",price:16e5},Biyolog:{reward:29e3,icon:"ğŸŒ¿",req_edu:4,req_item:"Petri KabÄ±",price:18e5},Psikolog:{reward:37500,icon:"ğŸ§ ",req_edu:5,req_item:"Terapi KoltuÄŸu",price:25e5},"Veri Bilimci":{reward:38500,icon:"ğŸ“Š",req_edu:5,req_item:"SÃ¼per Bilgisayar",price:28e5},"EczacÄ±":{reward:39500,icon:"ğŸ’Š",req_edu:5,req_item:"Laboratuvar Ã–nlÃ¼ÄŸÃ¼",price:3e6},"Yapay Zeka MÃ¼hendisi":{reward:40500,icon:"ğŸ¤–",req_edu:5,req_item:"GPU Server",price:35e5},Veteriner:{reward:41500,icon:"ğŸ¾",req_edu:5,req_item:"Stetoskop",price:4e6},"Genetik MÃ¼hendisi":{reward:42500,icon:"ğŸ§¬",req_edu:5,req_item:"DNA Kiti",price:5e6},Doktor:{reward:44e3,icon:"ğŸ©º",req_edu:5,req_item:"TÄ±p DiplomasÄ±",price:8e6},"DiÅŸ Hekimi":{reward:45e3,icon:"ğŸ¦·",req_edu:5,req_item:"DiÅŸÃ§i KoltuÄŸu",price:9e6},"BaÅŸhekim":{reward:46e3,icon:"ğŸ¥",req_edu:5,req_item:"BaÅŸhekim KaÅŸesi",price:1e7},Pilot:{reward:47e3,icon:"âœˆï¸",req_edu:5,req_item:"Pilot LisansÄ±",price:25e5},"SavcÄ±":{reward:48e3,icon:"ğŸ›ï¸",req_edu:5,req_item:"Kanun KitabÄ±",price:3e6},Hakim:{reward:49e3,icon:"ğŸ”¨",req_edu:5,req_item:"Tokmak",price:35e5},"UÃ§uÅŸ MÃ¼hendisi":{reward:49500,icon:"ğŸ›«",req_edu:5,req_item:"UÃ§uÅŸ Manueli",price:4e6},"Siber GÃ¼venlik UzmanÄ±":{reward:5e4,icon:"ğŸ›¡ï¸",req_edu:5,req_item:"Åifreleme KartÄ±",price:5e6},Cerrah:{reward:75e3,icon:"ğŸ¥",req_edu:6,req_item:"NeÅŸter",price:75e5},"RektÃ¶r":{reward:8e4,icon:"ğŸ“",req_edu:6,req_item:"RektÃ¶rlÃ¼k MÃ¼hrÃ¼",price:85e5},"BÃ¼yÃ¼kelÃ§i":{reward:85e3,icon:"ğŸŒ",req_edu:6,req_item:"Diplomat Pasaportu",price:1e7},"Orkestra Åefi":{reward:9e4,icon:"ğŸ¼",req_edu:6,req_item:"Baton",price:125e5},"Bilim Ä°nsanÄ±":{reward:1e5,icon:"ğŸ§ª",req_edu:6,req_item:"Mikroskop",price:15e6},"YÃ¶netmen":{reward:11e4,icon:"ğŸ¬",req_edu:6,req_item:"Klaket",price:2e7},"NÃ¼kleer FizikÃ§i":{reward:115e3,icon:"âš›ï¸",req_edu:6,req_item:"Radyasyon Ã–lÃ§er",price:25e6},"Uzay MÃ¼hendisi":{reward:125e3,icon:"ğŸ›°ï¸",req_edu:6,req_item:"Uydu AlÄ±cÄ±sÄ±",price:35e6},Astronot:{reward:175e3,icon:"ğŸš€",req_edu:7,req_item:"Uzay MekiÄŸi Bileti",price:4e7},CEO:{reward:19e4,icon:"ğŸ‘”",req_edu:7,req_item:"Åirket Hissesi",price:5e7},Milletvekili:{reward:205e3,icon:"ğŸ›ï¸",req_edu:7,req_item:"Mazbata",price:6e7},"Devlet BaÅŸkanÄ±":{reward:22e4,icon:"ğŸ‘‘",req_edu:7,req_item:"Kral TacÄ±",price:75e6},"DÃ¼nya BankasÄ± BaÅŸkanÄ±":{reward:235e3,icon:"ğŸ’¸",req_edu:7,req_item:"AltÄ±n Kasa",price:85e6},"Kripto KralÄ±":{reward:25e4,icon:"ğŸ’",req_edu:7,req_item:"SoÄŸuk CÃ¼zdan",price:1e8}},PROFILE_CUSTOMIZATIONS={colors:[{id:"gold",name:"AltÄ±n SarÄ±sÄ±",color:"#FFD700",price:5e4,type:"name"},{id:"neon",name:"Neon YeÅŸil",color:"#39FF14",price:3e4,type:"name"},{id:"ruby",name:"Yakut KÄ±rmÄ±zÄ±sÄ±",color:"#E0115F",price:4e4,type:"name"},{id:"royal",name:"Kraliyet Mavisi",color:"#4169E1",price:4e4,type:"name"},{id:"violet",name:"Lavanta Moru",color:"#EE82EE",price:35e3,type:"name"}],backgrounds:[{id:"dark_glass",name:"KaranlÄ±k Cam",style:"background: rgba(10,10,10,0.85); backdrop-filter: blur(20px);",price:25e3},{id:"midnight",name:"Gece Mavisi",style:"background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);",price:1e5},{id:"toxic",name:"Toksik Radyasyon",style:"background: radial-gradient(circle at center, #1a4a1a 0%, #0a0a0a 100%);",price:15e4},{id:"sunset",name:"GÃ¼n BatÄ±mÄ±",style:"background: linear-gradient(45deg, #ee0979, #ff6a00); opacity: 0.9;",price:2e5},{id:"cyber",name:"Siber Punk",style:"background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%); border-color: #00d2ff;",price:3e5},{id:"rainbow",name:"GÃ¶kkuÅŸaÄŸÄ± (Hareketli)",style:"background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab); background-size: 400% 400%; animation: gradient 15s ease infinite;",price:5e5}]};let currentUser=null,currentChannelId=null;const FREE_COMMANDS=[{cmd:"!market",desc:"Market linkini sohbete atar."},{cmd:"!bakiye",desc:"Mevcut paranÄ±zÄ± gÃ¶sterir."},{cmd:"!yazitura <miktar> <y/t>",desc:"YazÄ± tura atar (x2 kazanÃ§)."},{cmd:"!slot <miktar>",desc:"Slot makinesini Ã§evirir."},{cmd:"!kutu <miktar> <1-3>",desc:"Kutu aÃ§ma oyunu (1, 2 veya 3)."},{cmd:"!zenginler",desc:"En zengin ilk 5 kiÅŸiyi listeler."},{cmd:"!transfer @kisi <miktar>",desc:"ArkadaÅŸÄ±na para gÃ¶nderir."},{cmd:"!duello @kisi <miktar>",desc:"Bahisli dÃ¼ello teklif eder."},{cmd:"!kabul",desc:"Gelen dÃ¼ello teklifini kabul eder."},{cmd:"!reddet",desc:"Gelen dÃ¼ello teklifini reddeder."},{cmd:"!rusruleti @kisi <miktar>",desc:"Rus ruleti teklif eder (timeout riski)."},{cmd:"!ruskabul",desc:"Rus ruleti teklifini kabul eder."},{cmd:"!soygun",desc:"Kanalda soygun baÅŸlatÄ±r veya katÄ±l."},{cmd:"!profil",desc:"DetaylÄ± profilinizi gÃ¶sterir."},{cmd:"!meslek",desc:"Mevcut mesleÄŸinizi gÃ¶sterir."},{cmd:"!calis",desc:"Ã‡alÄ±ÅŸÄ±p maaÅŸ alÄ±rsÄ±nÄ±z (30dk sÃ¼re)."},{cmd:"!fal",desc:"GÃ¼nÃ¼n falÄ±na bakar."},{cmd:"!burÃ§ <burÃ§>",desc:"GÃ¼nlÃ¼k burÃ§ yorumu."},{cmd:"!efkar",desc:"Efkar seviyenizi Ã¶lÃ§er."},{cmd:"!sÃ¶z",desc:"GÃ¼nÃ¼n sÃ¶zÃ¼nÃ¼ paylaÅŸÄ±r."},{cmd:"!ÅŸarkÄ±Ã¶ner",desc:"Rastgele ÅŸarkÄ± Ã¶nerir."},{cmd:"!8top <soru>",desc:"Sihirli 8 top cevaplar."},{cmd:"!iq",desc:"IQ seviyenizi Ã¶lÃ§er."},{cmd:"!ÅŸans",desc:"GÃ¼nlÃ¼k ÅŸans Ã¶lÃ§er."},{cmd:"!kiÅŸilik",desc:"KiÅŸilik analizi yapar."},{cmd:"!zar",desc:"Ä°ki zar atar."},{cmd:"!Ä±rk",desc:"Genetik Ä±rk analizi."},{cmd:"!ship <ops:kisi>",desc:"AÅŸk uyumu Ã¶lÃ§er."},{cmd:"!hava <ÅŸehir>",desc:"Hava durumunu gÃ¶sterir."},{cmd:"!troll <salla/bsod/glitch>",desc:"YayÄ±ncÄ±yÄ± troller (Ãœcretli)."},{cmd:"!hangisi <A> mÄ± <B> mi",desc:"Bot bir seÃ§im yapar."}];let currentPreview=null,currentPreviewTimeout=null;function renderFreeCommands(){const e=document.getElementById("commands-grid");e&&(e.innerHTML="",FREE_COMMANDS.forEach(n=>{const t=document.createElement("div");t.className="item-card",t.style.padding="15px",t.innerHTML=`\n            <div style="display:flex; justify-content:space-between; align-items:flex-start;">\n                <code style="color:var(--primary); font-weight:bold; font-size:0.95rem;">${n.cmd}</code>\n            </div>\n            <p style="margin:8px 0 0 0; color:#aaa; font-size:0.85rem;">${n.desc}</p>\n        `,e.appendChild(t)}))}async function loadDevlogs(){const e=document.getElementById("devlog-content");if(e)try{const n=await fetch("/api/announcements"),t=await n.json();if(!t||0===t.length)return void(e.innerHTML='<div style="color:#666; font-size:0.8rem;">HenÃ¼z duyuru yok.</div>');e.innerHTML="",t.slice(0,10).forEach(n=>{const t=new Date(n.timestamp).toLocaleDateString("tr-TR",{day:"numeric",month:"short"}),a=`badge-${n.type||"info"}`,i=document.createElement("div");i.className=`announcement-item ${a}`,i.innerHTML=`\n                <div class="ann-header">\n                    <span class="ann-type">${n.type||"info"}</span>\n                    <span class="ann-date">${t}</span>\n                </div>\n                <div class="ann-text">${n.text}</div>\n            `,e.appendChild(i)})}catch(n){console.error("Devlog yÃ¼kleme hatasÄ±:",n),e.innerHTML='<div style="color:#666; font-size:0.8rem;">Duyurular yÃ¼klenemedi.</div>'}}function toggleDevlog(e){const n=document.getElementById("devlog-sidebar"),t=document.getElementById("devlog-toggle-btn");n&&t&&(e?(n.classList.remove("collapsed"),t.classList.add("hidden"),localStorage.setItem("devlog_visible","true")):(n.classList.add("collapsed"),t.classList.remove("hidden"),localStorage.setItem("devlog_visible","false")))}async function init(){if(console.log("Waiting for Firebase..."),!await dbReady)return console.error("Database not ready!"),showToast("VeritabanÄ± baÄŸlantÄ±sÄ± kurulamadÄ±. Yenileniyor...","error"),void setTimeout(()=>window.location.reload(),3e3);console.log("Market initialized");const e=localStorage.getItem("aloskegang_user");renderFreeCommands(),loadDevlogs(),renderDynamicTabs(),toggleDevlog("false"!==localStorage.getItem("devlog_visible")),e?login(e):showAuth();const n=document.getElementById("generate-code-btn");n&&(n.replaceWith(n.cloneNode(!0)),document.getElementById("generate-code-btn").addEventListener("click",startAuth));const t=document.getElementById("back-btn");t&&t.addEventListener("click",showAuth);const a=document.getElementById("logout-btn");a&&a.addEventListener("click",logout),db.ref("system/force_logout").on("value",e=>{const n=e.val();n&&n>(localStorage.getItem("last_processed_logout")||0)&&(console.log("FORCE LOGOUT RECEIVED"),localStorage.setItem("last_processed_logout",n),currentUser&&(logout(),showToast("Admin tarafÄ±ndan Ã§Ä±kÄ±ÅŸ yaptÄ±rÄ±ldÄ±.","warning")))})}function showAuth(){const e=document.getElementById("auth-container"),n=document.getElementById("main-content"),t=document.getElementById("step-1"),a=document.getElementById("step-2");e&&e.classList.remove("hidden"),n&&n.classList.add("hidden"),t&&t.classList.remove("hidden"),a&&a.classList.add("hidden"),window.authPoller&&(clearInterval(window.authPoller),window.authPoller=null)}function startAuth(){const e=document.getElementById("username-input").value.toLowerCase().trim();if(e.length<3)return showToast("GeÃ§ersiz kullanÄ±cÄ± adÄ±!","error");if(/[.#$\[\]]/.test(e))return showToast("KullanÄ±cÄ± adÄ± geÃ§ersiz karakterler iÃ§eriyor!","error");const n=document.getElementById("auth-code"),t=document.getElementById("cmd-example"),a=document.getElementById("step-1"),i=document.getElementById("step-2");showToast("Kod oluÅŸturuluyor...","info"),fetch("/api/auth/generate-code",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e})}).then(e=>e.json()).then(r=>{if(!r.success)return void showToast(r.error||"Kod oluÅŸturulamadÄ±!","error");const s=r.code;n&&(n.innerText=s),t&&(t.innerText=`!doÄŸrulama ${s}`),a&&a.classList.add("hidden"),i&&i.classList.remove("hidden"),console.log(`[Shop] Auth code generated for ${e}: ${s}`),showToast("Kod oluÅŸturuldu! Twitch'te komutu yaz.","success");let o=0;const d=setInterval(async()=>{if(o++,o>120)return clearInterval(d),showToast("DoÄŸrulama sÃ¼resi doldu. Tekrar deneyin.","warning"),a&&a.classList.remove("hidden"),void(i&&i.classList.add("hidden"));try{const n=await fetch(`/api/auth/check/${e}`),t=await n.json();t.authenticated&&(clearInterval(d),t.token&&localStorage.setItem("aloskegang_token",t.token),login(e),showToast("GiriÅŸ BaÅŸarÄ±lÄ±! HoÅŸ geldin.","success"))}catch(e){console.error("Auth polling error:",e)}},1e3);window.authPoller=d}).catch(e=>{console.error("Auth API Error:",e),showToast("Sunucu baÄŸlantÄ± hatasÄ±!","error"),a&&a.classList.remove("hidden"),i&&i.classList.add("hidden")})}function getTodayKey(){return(new Date).toLocaleDateString("en-CA",{timeZone:"Europe/Istanbul"})}async function getUserData(){if(lastUserData)return lastUserData;if(!currentUser)return{};try{const e=(await db.ref("users/"+currentUser).once("value")).val();if(e)return e}catch(e){}try{const e=await fetch("/api/user/"+currentUser,{headers:{Authorization:`Bearer ${localStorage.getItem("aloskegang_token")}`}}),n=await e.json();if(n&&!n.error)return n}catch(e){}return{}}async function fetchKickPFP(e){try{const n=document.getElementById("user-pfp"),t=document.getElementById("user-pfp-fallback"),a=await fetch(`/api/kick/pfp/${e}`);if(!a.ok)throw new Error("PFP API error");const i=await a.json();i.pfp&&n&&(n.src=i.pfp,n.onload=()=>{n.style.display="block",t&&(t.style.display="none")})}catch(e){}}function login(e){currentUser=e,localStorage.setItem("aloskegang_user",e),localStorage.getItem("last_processed_logout")||localStorage.setItem("last_processed_logout",Date.now()),localStorage.setItem("last_processed_logout",Date.now());const n=document.getElementById("auth-container"),t=document.getElementById("main-content");n&&n.classList.add("hidden"),t&&t.classList.remove("hidden");const a=document.getElementById("display-name"),i=document.getElementById("hero-name");a&&(a.innerText=e.toUpperCase()),i&&(i.innerText=e.toUpperCase());const r=document.getElementById("user-pfp-fallback");r&&(r.innerText=e[0].toUpperCase()),fetchKickPFP(e),db.ref("users/"+e).on("value",e=>{const n=e.val();n&&updateUserUI(n)}),fetch("/api/user/"+e).then(e=>e.json()).then(e=>{e&&!e.error&&updateUserUI(e)}).catch(e=>console.log("User API fetch failed:",e)),setTimeout(()=>switchTab("market"),100)}window.addEventListener("DOMContentLoaded",init);let lastUserData=null;function updateUserUI(e){if(!e)return;lastUserData=e;const n=document.getElementById("user-balance");if(n&&(e.is_infinite?(n.innerText="Omega'nÄ±n KartÄ± ğŸ’³â™¾ï¸",n.style.background="linear-gradient(135deg, #FFD700, #FFA500)",n.style.color="#000"):(n.innerText=`${(e.balance||0).toLocaleString()} ğŸ’°`,n.style.background="",n.style.color="")),e.auth_channel&&e.auth_channel!==currentChannelId)currentChannelId=e.auth_channel,loadChannelMarket(currentChannelId);else if(!e.auth_channel){const e=document.getElementById("no-channel-msg"),n=document.getElementById("market-items"),t=document.getElementById("channel-badge"),a=document.getElementById("market-status");e&&e.classList.remove("hidden"),n&&(n.innerHTML=""),t&&t.classList.add("hidden"),a&&(a.innerText="Market Ã¼rÃ¼nlerini gÃ¶rmek iÃ§in herhangi bir kanalda !doÄŸrulama yapmalÄ±sÄ±n.")}loadCareer()}async function loadChannelMarket(e){document.getElementById("no-channel-msg").classList.add("hidden");const n=document.getElementById("channel-badge");n&&n.classList.remove("hidden");const t=(await db.ref("channels/"+e).once("value")).val()||{},a=t.settings||{},i=a.custom_sounds||{},r=t.username||"Kick KanalÄ±";document.getElementById("chan-name").innerText=r;try{const e=document.getElementById("chan-pfp"),n=document.getElementById("chan-pfp-fallback"),t=await fetch(`/api/kick/pfp/${r}`);if(!t.ok)throw new Error("PFP error");const a=await t.json();if(!a.pfp)throw new Error("No pfp data");e.src=a.pfp,e.onload=()=>{e.style.display="block",n&&(n.style.display="none")},e.onerror=()=>{e.style.display="none",n&&(n.style.display="flex")}}catch(e){console.log("Broadcaster PFP error",e);const n=document.getElementById("chan-pfp"),t=document.getElementById("chan-pfp-fallback");n&&(n.style.display="none"),t&&(t.innerText=r[0].toUpperCase(),t.style.display="flex")}const s="https://media.giphy.com/media/3o7TKMGpxPucV0G3S0/giphy.gif",o=e=>e?e.startsWith("http")?e:`/${e}`:s,d=o(a.left_gif),c=o(a.right_gif),l=document.querySelector(".side-gif.left img"),u=document.querySelector(".side-gif.right img");l&&(l.src=d,l.onerror=()=>{l.src=s}),u&&(u.src=c,u.onerror=()=>{u.src=s}),document.getElementById("market-status").innerText=`${r} market Ã¼rÃ¼nleri yÃ¶netiliyor.`;const m=document.getElementById("market-items");m&&(m.innerHTML="");const p=e=>!1!==a[e];renderItem("ğŸš« KullanÄ±cÄ± Sustur","Hedeflenen kiÅŸiyi 2 dakika boyunca susturur.",a.mute_cost||1e4,"mute","","",0,!p("sustur")),renderItem("ğŸ™ï¸ TTS (Sesli Mesaj)","MesajÄ±nÄ±zÄ± yayÄ±nda farklÄ± seslerle seslendirir. (Maks 500 karakter)",a.tts_cost||2500,"tts","","",0,!p("tts")),renderItem("ğŸµ ÅarkÄ± Ä°steÄŸi (!sr)","YouTube'dan istediÄŸiniz ÅŸarkÄ±yÄ± aÃ§ar.",a.sr_cost||5e3,"sr","","",0,!p("sr")),Object.entries(i).forEach(([e,n])=>{renderItem(`ğŸµ Ses: !ses ${e}`,"Kanalda Ã¶zel ses efekti Ã§alar.",n.cost,"sound",e,n.url,n.duration||0,!p("ses"))})}function renderItem(e,n,t,a,i="",r="",s=0,o=!1){const d=document.getElementById("market-items");if(!d)return;const c=document.createElement("div");c.className="item-card "+(o?"disabled":"");const l="tts"===a?"ğŸ™ï¸":"mute"===a?"ğŸš«":"sr"===a?"ğŸµ":"ğŸ¼";c.innerHTML=`\n        <div style="display:flex; justify-content:space-between; align-items:flex-start;">\n            <div class="item-icon">${l}</div>\n            ${"sound"!==a||o?"":`\n                <div style="display:flex; gap:10px;">\n                    <button onclick="previewShopSound('${r}', ${s})" style="background:none; border:none; color:var(--primary); cursor:pointer; font-size:1.5rem; padding:0;">â–¶ï¸</button>\n                    <button onclick="stopAllPreviews()" style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:1.5rem; padding:0;">â¹ï¸</button>\n                </div>\n            `}\n            ${o?'<span class="disabled-label">DEVREDIÅI</span>':""}\n        </div>\n        <h3>${e}</h3>\n        <p>${n}</p>\n        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">\n            <span class="price-tag" style="margin:0;">${parseInt(t).toLocaleString()} ğŸ’°</span>\n            ${s>0?`<small style="color:#666">${s}sn</small>`:""}\n        </div>\n        <button class="buy-btn" ${o?"disabled":""} onclick="executePurchase('${a}', '${i}', ${t})">\n            ${o?"KapalÄ±":"Hemen Uygula"}\n        </button>\n    `,d.appendChild(c)}function previewShopSound(e,n){stopAllPreviews(),currentPreview=new Audio(e),currentPreview.volume=.5,currentPreview.play().catch(e=>console.error("Ã–nizleme hatasÄ±:",e)),n>0&&(currentPreviewTimeout=setTimeout(()=>{stopAllPreviews()},1e3*n))}function stopAllPreviews(){currentPreview&&(currentPreview.pause(),currentPreview.currentTime=0,currentPreview=null),currentPreviewTimeout&&(clearTimeout(currentPreviewTimeout),currentPreviewTimeout=null)}async function executePurchase(e,n,t){if(!currentUser||!currentChannelId)return;const a=await getUserData();if(a.balance||(a.balance=0),!a.is_infinite&&(a.balance||0)<t)return showToast("Bakiye yetersiz! âŒ","error");let i="";if("tts"!==e){if("mute"===e){if(i=await showInput("KullanÄ±cÄ± Sustur","Susturulacak kullanÄ±cÄ±nÄ±n adÄ±nÄ± girin:","Ã–rn: aloske"),!i)return;i=i.replace("@","").toLowerCase().trim()}else if("sr"===e){if(i=await showInput("ÅarkÄ± Ä°steÄŸi","YouTube Video Linkini YapÄ±ÅŸtÄ±rÄ±n:","https://youtube.com/..."),!i)return;if(!i.includes("youtube.com")&&!i.includes("youtu.be"))return void await showAlert("Hata","LÃ¼tfen geÃ§erli bir YouTube linki girin!")}try{const t={username:currentUser,channelId:currentChannelId,type:e,data:{}};"sound"===e&&(t.data={trigger:n}),"mute"===e&&(t.data={target:i}),"sr"===e&&(t.data={url:i});const a=await fetch("/api/market/buy",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("aloskegang_token")}`},body:JSON.stringify(t)}),r=await a.json();r.success?(showToast(r.message,"success"),loadProfile()):showToast(r.error||"Hata oluÅŸtu!","error")}catch(e){console.error(e),showToast("Sunucu ile iletiÅŸim hatasÄ±.","error")}}else openTTSModal(t)}function openTTSModal(e){const n=document.getElementById("tts-modal");n.classList.remove("hidden"),n.style.display="flex",document.getElementById("tts-input").value="",document.getElementById("confirm-tts-buy").onclick=()=>finalizeTTSPurchase(e)}function closeTTSModal(){const e=document.getElementById("tts-modal");e.classList.add("hidden"),e.style.display="none"}async function finalizeTTSPurchase(e){const n=document.getElementById("tts-input").value.trim(),t=document.getElementById("tts-voice-select").value;if(!n)return showToast("Mesaj boÅŸ olamaz!","error");if(n.length>500)return showToast("Mesaj Ã§ok uzun!","error");const a=await getUserData();if(!a.is_infinite&&(a.balance||0)<e)return showToast("Bakiye yetersiz! âŒ","error");try{const e=await fetch("/api/market/buy",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("aloskegang_token")}`},body:JSON.stringify({username:currentUser,channelId:currentChannelId,type:"tts",data:{text:n,voice:t}})}),a=await e.json();a.success?(showToast("TTS MesajÄ±n yayÄ±na gÃ¶nderildi! ğŸ™ï¸","success"),closeTTSModal(),loadProfile()):showToast(a.error||"Ä°ÅŸlem baÅŸarÄ±sÄ±z.","error")}catch(e){console.error(e),showToast("Sunucu hatasÄ±!","error")}}const BROWSER_VOICES={standart:{pitch:1,rate:1,text:"Merhaba, bu standart TÃ¼rkÃ§e sestir."},erkek:{pitch:.7,rate:1,text:"Merhaba, bu erkek sesidir."},kadin:{pitch:1.4,rate:1,text:"Merhaba, bu kadÄ±n sesidir."},robot:{pitch:.5,rate:.8,text:"Merhaba, ben bir robotum."},yavas:{pitch:1,rate:.6,text:"Merhaba, bu yavaÅŸ sestir."},hizli:{pitch:1,rate:1.5,text:"Merhaba, bu hÄ±zlÄ± sestir."}};async function previewTTS(){const e=document.getElementById("tts-voice-select").value;if(BROWSER_VOICES[e]){const n=BROWSER_VOICES[e];window.speechSynthesis.cancel();const t=new SpeechSynthesisUtterance(n.text);return t.lang="tr-TR",t.pitch=n.pitch,t.rate=n.rate,window.speechSynthesis.speak(t),void showToast("âš¡ HÄ±zlÄ± ses oynatÄ±lÄ±yor!","success")}showToast("ğŸ­ AI ses oluÅŸturuluyor (10-30 sn bekleyin)...","info");try{const n=await fetch(`/api/tts/preview?voice=${e}`),t=await n.json();t.success&&t.audioUrl?(new Audio(t.audioUrl).play(),showToast(`âœ… ${t.voiceName||"AI"} sesi hazÄ±r!`,"success")):showToast(t.error||"Ã–rnek ses yÃ¼klenemedi!","error")}catch(e){showToast("BaÄŸlantÄ± hatasÄ±!","error")}}function logout(){localStorage.removeItem("aloskegang_user"),localStorage.clear(),sessionStorage.clear(),document.cookie.split(";").forEach(e=>{document.cookie=e.replace(/^ +/,"").replace(/=.*/,"=;expires="+(new Date).toUTCString()+";path=/")}),location.reload()}function showToast(e,n){const t=document.getElementById("toast");t&&(t.innerText=e,t.className=`toast ${n}`,t.classList.remove("hidden"),setTimeout(()=>t.classList.add("hidden"),3e3))}function switchTab(e){if(document.querySelectorAll(".tab-content").forEach(e=>e.classList.add("hidden")),document.getElementById("tab-"+e).classList.remove("hidden"),document.querySelectorAll(".tab-btn").forEach(e=>e.classList.remove("active")),"undefined"!=typeof event&&event&&event.currentTarget)event.currentTarget.classList.add("active");else{const n=document.querySelector(`.tab-btn[onclick*="switchTab('${e}')"]`);n&&n.classList.add("active")}if(window.shopTabsConfig&&window.shopTabsConfig[e]&&window.shopTabsConfig[e].locked){if(!(lastUserData&&lastUserData.is_admin||currentUser&&"omegacyr"===currentUser.toLowerCase())){const n=document.getElementById("tab-"+e);return void(n&&(n.innerHTML='\n                    <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:500px; text-align:center; color:#ff4444; animation: fadeIn 0.5s;">\n                        <div style="font-size:5rem; margin-bottom:20px; animation: bounce 2s infinite;">ğŸ”’</div>\n                        <h2 style="font-size:2.5rem; margin-bottom:15px; text-transform:uppercase; letter-spacing:2px; font-weight:900;">BAKIMDA</h2>\n                        <p style="color:#aaa; font-size:1.1rem; max-width:400px; line-height:1.6;">Bu Ã¶zellik ÅŸu anda teknik bir Ã§alÄ±ÅŸma nedeniyle geÃ§ici olarak eriÅŸime kapalÄ±dÄ±r. Daha sonra tekrar deneyin.</p>\n                    </div>\n                    <style>\n                        @keyframes bounce {\n                            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}\n                            40% {transform: translateY(-20px);}\n                            60% {transform: translateY(-10px);}\n                        }\n                        @keyframes fadeIn {\n                            from { opacity: 0; transform: translateY(20px); }\n                            to { opacity: 1; transform: translateY(0); }\n                        }\n                    </style>\n                '))}showToast("âš ï¸ BakÄ±m Modu (YÃ¶netici GiriÅŸi)","warning")}"leaderboard"===e&&loadLeaderboard(),"borsa"===e&&loadBorsa(),"emlak"===e&&loadEmlak(),"quests"===e&&loadQuests(),"profile"===e&&loadProfile(),"career"===e&&loadCareer(),"stats"===e&&loadLiveStats(),"gangs"===e&&loadGangs(),"business"===e&&onBusinessTabOpen(),"marketplace"===e&&loadMarketListings()}window.previewTTS=previewTTS;let borsaActive=!1,stockHistory={};function drawStockChart(e,n,t){if(!e||!n||n.length<2)return;const a=e.getContext("2d"),i=e.width,r=e.height,s=i-45;a.clearRect(0,0,i,r);const o=Math.min(...n),d=Math.max(...n),c=d-o||1;a.beginPath(),a.strokeStyle="rgba(255,255,255,0.03)",a.lineWidth=1,[.1,.5,.9].forEach(e=>{a.moveTo(0,r*e),a.lineTo(s,r*e)}),a.stroke(),a.beginPath(),a.strokeStyle=1===t?"#05ea6a":"#ff4d4d",a.lineWidth=2,a.lineJoin="round",n.forEach((e,t)=>{const i=t/(n.length-1)*s,d=r-(e-o)/c*r*.8-.1*r;0===t?a.moveTo(i,d):a.lineTo(i,d)}),a.stroke(),a.lineTo(s,r),a.lineTo(0,r);const l=a.createLinearGradient(0,0,0,r);l.addColorStop(0,1===t?"rgba(5,234,106,0.1)":"rgba(255,77,77,0.1)"),l.addColorStop(1,"transparent"),a.fillStyle=l,a.fill(),[{v:d,y:.1*r},{v:(d+o)/2,y:.5*r},{v:o,y:.9*r}].forEach(e=>{a.fillStyle="rgba(0,0,0,0.3)",a.fillRect(s+2,e.y-7,41,14),a.fillStyle="#888",a.font="bold 9px monospace",a.textAlign="center",a.fillText(Math.round(e.v).toLocaleString(),s+22.5,e.y+3),a.beginPath(),a.setLineDash([5,5]),a.strokeStyle="rgba(255,255,255,0.05)",a.moveTo(0,e.y),a.lineTo(s,e.y),a.stroke(),a.setLineDash([])})}async function loadBorsa(){const e=document.getElementById("borsa-items");if(e&&!borsaActive){if(borsaActive=!0,currentUser&&"omegacyr"===currentUser.toLowerCase()){let n=document.getElementById("borsa-admin-actions");n||(n=document.createElement("div"),n.id="borsa-admin-actions",n.style.marginBottom="20px",n.style.display="flex",n.style.gap="10px",e.parentElement.insertBefore(n,e)),n.innerHTML="";const t=document.createElement("button");t.innerHTML="ğŸš¨ SIFIRLA",t.className="primary-btn",t.style.background="#ff4d4d",t.style.color="white",t.style.flex="1",t.onclick=async()=>{if(!await showConfirm("âš ï¸ Borsa SÄ±fÄ±rlama","TÃ¼m kullanÄ±cÄ±larÄ±n tÃ¼m hisselerini silmek istediÄŸine emin misin?"))return;const e=await fetch("/api/borsa/reset",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({requester:"omegacyr"})}),n=await e.json();n.success&&showToast(n.message,"success")};const a=document.createElement("button");a.innerHTML="ğŸ”§ EKSÄ°K MALÄ°YET VERÄ°LERÄ°NÄ° ONAR",a.className="primary-btn",a.style.background="#ff9f43",a.style.color="white",a.style.flex="1",a.onclick=async()=>{if(!await showConfirm("ğŸ”§ Maliyet DÃ¼zelt","Eksik maliyet verisi olan hisseler iÃ§in GÃœNCEL FÄ°YAT baz alÄ±narak maliyet eklenecek. OnaylÄ±yor musun?"))return;const e=await fetch("/api/borsa/fix-costs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({requester:"omegacyr"})}),n=await e.json();n.success?showToast(n.message,"success"):showToast(n.error,"error")},n.appendChild(t),n.appendChild(a)}e.innerHTML='<div style="text-align:center; width:100%; padding:60px;"><div class="loader"></div><p style="margin-top:10px;">Borsa verileri yÃ¼kleniyor...</p></div>',db.ref("global_stocks").on("value",n=>{n.exists()&&(n=>{if(!n)return;if(window.shopStocks=n,n.error)return void(e.innerHTML=`<div class="error-box">${n.error}</div>`);const t=Object.entries(n);let a=document.getElementById("market-cycle-status");a||(e.innerHTML="",a=document.createElement("div"),a.id="market-cycle-status",a.style="grid-column: 1 / -1; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--glass-border); text-align: center;",e.appendChild(a));const i=t[0][1].marketStatus||"NORMAL",r={BULLISH:{t:"BOÄA PÄ°YASASI (YÃœKSELÄ°Å)",c:"#05ea6a"},BEARISH:{t:"AYI PÄ°YASASI (DÃœÅÃœÅ)",c:"#ff4d4d"},VOLATILE:{t:"YÃœKSEK VOLATÄ°LÄ°TE (RÄ°SKLÄ°)",c:"#ffaa00"},STAGNANT:{t:"DURGUN PÄ°YASA (YATAY)",c:"#888"},CRASH:{t:"âš ï¸ KRÄ°Z: BÃœYÃœK Ã‡Ã–KÃœÅ!",c:"red"},NORMAL:{t:"NORMAL PÄ°YASA",c:"#aaa"}};a.innerHTML=`<small style="color:#666; display:block; margin-bottom:4px;">GÃœNCEL EKONOMÄ°K DURUM</small><strong style="color:${r[i].c}; font-size:1.1rem; letter-spacing:1px;">${r[i].t}</strong>`,t.forEach(([n,t])=>{if(!t||"object"!=typeof t)return;if("status"===n)return;let a=t.oldPrice;t.history&&t.history.length>0&&(a=t.history[0]);const i=(t.price-a)/a*100,r=i.toFixed(2),s=i>=0?"ğŸ“ˆ":"ğŸ“‰",o=i>=0?"#05ea6a":"#ff4d4d";let d=document.querySelector(`.borsa-card[data-code="${n}"]`);if(d){const e=d.querySelector(".trend-val"),a=d.querySelector(".price-val"),c=d.querySelector(".btn-buy-main"),l=d.querySelector(".btn-sell-main");e.innerHTML=`${i>0?"+":""}${r}% ${s}`,e.style.color=o,a.innerHTML=`${(t.price||0).toLocaleString()} <span style="font-size:0.8rem; color:var(--primary);">ğŸ’°</span>`,c.onclick=()=>executeBorsaBuy(n,t.price),l.onclick=()=>executeBorsaSell(n,t.price)}else d=document.createElement("div"),d.className="item-card borsa-card",d.setAttribute("data-code",n),d.innerHTML=`\n                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">\n                        <div style="display:flex; flex-direction:column;">\n                            <span style="font-weight:800; font-size:1.1rem; color:var(--primary);">${n}</span>\n                            ${t.name?`<span style="font-size:0.75rem; color:#888;">${t.name}</span>`:""}\n                        </div>\n                        <span class="trend-val" style="color:${o}; font-weight:800; font-size:0.75rem;">\n                            ${i>0?"+":""}${r}% ${s}\n                        </span>\n                    </div>\n                    \n                    <div style="font-size:0.6rem; color:#666; margin-bottom:4px; text-transform:uppercase; letter-spacing:1px;">Son 24-48 Saatlik Grafik</div>\n                    <canvas id="chart-${n}" width="200" height="60" style="width:100%; height:60px; margin:5px 0;"></canvas>\n\n                    <div class="price-val" style="font-size:1.5rem; font-weight:800; color:white; margin:10px 0;">\n                        ${(t.price||0).toLocaleString()} <span style="font-size:0.8rem; color:var(--primary);">ğŸ’°</span>\n                    </div>\n\n                    <div style="font-size: 0.65rem; color: #ff4d4d; margin-bottom: 8px; font-weight: 600;">âš ï¸ %10 SatÄ±ÅŸ Komisyonu UygulanÄ±r</div>\n\n                    \x3c!-- AnlÄ±k Fiyat GÃ¶sterimi --\x3e\n                    <div id="price-calc-${n}" style="font-size:0.75rem; margin-bottom:10px; padding:8px; background:rgba(0,0,0,0.3); border-radius:8px; display:none;">\n                        <div style="display:flex; justify-content:space-between; color:#aaa;">\n                            <span>ğŸ“ˆ AlÄ±ÅŸ:</span>\n                            <span id="buy-price-${n}" style="color:var(--primary); font-weight:700;">-</span>\n                        </div>\n                        <div style="display:flex; justify-content:space-between; color:#aaa; margin-top:4px;">\n                            <span>ğŸ“‰ SatÄ±ÅŸ (-10%):</span>\n                            <span id="sell-price-${n}" style="color:#ff6b6b; font-weight:700;">-</span>\n                        </div>\n                    </div>\n\n                    <div class="borsa-controls" style="margin-top:10px;">\n                        <input type="number" id="input-${n}" class="borsa-input" value="1" min="0.00000001" step="any" placeholder="Adet" aria-label="${n} Adet SatÄ±n Al/Sat" oninput="updateBorsaPrice('${n}', ${t.price})">\n                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">\n                            <button class="buy-btn btn-buy-main" onclick="executeBorsaBuy('${n}', ${t.price})" style="background:var(--primary); color:black; font-weight:800; padding:8px;">AL</button>\n                            <button class="buy-btn btn-sell-main" onclick="executeBorsaSell('${n}', ${t.price})" style="background:rgba(255,255,255,0.05); color:white; border:1px solid var(--glass-border); padding:8px;">SAT</button>\n                        </div>\n                    </div>\n                `,e.appendChild(d);const c=[...t.history||[]];t.price&&c.push(t.price),drawStockChart(document.getElementById(`chart-${n}`),c,t.trend),updateBorsaPrice(n,t.price)})})(n.val())}),db.ref("global_news").limitToLast(10).on("value",e=>{e.exists()&&renderNews(e.val())})}}function renderNews(e){const n=document.getElementById("news-ticker-container");if(!n)return;n.innerHTML="";const t=document.getElementById("news-date-display"),a=document.getElementById("news-last-update"),i=new Date;t&&(t.textContent=i.toLocaleDateString("tr-TR",{day:"numeric",month:"long",year:"numeric"})),a&&(a.textContent=i.toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"}));const r=Object.values(e).sort((e,n)=>n.timestamp-e.timestamp);0!==r.length?r.forEach((e,t)=>{const a=new Date(e.timestamp).toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"}),i="GOOD"===e.type,r=0===t&&Date.now()-e.timestamp<3e5,s=document.createElement("div");s.className="news-item"+(r?" breaking":""),s.innerHTML=`\n            <div class="news-time">${a}</div>\n            <div class="news-content">\n                <div class="news-indicator ${i?"good":"bad"}">\n                    <span class="news-indicator-dot"></span>\n                    ${i?"ğŸ“ˆ YÃœKSELÄ°Å":"ğŸ“‰ DÃœÅÃœÅ"}\n                </div>\n                <div class="news-headline">${e.text}</div>\n            </div>\n        `,n.appendChild(s)}):n.innerHTML='\n            <div class="news-empty">\n                <i class="fas fa-newspaper"></i>\n                HenÃ¼z piyasa haberi yok...\n            </div>\n        '}function updateBorsaPrice(e,n){const t=document.getElementById(`input-${e}`),a=document.getElementById(`price-calc-${e}`),i=document.getElementById(`buy-price-${e}`),r=document.getElementById(`sell-price-${e}`);if(!(t&&a&&i&&r))return;const s=parseFloat(t.value.replace(",","."));if(!s||isNaN(s)||s<=0)return void(a.style.display="none");a.style.display="block";const o=Math.floor(n*s),d=Math.floor(n*s),c=Math.floor(.9*d);i.textContent=o.toLocaleString()+" ğŸ’°",r.textContent=c.toLocaleString()+" ğŸ’°"}async function executeBorsaBuy(e,n){if(!currentUser)return;const t=document.getElementById(`input-${e}`),a=parseFloat(t.value.replace(",","."));if(!a||isNaN(a)||a<=0)return showToast("GeÃ§ersiz miktar!","error");try{const n=await fetch("/api/borsa/buy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser,code:e,amount:a})}),t=await n.json();t.success?(showToast(t.message,"success"),loadProfile()):showToast(t.error,"error")}catch(e){showToast("Sunucu hatasÄ±!","error")}}async function executeBorsaSell(e,n){if(!currentUser)return;const t=document.getElementById(`input-${e}`),a=parseFloat(t.value.replace(",","."));if(!a||isNaN(a)||a<=0)return showToast("GeÃ§ersiz miktar!","error");try{const n=await fetch("/api/borsa/sell",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser,code:e,amount:a})}),t=await n.json();t.success?(showToast(t.message,"success"),loadProfile()):showToast(t.error,"error")}catch(e){showToast("Sunucu hatasÄ±!","error")}}let lbType="global";async function switchLB(e){lbType=e,document.querySelectorAll("#tab-leaderboard .primary-btn").forEach(e=>e.classList.remove("active")),event.currentTarget.classList.add("active"),loadLeaderboard()}async function loadLeaderboard(){const e=document.getElementById("leaderboard-container");e.innerHTML='<div class="loading-spinner"></div>';try{const n=await fetch("/api/leaderboard",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:lbType,channelId:currentChannelId})}),t=await n.json();e.innerHTML="",t.forEach((n,t)=>{const a=document.createElement("div");a.className="leader-item",a.innerHTML=`\n                <div style="display:flex; align-items:center; gap:15px;">\n                    <span class="rank">${t+1}.</span>\n                    <span style="font-weight:600;">${n.name.toUpperCase()}</span>\n                </div>\n                <span style="color:var(--primary); font-weight:800;">${n.is_infinite?"ğŸ’³â™¾ï¸":n.balance.toLocaleString()+" ğŸ’°"}</span>\n            `,e.appendChild(a)})}catch(n){console.error("Leaderboard Tablosu HatasÄ±:",n),e.innerHTML="<p>Leaderboard ÅŸu an yÃ¼klenemiyor.</p>"}}async function loadQuests(){if(!currentUser)return;const e=document.getElementById("quests-container");e.innerHTML='<div class="loading-spinner"></div>';try{const n=(await db.ref("global_quests").once("value")).val()||{};let t=lastUserData;if(!t){try{t=(await db.ref("users/"+currentUser).once("value")).val()}catch(e){}if(!t)try{const e=await fetch("/api/user/"+currentUser),n=await e.json();n&&!n.error&&(t=n)}catch(e){}}t=t||{};const a=getTodayKey(),i=t.quests?.[a]||{m:0,g:0,d:0,w:0,claimed:{}};if(e.innerHTML="",0===Object.keys(n).length)return void(e.innerHTML="<p style='text-align:center; color:var(--muted);'>Åu an aktif gÃ¶rev yok.</p>");Object.entries(n).forEach(([n,t])=>{const a=i[t.type]||0,r=i.claimed?.[n],s=a>=t.goal,o=Math.min(100,a/t.goal*100),d=document.createElement("div");d.className="quest-card",d.innerHTML=`\n                    <div style="display:flex; justify-content:space-between; align-items:center;">\n                        <h3>${t.name}</h3>\n                        <span style="color:var(--primary); font-weight:700;">+${(parseInt(t.reward)||0).toLocaleString()} ğŸ’°</span>\n                    </div>\n                    <p>GÃ¶rev TÃ¼rÃ¼: ${"m"===t.type?"Sohbet":"g"===t.type?"Kumar":"w"===t.type?"ğŸ‘ï¸ Ä°zleme":"âš”ï¸ DÃ¼ello"}</p>\n                    <div class="progress-bar"><div class="progress-fill" style="width: ${o}%"></div></div>\n                    <div style="display:flex; justify-content:space-between; align-items:center;">\n                        <small>${a}/${t.goal} ${"m"===t.type?"Mesaj":"Ä°ÅŸlem"}</small>\n                        <button class="primary-btn" style="width:auto; padding:8px 20px;" \n                            ${s&&!r?"":"disabled"} onclick="claimQuest('${n}')">\n                            ${r?"ALINDI":s?"Ã–DÃœLÃœ AL":"TAMAMLA"}\n                        </button>\n                    </div>\n                `,e.appendChild(d)})}catch(n){e.innerHTML="<p>GÃ¶revler yÃ¼klenemedi.</p>"}}async function claimQuest(e){if(currentUser)try{const n=await fetch("/api/claim-quest",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser,questId:e})}),t=await n.json();t.success?(showToast(`ğŸ‰ +${t.reward} ğŸ’° aldÄ±n!`,"success"),loadQuests(),loadProfile()):showToast(t.error,"error")}catch(e){showToast("BaÄŸlantÄ± hatasÄ±!","error")}}async function loadProfile(){if(!currentUser)return;const e=document.getElementById("profile-card");let n=lastUserData;if(!n){try{const e=await db.ref("users/"+currentUser).once("value");n=e.val()}catch(e){}if(!n)try{const e=await fetch("/api/user/"+currentUser),t=await e.json();t&&!t.error&&(n=t)}catch(e){}}n=n||{balance:0};const t=PROFILE_CUSTOMIZATIONS.colors.find(e=>e.id===n.name_color),a=PROFILE_CUSTOMIZATIONS.backgrounds.find(e=>e.id===n.profile_bg),i=t?`color: ${t.color}; text-shadow: 0 0 15px ${t.color}88;`:"",r=a?a.style:"background: rgba(255,255,255,0.03);";e.style.cssText=`position:static; transform:none; width:100%; text-align:left; transition: all 0.5s ease; ${r}`;const s=n.kick_id||null,o=s?`<img src="https://files.kick.com/images/user/${s}/profile_image/conversion/4ba8e27e-5e0b-4e61-ac65-8aba00d79ea8-fullsize.webp"\n               style="width:80px; height:80px; border-radius:50%; object-fit:cover; border:4px solid rgba(255,255,255,0.1);"\n               onerror="this.onerror=null; this.outerHTML='<div style=\\'width:80px; height:80px; background:var(--primary); color:black; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:2rem; font-weight:800; border:4px solid rgba(255,255,255,0.1);\\'>${currentUser[0].toUpperCase()}</div>';" />`:`<div style="width:80px; height:80px; background:var(--primary); color:black; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:2rem; font-weight:800; border:4px solid rgba(255,255,255,0.1);">\n               ${currentUser[0].toUpperCase()}\n           </div>`;e.innerHTML=`\n            <div style="display:flex; flex-direction:column; gap:25px; padding: 30px;">\n                <div style="display:flex; align-items:center; gap:20px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:20px;">\n                    <div id="p-avatar">\n                        ${o}\n                    </div>\n                    <div>\n                        <h2 style="${i} font-size:2rem; margin:0;">${currentUser.toUpperCase()}</h2>\n                        <span style="background:rgba(255,255,255,0.1); padding:2px 10px; border-radius:20px; font-size:0.8rem; color:#ccc;">${n.job||"Ä°ÅŸsiz"}</span>\n                    </div>\n                </div>\n\n                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">\n                    <div class="stat-box" style="background:rgba(0,0,0,0.3);">\n                        <label>CÃ¼zdan</label>\n                        <div class="val">${n.is_infinite?"Omega'nÄ±n KartÄ± ğŸ’³â™¾ï¸":n.balance.toLocaleString()+" ğŸ’°"}</div>\n                    </div>\n                    <div class="stat-box" style="background:rgba(0,0,0,0.3);">\n                        <label>EÄŸitim</label>\n                        <div class="val">${EDUCATION[n.edu||0]}</div>\n                    </div>\n                    <div class="stat-box" style="background:rgba(0,0,0,0.3);">\n                        <label>SÄ±ralama</label>\n                        <div class="val">#--</div>\n                    </div>\n                    <div class="stat-box" style="background:rgba(0,0,0,0.3);">\n                        <label>Durum</label>\n                        <div class="val">${(()=>{const e="omegacyr"===currentUser.toLowerCase(),t=n.is_admin||e,a=n.badges||[],i=n.roles||[],r=e||a.some(e=>{const n="string"==typeof e?e:e.type||e.badge_type||"";return["subscriber","founder","vip","sub_gifter","og","moderator","broadcaster","abone"].includes(n.toLowerCase())})||i.some(e=>["subscriber","moderator","broadcaster","vip"].includes(e.toLowerCase()))||!0===n.is_subscriber||!0===n.isSubscriber;return t&&r?"ğŸ’ğŸ›¡ï¸ YÃ¶netici":t?"ğŸ›¡ï¸ YÃ¶netici":r?"ğŸ’ Abone":"ğŸ‘¤ TakipÃ§i"})()}</div>\n                    </div>\n                </div>\n\n                <div class="xp-section" style="background:rgba(255,255,255,0.03); padding:20px; border-radius:12px; border:1px solid var(--glass-border);">\n                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:600;">\n                        <span>EÄŸitim XP</span>\n                        <span style="color:var(--primary);">${n.xp||0} / ${EDU_XP[(n.edu||0)+1]||"MAX"}</span>\n                    </div>\n                    <div class="progress-bar" style="height:12px; background:#1a1a1a;">\n                        <div class="progress-fill" style="width: ${Math.min(100,(n.xp||0)/(EDU_XP[(n.edu||0)+1]||n.xp||1)*100)}%;"></div>\n                    </div>\n                    <p style="font-size:0.75rem; color:#666; margin-top:8px;">\n                        Mesaj yazarak ve !Ã§alÄ±ÅŸ komutunu kullanarak XP kazanabilir, diplomanÄ± yÃ¼kseltebilirsin.\n                    </p>\n                </div>\n                \n                <div class="stats-section">\n                    <h3 style="margin-bottom:15px; font-size:1rem; opacity:0.8;">ğŸ“ˆ Ä°statistikler</h3>\n                    <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:15px; margin-bottom:15px;">\n                        <div class="stat-mini" style="border:1px solid #05ea6a33; background:rgba(5, 234, 106, 0.05);">\n                            <label style="color:var(--primary);">GÃ¼nlÃ¼k Ä°zleme</label>\n                            <div class="v" style="color:var(--primary);">${n.quests?.[getTodayKey()]?.w||0} dk</div>\n                        </div>\n                        <div class="stat-mini" style="background:rgba(5, 234, 106, 0.1);">\n                            <label>Kanal Ä°zleme</label>\n                            <div class="v">${n.channel_watch_time?.[currentChannelId]||0} dk</div>\n                        </div>\n                        <div class="stat-mini">\n                            <label>Toplam Ä°zleme</label>\n                            <div class="v">${n.lifetime_w||0} dk</div>\n                        </div>\n                        <div class="stat-mini">\n                            <label>Toplam Mesaj</label>\n                            <div class="v">${n.lifetime_m||0}</div>\n                        </div>\n                        <div class="stat-mini">\n                            <label>Toplam Kumar</label>\n                            <div class="v">${n.lifetime_g||0}</div>\n                        </div>\n                        <div class="stat-mini">\n                            <label>DÃ¼ello Galibiyet</label>\n                            <div class="v">${n.lifetime_d||0}</div>\n                        </div>\n                    </div>\n                </div>\n\n                <div class="portfolio-section" style="margin-top:20px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">\n                    <h3 style="margin-bottom:15px; font-size:1rem; opacity:0.8;">ğŸ“‚ Borsa PortfÃ¶yÃ¼m</h3>\n                    <div id="user-portfolio" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:10px;">\n                        ${n.stocks&&Object.keys(n.stocks).length>0?Object.entries(n.stocks).map(([e,t])=>{const a=n.stock_costs&&n.stock_costs[e]||0,i=t>0?a/t:0;return`\n                        <div class="stat-mini" style="border:1px solid #05ea6a33; background:rgba(5, 234, 106, 0.05); display:block;">\n                            <div style="display:flex; justify-content:space-between; align-items:center;">\n                                <label style="margin:0;">${e}</label>\n                                <span style="font-size:0.7rem; color:#aaa;">Ort: ${i>0?Math.floor(i).toLocaleString():"?"} ğŸ’°</span>\n                            </div>\n                            <div class="v" style="margin-top:5px;">${Number(t).toLocaleString("tr-TR",{maximumFractionDigits:4})} Adet</div>\n                        </div>\n                    `}).join(""):'<p style="grid-column: span 2; font-size: 0.8rem; color:#666;">HenÃ¼z hissedar deÄŸilsin.</p>'}\n                    </div>\n                </div>\n\n                <div class="emlak-portfolio-section" style="margin-top:20px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">\n                    <h3 style="margin-bottom:15px; font-size:1rem; opacity:0.8;">ğŸ  Emlak PortfÃ¶yÃ¼m</h3>\n                    <div id="user-emlak" style="display:grid; grid-template-columns: 1fr; gap:10px;">\n                        ${n.properties&&n.properties.length>0?n.properties.map(e=>{const n={residence:"house",shop:"shop",land:"seedling"}[e.category]||"building",t=Math.floor(e.income/24);return`\n                                <div class="stat-mini" style="border:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.03); display:flex; justify-content:space-between; align-items:center;">\n                                    <div style="display:flex; gap:10px; align-items:center;">\n                                        <div style="width:35px; height:35px; background:rgba(255,255,255,0.05); border-radius:8px; display:flex; align-items:center; justify-content:center; color:var(--primary);">\n                                            <i class="fas fa-${n}"></i>\n                                        </div>\n                                        <div>\n                                            <label>${e.city||"Emlak"}</label>\n                                            <div class="v" style="font-size:0.85rem;">${e.name}</div>\n                                        </div>\n                                    </div>\n                                    <div style="text-align:right;">\n                                        <div style="color:var(--primary); font-weight:800; font-size:0.8rem;">+${t.toLocaleString()} ğŸ’°/sa</div>\n                                        <div style="font-size:0.65rem; color:#666;">GÃ¼nlÃ¼k: ${e.income.toLocaleString()}</div>\n                                    </div>\n                                </div>\n                            `}).join(""):'<p style="font-size: 0.8rem; color:#666;">HenÃ¼z mÃ¼lk sahibi deÄŸilsin.</p>'}\n                </div>\n\n                <div class="gang-section" style="margin-top:20px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">\n                    <h3 style="margin-bottom:15px; font-size:1rem; opacity:0.8;">ğŸ´ Ã‡ete</h3>\n                    ${n.gang?'<div class="stat-mini" style="background:rgba(255, 0, 0, 0.1); border:1px solid rgba(255, 0, 0, 0.3); display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="switchTab(\'gangs\')">\n                            <div>\n                                <label>Ãœyesin</label>\n                                <div class="v" style="color:#e74c3c;">Ã‡eteye Git ></div>\n                            </div>\n                        </div>':'<div class="stat-mini" style="background:rgba(255,255,255,0.05); display:flex; justify-content:space-between; align-items:center;">\n                            <label>Bir Ã§eteye Ã¼ye deÄŸilsin.</label>\n                            <button class="secondary-btn" style="font-size:0.7rem; padding:4px 10px;" onclick="switchTab(\'gangs\')">Ã‡ete Kur/Bul</button>\n                        </div>'}\n                </div>\n            </div>\n        `}async function loadGangs(){const e=document.getElementById("gang-lobby"),n=document.getElementById("gang-dashboard");if(!currentUser)return e.classList.remove("hidden"),n.classList.add("hidden"),void(document.getElementById("public-gang-list").innerHTML='<div style="color:var(--primary); text-align:center; padding:20px;">Ã‡eteleri gÃ¶rmek ve katÄ±lmak iÃ§in giriÅŸ yapmalÄ±sÄ±n.</div>');await ensureCities();let t=lastUserData;if(!t)try{t=(await db.ref("users/"+currentUser).once("value")).val(),lastUserData=t}catch(e){console.error("Gangs: User data fetch failed",e)}const a=t?.gang;if(console.log("Gangs Login Check:",{currentUser:currentUser,gangId:a,hasUserData:!!t}),a){document.getElementById("gang-lobby").classList.add("hidden"),document.getElementById("gang-dashboard").classList.remove("hidden");try{const e=await fetch("/api/gang/list"),n=await e.json(),t=document.getElementById("public-gang-list-dashboard");if(t&&n.success){t.innerHTML="";const e=Object.values(n.gangs||{});0===e.length?t.innerHTML='<div style="color:#666; text-align:center; padding:20px;">BaÅŸka Ã§ete bulunamadÄ±.</div>':e.forEach(e=>{if(e.id===a)return;const n=document.createElement("div");n.className="gang-card",n.style="padding:15px 20px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; background:rgba(255,255,255,0.02);";const i=EMLAK_CITIES.find(n=>n.id===e.baseCity)?.name||e.baseCity,r=e.level||1;n.innerHTML=`\n                            <div style="text-align:left;">\n                                <div style="font-weight:800; color:white; font-size:0.95rem; display:flex; align-items:center; gap:8px;">\n                                    <span style="background:rgba(255,255,255,0.1); color:rgba(255,255,255,0.7); padding:2px 6px; border-radius:4px; font-size:0.7rem;">${e.tag}</span>\n                                    ${e.name}\n                                </div>\n                                <div style="font-size:0.75rem; color:#666; margin-top:5px; display:flex; gap:10px;">\n                                    <span>ğŸ“ ${i}</span>\n                                    <span>â­ Lvl ${r}</span>\n                                    <span>ğŸ‘‘ ${e.leader}</span>\n                                </div>\n                            </div>\n                            <div style="font-size:0.85rem; color:var(--primary); font-weight:800; background:rgba(5,234,106,0.05); padding:5px 12px; border-radius:20px;">\n                                <i class="fas fa-users" style="font-size:0.7rem;"></i> ${e.memberCount}\n                            </div>\n                        `,t.appendChild(n)})}}catch(e){console.error("Dashboard Gang List Error",e)}try{const e=await fetch("/api/gang/info",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({gangId:a})}),n=await e.json();if(n.success&&n.gang){const e=n.gang;document.getElementById("my-gang-name").innerText=e.name,document.getElementById("my-gang-tag").innerText=e.tag,document.getElementById("my-gang-leader").innerText=e.leader,document.getElementById("my-gang-balance").innerText=(e.balance||0).toLocaleString()+" ğŸ’°";const t=document.getElementById("gang-requests-section"),i=document.getElementById("gang-requests-list"),r=currentUser.toLowerCase(),s=e.members[r]?.rank;if("leader"===s||"officer"===s){t.classList.remove("hidden"),i.innerHTML="";const n=Object.keys(e.requests||{});0===n.length?i.innerHTML='<div style="color:#666; font-size:0.8rem;">Bekleyen istek yok.</div>':n.forEach(e=>{const n=document.createElement("div");n.className="member-row",n.innerHTML=`\n                                <span><i class="fas fa-user-clock"></i> @${e}</span>\n                                <div style="display:flex; gap:5px;">\n                                    <button onclick="processGangRequest('${e}', 'approve', '${a}')" class="primary-btn" style="width:auto; padding:5px 10px; font-size:0.7rem; background:#05ea6a; color:black;">ONAYLA</button>\n                                    <button onclick="processGangRequest('${e}', 'reject', '${a}')" class="logout-btn" style="width:auto; padding:5px 10px; font-size:0.7rem;">REDDET</button>\n                                </div>\n                            `,i.appendChild(n)})}else t.classList.add("hidden");if(e.baseCity){const n=EMLAK_CITIES.find(n=>n.id===e.baseCity)?.name||e.baseCity;let t=document.getElementById("gang-info-extra");if(!t){const e=document.querySelector("#gang-dashboard .gang-header > div:first-child");t=document.createElement("p"),t.id="gang-info-extra",t.style="color:#aaa; margin-top:5px; font-size:0.8rem;",e.appendChild(t)}t.innerText=`Ãœs: ${n}`}const o=document.getElementById("gang-members-list");if(!o)return;o.innerHTML="";let d=[];try{d=Object.entries(e.members||{})}catch(e){console.error("Members parse error",e),d=[]}const c=d.length,l={1:10,2:20,3:40,4:75,5:150}[e.level||1]||10,u=document.getElementById("my-gang-count");if(u&&(u.innerText=`${c}/${l}`),0===c)o.innerHTML='<div style="color:#666; font-size:0.8rem; text-align:center; padding:20px;">Kadro verisi yÃ¼klenemedi.</div>';else{d.sort((e,n)=>("leader"===n[1].rank?1:0)-("leader"===e[1].rank?1:0)),d.forEach(([e,n])=>{const t="leader"===n.rank,i="officer"===n.rank;let d="TetikÃ§i (Ãœye)",c="ğŸ”«";t?(d="Lider (Baba)",c="ğŸ‘‘"):i&&(d="SaÄŸ Kol (Officer)",c="âš”ï¸");const l=document.createElement("div");l.className="member-row";let u='<div style="display:flex; gap:8px;">';"leader"===s&&e.toLowerCase()!==r&&(u+=`<button onclick="promoteMember('${e}', '${i?"member":"officer"}', '${a}')" class="primary-btn" style="width:auto; padding:3px 8px; font-size:0.65rem; background:rgba(255,255,255,0.1); color:white; border:1px solid rgba(255,255,255,0.2);">${i?"RÃ¼tbe Ä°ndir":"SaÄŸ Kol Yap"}</button>`),("leader"===s&&e.toLowerCase()!==r||"officer"===s&&!t&&!i)&&(u+=`<button onclick="kickMember('${e}', '${a}')" class="logout-btn" style="width:auto; padding:3px 8px; font-size:0.65rem; border:1px solid rgba(255,50,50,0.3);">AT</button>`),u+="</div>",l.innerHTML=`\n                            <div style="display:flex; align-items:center; gap:10px;">\n                                <span style="font-size:1.2rem;">${c}</span>\n                                <div style="text-align:left;">\n                                    <div style="font-weight:700; color:white;">@${e}</div>\n                                    <div style="font-size:0.7rem; color:#888;">${d}</div>\n                                </div>\n                            </div>\n                            ${u}\n                        `,o.appendChild(l)});const n=e.level||1,t=e.balance||0,i={1:1e6,2:5e6,3:25e6,4:1e8}[n],c=n+1,l=document.getElementById("gang-info-extra");if(l){const a=EMLAK_CITIES.find(n=>n.id===e.baseCity)?.name||e.baseCity;l.innerHTML=`\n                            Ãœs: <b>${a}</b> | Seviye: <b>${n}</b> | Kasa: <b style="color:var(--primary);">${t.toLocaleString()} ğŸ’°</b>\n                        `}const u=document.getElementById("gang-top-actions");if(u){u.innerHTML="";const e=document.createElement("button");if(e.className="primary-btn",e.style="flex:1;",e.innerHTML="ğŸ’° KASAYA BAÄIÅ YAP",e.onclick=()=>depositGang(a),u.appendChild(e),"leader"===s&&i){const e=document.createElement("button");e.className="primary-btn",e.style="flex:1; background: linear-gradient(45deg, #ffd700, #ff8c00); color:black; font-weight:800; border:none;",e.innerHTML=`<i class="fas fa-arrow-up"></i> YÃœKSELT (${(i/1e6).toLocaleString()}M)`,e.onclick=()=>upgradeGang(a,i,c),u.appendChild(e)}else if("leader"===s&&!i){const e=document.createElement("button");e.className="secondary-btn",e.style="flex:1;",e.innerHTML="MAX SEVÄ°YE",e.disabled=!0,u.appendChild(e)}const n=document.createElement("button");n.className="logout-btn",n.style="flex:0.3; height: 50px;",n.innerText="AyrÄ±l",n.onclick=()=>leaveGang(),u.appendChild(n)}o.parentNode.querySelectorAll(".gang-extras").forEach(e=>e.remove()),loadGangChat(a,s)}}else console.error("Gang load failed:",n.error),showToast("Ã‡ete bilgileri alÄ±namadÄ±!","error")}catch(e){console.error("Gang Info Fetch Error:",e),showToast("BaÄŸlantÄ± hatasÄ±!","error")}}else{e.classList.remove("hidden"),n.classList.add("hidden");const t=document.getElementById("gang-city-input");t&&t.options.length<=1&&EMLAK_CITIES.sort((e,n)=>e.name.localeCompare(n.name)).forEach(e=>{const n=document.createElement("option");n.value=e.id,n.innerText=e.name,t.appendChild(n)});try{const e=await fetch("/api/gang/list"),n=await e.json(),t=document.getElementById("public-gang-list");if(t&&n.success){t.innerHTML="";const e=Object.values(n.gangs||{});0===e.length?t.innerHTML='<div style="color:#666; text-align:center; padding:20px;">HenÃ¼z kurulmuÅŸ Ã§ete yok.</div>':e.forEach(e=>{const n=document.createElement("div");n.className="gang-card",n.style="margin-bottom:15px; padding:20px; display:flex; justify-content:space-between; align-items:center; position:relative; overflow:hidden;";const a=Object.keys(e.members||{}).length,i=EMLAK_CITIES.find(n=>n.id===e.baseCity)?.name||e.baseCity,r=e.level||1,s={1:10,2:20,3:40,4:75,5:150}[r]||10;n.innerHTML=`\n                            <div style="position:absolute; top:-10px; right:-10px; font-size:4rem; opacity:0.03; font-weight:900; pointer-events:none; font-style:italic;">${e.tag}</div>\n                            <div style="text-align:left; position:relative; z-index:1;">\n                                <div style="font-weight:900; color:white; font-size: 1.1rem; display:flex; align-items:center; gap:10px;">\n                                    <span style="background:var(--primary); color:black; padding:3px 10px; border-radius:6px; font-size:0.8rem; font-weight:900; box-shadow:0 0 10px var(--primary-dim);">${e.tag}</span>\n                                    ${e.name}\n                                </div>\n                                <div style="font-size:0.8rem; color:#aaa; margin-top:10px; display:flex; gap:15px; align-items:center;">\n                                    <span title="Ãœs Åehri"><i class="fas fa-map-marker-alt" style="color:var(--primary);"></i> ${i}</span>\n                                    <span title="Lider"><i class="fas fa-crown" style="color:#ffd700;"></i> ${e.leader}</span>\n                                    <span title="Seviye"><i class="fas fa-star" style="color:#5dade2;"></i> Seviye ${r}</span>\n                                    <span title="Ãœye SayÄ±sÄ±"><i class="fas fa-users" style="color:#aaa;"></i> ${a}/${s} Ãœye</span>\n                                </div>\n                            </div>\n                            <button onclick="joinGang('${e.id}')" class="primary-btn" style="width:auto; padding:10px 25px; font-size:0.85rem; border-radius:30px; position:relative; z-index:1; border:none; box-shadow: 0 4px 15px rgba(5,234,106,0.3);">\n                                <i class="fas fa-user-plus"></i> KATIL\n                            </button>\n                        `,t.appendChild(n)})}}catch(e){console.error("Public Gang List Error",e)}}}async function createGang(){const e=document.getElementById("gang-name-input").value.trim(),n=document.getElementById("gang-tag-input").value.trim(),t=document.getElementById("gang-city-input").value;if(!e||!n||!t)return showToast("Ad, etiket ve ÅŸehir zorunlu!","error");n.toUpperCase(),showToast("Ã‡ete kuruluyor...","info");try{const a=await fetch("/api/gang/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser,name:e,tag:n,baseCity:t})}),i=await a.json();if(i.success){showToast("ğŸ´ Ã‡ete baÅŸarÄ±yla kuruldu!","success");const e=await fetch("/api/user/"+currentUser);lastUserData=await e.json(),loadGangs(),lastUserData.is_infinite?document.getElementById("user-balance").innerText="Omega'nÄ±n KartÄ± ğŸ’³â™¾ï¸":document.getElementById("user-balance").innerText=lastUserData.balance.toLocaleString()+" ğŸ’°"}else showToast(i.error||"Hata oluÅŸtu!","error")}catch(e){showToast("Sunucu hatasÄ±!","error")}}async function leaveGang(){const e="leader"===lastUserData?.gangRank?"Ã‡ete Liderisin! AyrÄ±lÄ±rsan Ã§ete tamamen feshedilecek (disband). Emin misin?":"Ã‡eteden ayrÄ±lmak istediÄŸine emin misin?";if(await showConfirm("AyrÄ±lma OnayÄ±",e))try{const e=await fetch("/api/gang/leave",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser})}),n=await e.json();if(n.success){showToast(n.message,"success");const e=await fetch("/api/user/"+currentUser);lastUserData=await e.json(),loadGangs()}else showToast(n.error||"Hata!","error")}catch(e){showToast("BaÄŸlantÄ± hatasÄ±!","error")}}async function joinGang(e){if(!currentUser)return showToast("LÃ¼tfen giriÅŸ yapÄ±n!","error");showToast("Ã‡eteye katÄ±lÄ±nÄ±yor...","info");try{const n=await fetch("/api/gang/join",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser,gangId:e})}),t=await n.json();if(t.success){showToast("ğŸ´ Ã‡eteye baÅŸarÄ±yla katÄ±ldÄ±n!","success");const e=await fetch("/api/user/"+currentUser);lastUserData=await e.json(),loadGangs()}else showToast(t.error||"Hata oluÅŸtu!","error")}catch(e){showToast("BaÄŸlantÄ± hatasÄ±!","error")}}async function processGangRequest(e,n,t){console.log(`ğŸ”„ Gang Request: ${n} for ${e} in ${t} by ${currentUser}`);try{const a=await fetch("/api/gang/process-request",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({requester:currentUser,targetUser:e,action:n,gangId:t})}),i=await a.json();console.log("ğŸ“© Gang Request Response:",i),i.success?(showToast(i.message,"success"),setTimeout(()=>loadGangs(),500)):showToast(i.error||"Hata!","error")}catch(e){console.error("âŒ Gang Request Error:",e),showToast("Ä°ÅŸlem hatasÄ±: "+e.message,"error")}}async function promoteMember(e,n,t){try{const a=await fetch("/api/gang/promote",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({requester:currentUser,targetUser:e,newRank:n,gangId:t})}),i=await a.json();i.success?(showToast(i.message,"success"),loadGangs()):showToast(i.error||"Hata!","error")}catch(e){showToast("BaÄŸlantÄ± hatasÄ±!","error")}}async function kickMember(e,n){if(await showConfirm("ğŸ‘¢ Ãœye At",`${e} kullanÄ±cÄ±sÄ±nÄ± Ã§eteden atmak istediÄŸine emin misin?`))try{const t=await fetch("/api/gang/kick",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({requester:currentUser,target:e,gangId:n})}),a=await t.json();a.success?(showToast(a.message,"success"),loadGangs()):showToast(a.error||"Hata!","error")}catch(e){showToast("BaÄŸlantÄ± hatasÄ±!","error")}}async function buyMarketListing(e,n,t,a,i,r){showInput(`ğŸ“¦ ÃœrÃ¼n SatÄ±n Al: ${i}`,`KaÃ§ ${r} satÄ±n almak istiyorsun? (Maks: ${a.toLocaleString()})`,"1",async n=>{const t=parseInt(n);if(isNaN(t)||t<=0||t>a)return showToast("GeÃ§ersiz miktar!","error");try{const n=await fetch("/api/marketplace/buy-listing",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser,listingId:e,targetCity:userProfile.city||"Ä°stanbul",buyQty:t})}),a=await n.json();a.success?(showToast(a.message,"success"),loadMarketListings(),loadProfile()):showToast(a.error,"error")}catch(e){showToast("Ä°ÅŸlem sÄ±rasÄ±nda bir hata oluÅŸtu!","error")}})}function openDonateModal(){document.getElementById("gang-donate-modal").classList.remove("hidden"),document.getElementById("gang-donate-input").value=""}function closeGangDonateModal(){document.getElementById("gang-donate-modal").classList.add("hidden")}async function confirmGangDonate(){const e=parseInt(document.getElementById("gang-donate-input").value);if(!e||e<=0)return showToast("GeÃ§erli bir miktar girin!","error");closeGangDonateModal(),showToast("BaÄŸÄ±ÅŸ iÅŸleniyor...","info");try{const n=await fetch("/api/gang/donate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser,amount:e})}),t=await n.json();t.success?(showToast(`ğŸ’ Ã‡ete kasasÄ±na ${e.toLocaleString()} ğŸ’° baÄŸÄ±ÅŸladÄ±n!`,"success"),loadGangs()):showToast(t.error||"Hata!","error")}catch(e){showToast("BaÄŸlantÄ± hatasÄ±!","error")}}async function openDonateModal_OLD(){const e=prompt("Ne kadar baÄŸÄ±ÅŸlamak istersin?");if(e)try{const n=await fetch("/api/gang/donate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser,amount:e})}),t=await n.json();t.success?(showToast("âœ… BaÄŸÄ±ÅŸ yapÄ±ldÄ±!","success"),lastUserData?.is_infinite||(document.getElementById("user-balance").innerText=t.newBalance.toLocaleString()+" ğŸ’°"),loadGangs()):showToast(t.error,"error")}catch(e){showToast("BaÄŸÄ±ÅŸ hatasÄ±","error")}}const EMLAK_CITIES=[{id:"ADANA",name:"Adana",x:50,y:81},{id:"ADIYAMAN",name:"AdÄ±yaman",x:66,y:72},{id:"AFYONKARAHISAR",name:"Afyon",x:25,y:53},{id:"AGRI",name:"AÄŸrÄ±",x:91,y:38},{id:"AMASYA",name:"Amasya",x:53,y:23},{id:"ANKARA",name:"Ankara",x:38,y:34},{id:"ANTALYA",name:"Antalya",x:26,y:83},{id:"ARTVIN",name:"Artvin",x:84,y:15},{id:"AYDIN",name:"AydÄ±n",x:11,y:68},{id:"BALIKESIR",name:"BalÄ±kesir",x:12,y:39},{id:"BILECIK",name:"Bilecik",x:23,y:31},{id:"BINGOL",name:"BingÃ¶l",x:77,y:51},{id:"BITLIS",name:"Bitlis",x:86,y:59},{id:"BOLU",name:"Bolu",x:31,y:22},{id:"BURDUR",name:"Burdur",x:24,y:70},{id:"BURSA",name:"Bursa",x:18,y:30},{id:"CANAKKALE",name:"Ã‡anakkale",x:4,y:31},{id:"CANKIRI",name:"Ã‡ankÄ±rÄ±",x:42,y:24},{id:"CORUM",name:"Ã‡orum",x:49,y:25},{id:"DENIZLI",name:"Denizli",x:18,y:69},{id:"DIYARBAKIR",name:"DiyarbakÄ±r",x:76,y:66},{id:"EDIRNE",name:"Edirne",x:5,y:7},{id:"ELAZIG",name:"ElazÄ±ÄŸ",x:71,y:54},{id:"ERZINCAN",name:"Erzincan",x:72,y:37},{id:"ERZURUM",name:"Erzurum",x:81,y:35},{id:"ESKISEHIR",name:"EskiÅŸehir",x:25,y:37},{id:"GAZIANTEP",name:"Gaziantep",x:61,y:80},{id:"GIRESUN",name:"Giresun",x:66,y:19},{id:"GUMUSHANE",name:"GÃ¼mÃ¼ÅŸhane",x:72,y:26},{id:"HAKKARI",name:"Hakkari",x:94,y:72},{id:"HATAY",name:"Hatay",x:55,y:94},{id:"ISPARTA",name:"Isparta",x:26,y:69},{id:"MERSIN",name:"Mersin",x:47,y:84},{id:"ISTANBUL",name:"Ä°stanbul",x:17,y:17},{id:"IZMIR",name:"Ä°zmir",x:8,y:58},{id:"KARS",name:"Kars",x:91,y:24},{id:"KASTAMONU",name:"Kastamonu",x:42,y:12},{id:"KAYSERI",name:"Kayseri",x:52,y:48},{id:"KIRKLARELI",name:"KÄ±rklareli",x:8,y:6},{id:"KIRSEHIR",name:"KÄ±rÅŸehir",x:44,y:47},{id:"KOCAELI",name:"Kocaeli",x:22,y:21},{id:"KONYA",name:"Konya",x:36,y:67},{id:"KUTAHYA",name:"KÃ¼tahya",x:23,y:43},{id:"MALATYA",name:"Malatya",x:66,y:60},{id:"MANISA",name:"Manisa",x:9,y:55},{id:"KAHRAMANMARAS",name:"KahramanmaraÅŸ",x:59,y:72},{id:"MARDIN",name:"Mardin",x:79,y:76},{id:"MUGLA",name:"MuÄŸla",x:14,y:78},{id:"MUS",name:"MuÅŸ",x:83,y:54},{id:"NEVSEHIR",name:"NevÅŸehir",x:47,y:55},{id:"NIGDE",name:"NiÄŸde",x:47,y:66},{id:"ORDU",name:"Ordu",x:64,y:18},{id:"RIZE",name:"Rize",x:78,y:17},{id:"SAKARYA",name:"Sakarya",x:25,y:21},{id:"SAMSUN",name:"Samsun",x:56,y:13},{id:"SIIRT",name:"Siirt",x:85,y:66},{id:"SINOP",name:"Sinop",x:50,y:1},{id:"SIVAS",name:"Sivas",x:59,y:37},{id:"TEKIRDAG",name:"TekirdaÄŸ",x:10,y:18},{id:"TOKAT",name:"Tokat",x:57,y:28},{id:"TRABZON",name:"Trabzon",x:73,y:17},{id:"TUNCELI",name:"Tunceli",x:72,y:48},{id:"SANLIURFA",name:"ÅanlÄ±urfa",x:69,y:78},{id:"USAK",name:"UÅŸak",x:20,y:54},{id:"VAN",name:"Van",x:92,y:57},{id:"YOZGAT",name:"Yozgat",x:48,y:36},{id:"ZONGULDAK",name:"Zonguldak",x:32,y:10},{id:"AKSARAY",name:"Aksaray",x:44,y:59},{id:"BAYBURT",name:"Bayburt",x:76,y:29},{id:"KARAMAN",name:"Karaman",x:39,y:78},{id:"KIRIKKALE",name:"KÄ±rÄ±kkale",x:41,y:36},{id:"BATMAN",name:"Batman",x:81,y:67},{id:"SIRNAK",name:"ÅÄ±rnak",x:88,y:73},{id:"BARTIN",name:"BartÄ±n",x:35,y:7},{id:"ARDAHAN",name:"Ardahan",x:89,y:16},{id:"IGDIR",name:"IÄŸdÄ±r",x:96,y:35},{id:"YALOVA",name:"Yalova",x:19,y:23},{id:"KARABUK",name:"KarabÃ¼k",x:36,y:14},{id:"KILIS",name:"Kilis",x:60,y:86},{id:"OSMANIYE",name:"Osmaniye",x:55,y:80},{id:"DUZCE",name:"DÃ¼zce",x:29,y:20}];async function ensureCities(){return!0}let emlakActive=!1;async function loadEmlak(){if(!emlakActive){if(emlakActive=!0,await ensureCities(),"omegacyr"===currentUser){const e=document.getElementById("tab-emlak"),n=document.createElement("button");n.innerHTML="ğŸš¨ EMLAK SÄ°STEMÄ°NÄ° SIFIRLA (ADMÄ°N)",n.className="primary-btn",n.style="background: #ff4d4d; color: white; margin-bottom: 20px; width: auto; padding: 10px 25px;",n.onclick=async()=>{if(!await showConfirm("ğŸš¨ Emlak SÄ±fÄ±rlama","TÃ¼m ÅŸehirlerdeki mÃ¼lkleri ve tÃ¼m kullanÄ±cÄ±larÄ±n tapularÄ±nÄ± silmek istediÄŸine emin misin? (FiyatlarÄ± gÃ¼ncellemek iÃ§in gereklidir)"))return;const e=await fetch("/api/emlak/reset",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({requester:"omegacyr"})}),n=await e.json();n.success?(showToast(n.message,"success"),setTimeout(()=>location.reload(),1500)):showToast(n.error||"Hata oluÅŸtu","error")},e.insertBefore(n,e.firstChild)}renderEmlakMap()}}async function loadCareer(){if(!currentUser)return;const e=document.getElementById("career-grid");e.innerHTML='<div class="loader"></div>';let n=lastUserData;if(!n){try{const e=await db.ref("users/"+currentUser).once("value");n=e.val()}catch(e){console.log("Career DB Error",e)}if(!n)try{const e=await fetch("/api/user/"+currentUser),t=await e.json();t&&!t.error&&(n=t,lastUserData||updateUserUI(n))}catch(e){console.log("Career API Error",e)}}n=n||{};const t=n.edu||0,a=n.job||"Ä°ÅŸsiz";e.innerHTML="",Object.entries(JOBS).forEach(([i,r])=>{if("Ä°ÅŸsiz"===i)return;const s=t>=r.req_edu,o=n.items&&n.items[r.req_item],d=a===i,c=document.createElement("div");c.className="market-card "+(d?"active-job":""),c.style.opacity=s?"1":"0.5",c.innerHTML=`\n            <div class="item-icon">${r.icon}</div>\n            <div class="item-info">\n                <h3>${i}</h3>\n                <p>MaaÅŸ: <span class="item-cost">${r.reward.toLocaleString()} ğŸ’°</span> / GÃ¼nlÃ¼k</p>\n                <div style="font-size:0.8rem; margin-top:5px; color:#aaa;">\n                    ğŸ“ ${EDUCATION[r.req_edu]}<br>\n                    ğŸ“¦ ${r.req_item}\n                </div>\n            </div>\n            <button class="buy-btn" onclick="applyForJob('${i}', ${r.price||0})" \n                ${d?"disabled":""}>\n                ${d?"Zaten Bu Ä°ÅŸteler":o?"Hemen BaÅŸla":`${(r.price||0).toLocaleString()} ğŸ’° Al`}\n            </button>\n        `,e.appendChild(c)})}async function applyForJob(e,n){if(!currentUser)return;const t=JOBS[e];let a=await getUserData();if(a=a||{balance:0,items:{}},(a.edu||0)<t.req_edu)return showToast(`EÄŸitim seviyen yetersiz! (${EDUCATION[t.req_edu]} gereklidir)`,"error");if(!a.items||!a.items[t.req_item]){if(!a.is_infinite&&(a.balance||0)<n)return showToast("Bakiye yetersiz! âŒ","error");a.is_infinite?t.req_item:(t.req_item,n.toLocaleString())}try{const n=await fetch("/api/jobs/apply",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("aloskegang_token")}`},body:JSON.stringify({username:currentUser,jobName:e})}),t=await n.json();t.success?(showToast(t.message,"success"),loadCareer(),loadProfile()):showToast(t.error||"Ä°ÅŸlem baÅŸarÄ±sÄ±z.","error")}catch(e){console.error(e),showToast("Sunucu hatasÄ±!","error")}}function renderEmlakMap(){const e=document.getElementById("map-overlay");e&&(e.innerHTML="",EMLAK_CITIES.forEach(n=>{const t=document.createElement("div");t.className="city-dot",t.style.left=`${n.x}%`,t.style.top=`${n.y}%`,t.style.transform="translate(-50%, -50%)",t.addEventListener("mouseenter",()=>{const e=document.getElementById("city-info-toast");e.querySelector("span").innerText=n.name.toUpperCase(),e.style.display="flex"}),t.addEventListener("mouseleave",()=>{document.getElementById("city-info-toast").style.display="none"}),t.addEventListener("click",()=>{document.querySelectorAll(".city-dot").forEach(e=>e.classList.remove("active")),t.classList.add("active"),loadCityProperties(n.id,n.name)}),e.appendChild(t)}))}let currentCityProperties=[],currentLoadedCityId="",currentLoadedCityName="";function filterProperties(e,n){if(n&&(document.querySelectorAll(".filter-btn").forEach(e=>{e.classList.remove("active"),e.style.color="#aaa"}),n.classList.add("active"),n.style.color="#fff"),!currentCityProperties)return;let t=[];t="all"===e?currentCityProperties:currentCityProperties.filter(n=>n.category===e),renderPropertyList(t,currentLoadedCityId,currentLoadedCityName)}function renderPropertyList(e,n,t){const a=document.getElementById("city-properties-list");a&&(a.innerHTML="",a.style.display="grid",a.style.gridTemplateColumns="repeat(auto-fill, minmax(280px, 1fr))",a.style.gap="20px",a.style.padding="10px",e&&0!==e.length?e.forEach((e,i)=>{const r=document.createElement("div");r.className="property-card";let s="#444",o="linear-gradient(135deg, rgba(255,255,255,0.03), rgba(0,0,0,0.5))",d="#aaa",c="MÃœLK";"residence"===e.category?(s="#00E676",d="#69F0AE",c="KONUT",o="linear-gradient(135deg, rgba(0, 230, 118, 0.05), rgba(0,0,0,0.4))"):"shop"===e.category?(s="#2979FF",d="#448AFF",c="DÃœKKAN",o="linear-gradient(135deg, rgba(41, 121, 255, 0.05), rgba(0,0,0,0.4))"):"land"===e.category&&(s="#FFC400",d="#FFD740",c="ARAZÄ°",o="linear-gradient(135deg, rgba(255, 196, 0, 0.05), rgba(0,0,0,0.4))");const l=!!e.owner,u=e.owner&&e.owner.toLowerCase()===currentUser&&(lastUserData?.properties||[]).some(n=>n.id===e.id);r.style.background=u?"linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(0,0,0,0.4))":o,r.style.border=u?"1px solid #FFD700":`1px solid ${s}33`,r.style.boxShadow=u?"0 0 15px rgba(255, 215, 0, 0.1)":"0 4px 6px rgba(0,0,0,0.3)",r.style.borderRadius="16px",r.style.display="flex",r.style.flexDirection="column",r.style.padding="0",r.style.overflow="hidden",r.style.position="relative",r.style.animation=`fadeInUp 0.5s forwards ${.05*i}s`,r.style.opacity="0";let m="";"residence"===e.category&&e.income>0?m=`\n                <div style="margin-top:15px; background:rgba(0,0,0,0.3); padding:10px; border-radius:10px; display:flex; justify-content:space-between; align-items:center;">\n                    <span style="color:#aaa; font-size:0.8rem;">GÃœNLÃœK GELÄ°R</span>\n                    <div style="display:flex; align-items:center; gap:5px;">\n                        <i class="fas fa-arrow-trend-up" style="color:#00ff88; font-size:0.9rem;"></i>\n                        <span style="color:#00ff88; font-weight:700;">+${e.income.toLocaleString()} ğŸ’°</span>\n                    </div>\n                </div>\n            `:"shop"===e.category&&(m='\n                <div style="margin-top:15px; background:rgba(255,255,255,0.03); padding:10px; border-radius:10px; display:flex; align-items:center; justify-content:center; gap:8px;">\n                    <i class="fas fa-briefcase" style="color:#aaa; font-size:0.9rem;"></i>\n                    <span style="color:#888; font-size:0.8rem;">Ä°ÅŸletme Kurulabilir</span>\n                </div>\n            ');let p="";p=u?'\n                <div style="background:#FFD700; color:#000; font-weight:900; padding:12px; text-align:center; font-size:0.9rem; letter-spacing:1px; margin-top:auto;">\n                    <i class="fas fa-check-circle"></i> SÄ°ZÄ°N MÃœLKÃœNÃœZ\n                </div>':l?`\n                <div style="background:#ff3333; color:#fff; font-weight:800; padding:12px; text-align:center; font-size:0.9rem; letter-spacing:1px; margin-top:auto;">\n                    <i class="fas fa-lock"></i> SAHÄ°BÄ°: @${e.owner}\n                </div>`:`\n                <button onclick="executePropertyBuy('${n}', '${e.id}', ${e.price}, '${t}')" \n                    class="buy-btn-anim"\n                    style="\n                        width:100%; padding:14px; background:var(--primary); color:#000; border:none; \n                        font-weight:900; cursor:pointer; font-size:1rem; margin-top:auto;\n                        transition: background 0.2s;\n                    "\n                    onmouseover="this.style.background='#00e676'"\n                    onmouseout="this.style.background='var(--primary)'"\n                >\n                    SATIN AL\n                </button>\n            `,r.innerHTML=`\n            <div style="padding:20px; display:flex; flex-direction:column; gap:10px; height:100%;">\n                \n                <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;">\n                    <div style="display:flex; align-items:center; gap:15px; flex:1;">\n                        <div style="width:50px; height:50px; background:${s}22; border-radius:12px; display:flex; align-items:center; justify-content:center; box-shadow:inset 0 0 10px ${s}11; flex-shrink:0;">\n                            <i class="fa-solid fa-${e.icon||"building"}" style="font-size:1.6rem; color:${d};"></i>\n                        </div>\n                        <div style="flex:1;">\n                            <div style="font-size:1.1rem; font-weight:800; color:#fff; line-height:1.2; margin-bottom:4px; word-break: break-word;">${e.name.replace(t,"").trim()}</div>\n                            <div style="font-size:0.9rem; font-weight:700; color:#fff;">${e.price.toLocaleString()} ğŸ’°</div>\n                        </div>\n                    </div>\n                    <div style="font-size:0.7rem; font-weight:800; color:${s}; background:${s}22; padding:4px 10px; border-radius:6px; letter-spacing:0.5px; white-space:nowrap;">\n                        ${c}\n                    </div>\n                </div>\n\n                ${m}\n\n                <div style="flex:1;"></div> \x3c!-- Spacer --\x3e\n            </div>\n            ${p}\n        `,a.appendChild(r)}):a.innerHTML='\n            <div style="grid-column: 1 / -1; text-align:center; padding:40px; color:#666; display:flex; flex-direction:column; align-items:center;">\n                <i class="fas fa-search" style="font-size:2rem; margin-bottom:15px; opacity:0.5;"></i>\n                <p>Bu kategoride mÃ¼lk bulunamadÄ±.</p>\n            </div>\n        ')}async function loadCityProperties(e,n){const t=document.getElementById("city-properties-list");if(!t)return;currentLoadedCityId=e,currentLoadedCityName=n;const a=document.getElementById("city-title");a&&(a.innerText=n);const i=document.getElementById("property-filters");i&&(i.style.display="flex"),document.querySelectorAll(".filter-btn").forEach(e=>{e.classList.remove("active"),e.style.color="#aaa"});const r=document.querySelector(".filter-btn:first-child");r&&(r.classList.add("active"),r.style.color="#fff"),t.innerHTML='<div class="loader" style="margin: 20px auto;"></div>';try{const a=await fetch(`/api/real-estate/properties/${e}?_t=${Date.now()}`),i=await a.json();if(currentCityProperties=i||[],!currentCityProperties||0===currentCityProperties.length)return void(t.innerHTML='\n                <div style="text-align:center; padding:30px 10px; background: rgba(255, 0, 0, 0.05); border: 1px dashed rgba(255, 0, 0, 0.3); border-radius: 15px; grid-column: 1 / -1;">\n                    <i class="fas fa-lock" style="font-size: 2.5rem; color: #ff4d4d; margin-bottom: 15px;"></i>\n                    <h4 style="color: white; margin-bottom: 10px;">Veri BulunamadÄ± veya EriÅŸim Engellendi</h4>\n                    <p style="font-size: 0.8rem; color: #aaa; line-height: 1.5;">Sunucudan mÃ¼lk verisi alÄ±namadÄ±.</p>\n                </div>\n            ');renderPropertyList(currentCityProperties,e,n)}catch(e){t.innerHTML=`\n            <div style="text-align:center; padding:20px; color:var(--danger); grid-column: 1 / -1;">\n                <i class="fas fa-exclamation-triangle" style="font-size:2rem; margin-bottom:10px;"></i>\n                <p>Veriler yÃ¼klenemedi!</p>\n                <p style="font-size:0.7rem; color:#888; margin-top:10px;">\n                    Hata: ${e.message}\n                </p>\n            </div>\n        `}}async function executePropertyBuy(e,n,t,a){if(!currentUser)return showToast("GiriÅŸ yapmalÄ±sÄ±n!","error");const i=await getUserData();i?.is_infinite||t.toLocaleString();try{const t=await fetch("/api/real-estate/buy",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("aloskegang_token")}`},body:JSON.stringify({username:currentUser,cityId:e,propertyId:n})}),i=await t.json();i.success?(showToast(i.message,"success"),loadProfile(),loadCityProperties(e,a)):showToast(i.error,"error")}catch(e){showToast("Ä°ÅŸlem sÄ±rasÄ±nda bir hata oluÅŸtu!","error")}}async function loadLiveStats(){const e=document.getElementById("stats-container");if(e)if(currentChannelId){e.innerHTML='<div class="loader"></div>';try{const n=(await db.ref("users").once("value")).val()||{},t=Object.entries(n).map(([e,n])=>({name:e,...n,chan_m:n.channel_m?.[currentChannelId]||0,chan_w:n.channel_watch_time?.[currentChannelId]||0})).filter(e=>{const n=e.name.toLowerCase().replace("@","");return(e.chan_m>0||e.chan_w>0)&&!["aloskegangbot","botrix"].includes(n)});if(0===t.length)return void(e.innerHTML='<p style="text-align:center; padding:40px; color:#666;">Bu kanal iÃ§in henÃ¼z istatistik verisi toplanmamÄ±ÅŸ.</p>');const a=[...t].sort((e,n)=>(n.balance||0)-(e.balance||0)).slice(0,25),i=[...t].sort((e,n)=>n.chan_m-e.chan_m).slice(0,25),r=[...t].sort((e,n)=>n.chan_w-e.chan_w).slice(0,25);e.innerHTML=`\n            <div class="glass-panel" style="padding:20px;">\n                <h3 style="color:var(--primary); margin-bottom:15px; display:flex; align-items:center; gap:10px;">ğŸ† Kanal Zenginleri <small style="font-size:0.6rem; color:#666;">(Global Bakiye)</small></h3>\n                <div style="display:flex; flex-direction:column; gap:10px;">\n                    ${a.map((e,n)=>`\n                        <div style="display:flex; align-items:center; justify-content:space-between; background:rgba(255,255,255,0.03); padding:10px; border-radius:10px;">\n                            <span style="font-weight:700;">${n+1}. ${e.name.toUpperCase()}</span>\n                            <span style="color:var(--primary); font-weight:800;">${e.is_infinite?"ğŸ’³â™¾ï¸":(e.balance||0).toLocaleString()+" ğŸ’°"}</span>\n                        </div>\n                    `).join("")}\n                </div>\n            </div>\n\n            <div class="glass-panel" style="padding:20px;">\n                <h3 style="color:var(--secondary); margin-bottom:15px; display:flex; align-items:center; gap:10px;">ğŸ’¬ En Aktif Chat <small style="font-size:0.6rem; color:#666;">(Bu Kanal)</small></h3>\n                <div style="display:flex; flex-direction:column; gap:10px;">\n                    ${i.map((e,n)=>{const t=i[0].chan_m||1,a=e.chan_m/t*100;return`\n                            <div style="display:flex; flex-direction:column; gap:5px; background:rgba(255,255,255,0.03); padding:10px; border-radius:10px;">\n                                <div style="display:flex; justify-content:space-between; font-size:0.85rem;">\n                                    <span style="font-weight:700;">${n+1}. ${e.name.toUpperCase()}</span>\n                                    <span>${e.chan_m.toLocaleString()} Mesaj</span>\n                                </div>\n                                <div class="progress-bar" style="height:6px; background:rgba(255,255,255,0.05);"><div class="progress-fill" style="width:${a}%; background:var(--secondary);"></div></div>\n                            </div>\n                        `}).join("")}\n                </div>\n            </div>\n\n            <div class="glass-panel" style="padding:20px;">\n                <h3 style="color:#f1c40f; margin-bottom:15px; display:flex; align-items:center; gap:10px;">ğŸ‘ï¸ SadÄ±k Ä°zleyiciler <small style="font-size:0.6rem; color:#666;">(Bu Kanal)</small></h3>\n                <div style="display:flex; flex-direction:column; gap:10px;">\n                    ${r.map((e,n)=>{const t=r[0].chan_w||1,a=e.chan_w/t*100;return`\n                            <div style="display:flex; flex-direction:column; gap:5px; background:rgba(255,255,255,0.03); padding:10px; border-radius:10px;">\n                                <div style="display:flex; justify-content:space-between; font-size:0.85rem;">\n                                    <span style="font-weight:700;">${n+1}. ${e.name.toUpperCase()}</span>\n                                    <span>${e.chan_w.toLocaleString()} dk</span>\n                                </div>\n                                <div class="progress-bar" style="height:6px; background:rgba(255,255,255,0.05);"><div class="progress-fill" style="width:${a}%; background:#f1c40f;"></div></div>\n                            </div>\n                        `}).join("")}\n                </div>\n            </div>\n        `}catch(n){e.innerHTML="<p>Ä°statistikler ÅŸu an yÃ¼klenemiyor.</p>"}}else e.innerHTML='<p style="text-align:center; padding:40px; color:#666;">Kanal istatistiklerini gÃ¶rmek iÃ§in bir kanalda !doÄŸrulama yapmalÄ±sÄ±n.</p>'}async function loadArena(){if(!currentUser)return;document.getElementById("my-rpg-stats").innerHTML='<div class="loader"></div>',document.getElementById("arena-weapons").innerHTML='<div class="loader"></div>',document.getElementById("arena-armors").innerHTML='<div class="loader"></div>';const e=((await db.ref("users/"+currentUser).once("value")).val()||{balance:0}).rpg||{level:1,hp:100,xp:0,str:5,def:0,weapon:"yumruk",armor:"tisort"},n=e.inventory||[],t=RPG_WEAPONS[e.weapon]||RPG_WEAPONS.yumruk,a=RPG_ARMORS[e.armor]||RPG_ARMORS.tisort,i=(e.hp||100)+(a.hp||0),r=(e.str||5)+(t.dmg||0),s=(e.def||0)+(a.def||0);document.getElementById("my-rpg-stats").innerHTML=`\n        <div style="display:flex; justify-content:space-between; align-items:center;">\n            <div>\n                <strong style="color:var(--primary); font-size:1.2rem;">Level ${e.level||1}</strong>\n                <p style="margin-top:5px; font-size:0.9rem;">\n                   â¤ï¸ HP: ${i} | âš”ï¸ STR: ${r} | ğŸ›¡ï¸ DEF: ${s}\n                </p>\n                <p style="font-size:0.8rem; color:#888;">XP: ${e.xp||0}</p>\n            </div>\n            <div style="text-align:right;">\n                <div style="margin-bottom:5px;">${t.icon} ${t.name}</div>\n                <div>${a.icon} ${a.name}</div>\n            </div>\n        </div>\n    `;const o=document.getElementById("arena-weapons");o.innerHTML="",Object.entries(RPG_WEAPONS).forEach(([t,a])=>{if("yumruk"===t)return;const i=n.includes(t)||t===e.weapon,r=t===e.weapon,s=document.createElement("div");s.className="market-card",s.innerHTML=`\n            <div class="item-icon">${a.icon}</div>\n            <div class="item-info">\n                <h3>${a.name}</h3>\n                <p style="color:#aaa;">+${a.dmg} Hasar</p>\n                <div class="item-cost">${a.price.toLocaleString()} ğŸ’°</div>\n            </div>\n            <button class="buy-btn" onclick="buyRpgItem('${t}', 'weapon')" ${r?"disabled":""}>\n                ${r?"KUÅANILDI":i?"KUÅAN":"SATIN AL"}\n            </button>\n        `,o.appendChild(s)});const d=document.getElementById("arena-armors");d.innerHTML="",Object.entries(RPG_ARMORS).forEach(([t,a])=>{if("tisort"===t)return;const i=n.includes(t)||t===e.armor,r=t===e.armor,s=document.createElement("div");s.className="market-card",s.innerHTML=`\n            <div class="item-icon">${a.icon}</div>\n            <div class="item-info">\n                <h3>${a.name}</h3>\n                <p style="color:#aaa;">+${a.def} Defans | +${a.hp} HP</p>\n                <div class="item-cost">${a.price.toLocaleString()} ğŸ’°</div>\n            </div>\n            <button class="buy-btn" onclick="buyRpgItem('${t}', 'armor')" ${r?"disabled":""}>\n                ${r?"KUÅANILDI":i?"KUÅAN":"SATIN AL"}\n            </button>\n        `,d.appendChild(s)})}async function buyRpgItem(e,n){if(!currentUser)return;const t="weapon"===n?RPG_WEAPONS[e]:RPG_ARMORS[e];if(!t)return;await getUserData();t.name;try{const t=await fetch("/api/rpg/buy",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("aloskegang_token")}`},body:JSON.stringify({username:currentUser,type:n,code:e})}),a=await t.json();a.success?(showToast(a.message,"success"),loadArena(),loadProfile()):showToast(a.error||"Ä°ÅŸlem baÅŸarÄ±sÄ±z.","error")}catch(e){console.error(e),showToast("Hata oluÅŸtu.","error")}}async function showCustomizationMarket(){document.querySelectorAll(".tab-content").forEach(e=>e.classList.add("hidden"));const e=document.getElementById("tab-career");e.classList.remove("hidden"),document.querySelectorAll(".tab-btn").forEach(e=>e.classList.remove("active")),document.querySelector("button[onclick=\"switchTab('career')\"]").classList.add("active");const n=e.querySelector("h2"),t=e.querySelector("p");n.innerHTML="âœ¨ Profil Ã–zelleÅŸtirme MaÄŸazasÄ±",t.innerHTML="Ä°smini renklendir ve profiline ÅŸÄ±k arka planlar ekleyerek fark yarat! (AldÄ±ÄŸÄ±n her yenisi eskisinin yerine geÃ§er)";const a=document.getElementById("career-grid");a.innerHTML="";const i=document.createElement("div");i.innerHTML='<button class="primary-btn" style="width: auto; padding: 10px 20px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);">ğŸ”™ Mesleklere Geri DÃ¶n</button>',i.style="grid-column: 1 / -1; margin-bottom: 20px;",i.onclick=()=>{n.innerHTML="ğŸ’¼ Kariyer & Meslekler",t.innerHTML="Ä°ÅŸe baÅŸlamak iÃ§in diploman (eÄŸitim seviyen) yetmeli ve gerekli meslek eÅŸyasÄ±nÄ± satÄ±n almalÄ±sÄ±n.",loadCareer()},a.appendChild(i),PROFILE_CUSTOMIZATIONS.colors.forEach(e=>{const n=document.createElement("div");n.className="market-card",n.innerHTML=`\n            <div class="item-icon" style="color:${e.color}; text-shadow: 0 0 10px ${e.color};">ğŸ¨</div>\n            <div class="item-info">\n                <h3>${e.name}</h3>\n                <p>Ä°sim Rengi</p>\n                <span class="item-cost">${e.price.toLocaleString()} ğŸ’°</span>\n            </div>\n            <button class="buy-btn" onclick="buyCustomization('color', '${e.id}', ${e.price})">SatÄ±n Al</button>\n        `,a.appendChild(n)}),PROFILE_CUSTOMIZATIONS.backgrounds.forEach(e=>{const n=document.createElement("div");n.className="market-card",n.innerHTML=`\n            <div class="item-icon" style="${e.style}; border-radius:10px; width:40px; height:40px; margin: 0 auto 10px;"></div>\n            <div class="item-info">\n                <h3>${e.name}</h3>\n                <p>Profil ArkaplanÄ±</p>\n                <span class="item-cost">${e.price.toLocaleString()} ğŸ’°</span>\n            </div>\n            <button class="buy-btn" onclick="buyCustomization('bg', '${e.id}', ${e.price})">SatÄ±n Al</button>\n        `,a.appendChild(n)})}async function buyCustomization(e,n,t){if(!currentUser)return;const a=await getUserData();a?.is_infinite||t.toLocaleString();try{const t=await fetch("/api/customization/buy",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("aloskegang_token")}`},body:JSON.stringify({username:currentUser,type:e,id:n})}),a=await t.json();a.success?(showToast(a.message,"success"),loadProfile()):showToast(a.error||"Ä°ÅŸlem baÅŸarÄ±sÄ±z.","error")}catch(e){console.error(e),showToast("Sunucu hatasÄ±!","error")}}function showAlert(e,n){return new Promise(t=>{const a=document.getElementById("alert-modal");if(!a)return console.warn("Alert modal not found, fallback to native"),alert(n),void t();const i=document.getElementById("alert-modal-title"),r=document.getElementById("alert-modal-message");i&&(i.innerHTML=e),r&&(r.innerHTML=n),a.classList.remove("hidden"),a.style.display="flex";const s=document.getElementById("alert-modal-btn");s?s.onclick=()=>{a.classList.add("hidden"),a.style.display="none",t()}:setTimeout(()=>{a.classList.add("hidden"),a.style.display="none",t()},2e3)})}function showInput(e,n,t){return new Promise(a=>{const i=document.getElementById("input-modal");if(!i){const e=prompt(n);return void a(e)}const r=document.getElementById("input-modal-title"),s=document.getElementById("input-modal-desc"),o=document.getElementById("input-modal-value");r&&(r.innerHTML=e),s&&(s.innerHTML=n),o&&(o.value="",o.placeholder=t||"..."),i.classList.remove("hidden"),i.style.display="flex",o&&o.focus();const d=()=>{i.classList.add("hidden"),i.style.display="none"},c=document.getElementById("input-modal-confirm"),l=document.getElementById("input-modal-cancel");if(c&&l){const e=c.cloneNode(!0),n=l.cloneNode(!0);c.parentNode.replaceChild(e,c),l.parentNode.replaceChild(n,l),e.onclick=()=>{const e=o?o.value.trim():"";e?(d(),a(e)):o&&(o.style.border="1px solid red",setTimeout(()=>o.style.border="1px solid var(--glass-border)",1e3))},n.onclick=()=>{d(),a(null)},o&&(o.onkeydown=t=>{"Enter"===t.key&&e.click(),"Escape"===t.key&&n.click()})}else d(),a(null)})}function showConfirm(e,n,t){return"function"==typeof n&&(t=n,n=e,e="Onay"),new Promise(a=>{const i=document.getElementById("confirm-modal");if(!i){const i=confirm("string"==typeof n?n:e);return t&&t(i),void a(i)}const r=document.getElementById("confirm-modal-title"),s=document.getElementById("confirm-modal-message");r&&(r.innerHTML=e),s&&(s.innerHTML=n),i.classList.remove("hidden"),i.style.display="flex";const o=document.getElementById("confirm-modal-yes"),d=document.getElementById("confirm-modal-cancel"),c=o.cloneNode(!0),l=d.cloneNode(!0);o.parentNode.replaceChild(c,o),d.parentNode.replaceChild(l,d),c.onclick=()=>{i.style.display="none",i.classList.add("hidden"),t&&t(!0),a(!0)},l.onclick=()=>{i.style.display="none",i.classList.add("hidden"),t&&t(!1),a(!1)}})}async function depositGang(e){openDonateModal()}async function upgradeGang(e,n,t){if(await showConfirm(`Ã‡ete Seviyesi ${t}`,`Kasadaki paradan ${(n/1e6).toLocaleString()}M ğŸ’° harcanarak Ã§ete seviyesi yÃ¼kseltilecek. Kapasite artacak. OnaylÄ±yor musunuz?`))try{const n=await fetch("/api/gang/upgrade",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser,gangId:e})}),t=await n.json();t.success?(showToast(t.message,"success"),loadGangs()):showToast(t.error,"error")}catch(e){showToast("Hata oluÅŸtu","error")}}let gangChatListener=null;function loadGangChat(e,n){gangChatListener&&(gangChatListener.off(),gangChatListener=null);const t=document.getElementById("gang-chat-messages"),a=document.getElementById("gang-chat-input-section"),i=document.getElementById("gang-chat-readonly-notice"),r=document.getElementById("gang-chat-input");t&&("leader"===n||"officer"===n?(a.classList.remove("hidden"),i.classList.add("hidden"),r.onkeydown=e=>{"Enter"===e.key&&sendGangMessage()}):(a.classList.add("hidden"),i.classList.remove("hidden")),gangChatListener=db.ref(`gangs/${e}/chat`).orderByChild("timestamp").limitToLast(50),gangChatListener.on("value",e=>{t.innerHTML="";const n=[];e.forEach(e=>{n.push({id:e.key,...e.val()})}),0===n.length?t.innerHTML='<div style="color:#666; font-size:0.85rem; text-align:center; padding:20px;">Mesaj yok. Ä°lk mesajÄ± sen gÃ¶nder!</div>':(n.forEach(e=>{const n=document.createElement("div");n.style="background:rgba(255,255,255,0.03); border-left:3px solid var(--primary); padding:10px; border-radius:8px;";const a=new Date(e.timestamp).toLocaleString("tr-TR",{hour:"2-digit",minute:"2-digit",day:"2-digit",month:"2-digit"});let i="ğŸ‘¤";"leader"===e.rank?i="ğŸ‘‘":"officer"===e.rank&&(i="âš”ï¸"),n.innerHTML=`\n                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">\n                        <span style="font-weight:700; color:var(--primary); font-size:0.9rem;">\n                            ${i} @${e.username}\n                        </span>\n                        <span style="font-size:0.7rem; color:#666;">${a}</span>\n                    </div>\n                    <div style="color:#ddd; font-size:0.9rem; word-wrap:break-word;">${escapeHtml(e.message)}</div>\n                `,t.appendChild(n)}),t.scrollTop=t.scrollHeight)}))}async function sendGangMessage(){const e=document.getElementById("gang-chat-input"),n=e.value.trim();if(!n)return;if(!currentUser||!lastUserData?.gang)return void showToast("Ã‡ete bilgisi bulunamadÄ±!","error");const t=lastUserData.gang;try{const a=await fetch("/api/gang/sendMessage",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser,gangId:t,message:n})}),i=await a.json();i.success?(e.value="",showToast("Mesaj gÃ¶nderildi!","success")):showToast(i.error||"Mesaj gÃ¶nderilemedi!","error")}catch(e){showToast("BaÄŸlantÄ± hatasÄ±!","error")}}function escapeHtml(e){const n=document.createElement("div");return n.textContent=e,n.innerHTML}function calculateShopStock(){const e=document.getElementById("shopCalcCode"),n=document.getElementById("shopCalcAmount");if(!e||!n)return;const t=e.value.toUpperCase().trim(),a=parseFloat(n.value),i=document.getElementById("shopCalcBuy"),r=document.getElementById("shopCalcSell");if(!t||!a||a<=0||!window.shopStocks||!window.shopStocks[t])return i.innerText="0 ğŸ’°",void(r.innerText="0 ğŸ’°");const s=window.shopStocks[t].price,o=s*a,d=s*a,c=d-.1*d;i.innerText=Math.floor(o).toLocaleString()+" ğŸ’°",r.innerText=Math.floor(c).toLocaleString()+" ğŸ’°"}let businessTypes={},productData={},licenseData={},levelData={},advertisingData={},marketPrices={},marketEvents=[],userLicenses=[];async function loadBusinessData(){try{const e=await fetch("/api/business/types"),n=await e.json();n.success&&(businessTypes=n.types||{},productData=n.products||{},licenseData=n.licenses||{},levelData=n.levels||{},advertisingData=n.advertising||{});const t=await fetch("/api/business/market"),a=await t.json();a.success&&(marketPrices=a.prices||{},marketEvents=a.events||[],renderMarketEvents())}catch(e){console.error("Business data load error:",e)}}function renderMarketEvents(){const e=document.getElementById("market-events-list");if(!e)return;if(!marketEvents||0===marketEvents.length)return void(e.innerHTML='<div style="opacity:0.5; font-size:0.8rem; padding:10px; text-align:center;">Åu an aktif kÃ¼resel bir olay yok.</div>');const n="news-ticker-style";if(!document.getElementById(n)){const e=document.createElement("style");e.id=n,e.innerHTML="\n            @keyframes ticker {\n                0% { transform: translate3d(0, 0, 0); }\n                100% { transform: translate3d(-100%, 0, 0); }\n            }\n            .news-ticker-wrap {\n                width: 100%;\n                overflow: hidden;\n                background: rgba(0, 0, 0, 0.4);\n                border: 1px solid rgba(255, 255, 255, 0.1);\n                border-radius: 8px;\n                display: flex;\n                align-items: center;\n                height: 40px;\n                position: relative;\n                margin-bottom: 10px;\n            }\n            .news-label {\n                background: #ff4444;\n                color: white;\n                padding: 0 15px;\n                font-weight: 800;\n                font-size: 0.8rem;\n                height: 100%;\n                display: flex;\n                align-items: center;\n                z-index: 2;\n                position: absolute;\n                left: 0;\n                text-transform: uppercase;\n                letter-spacing: 0.5px;\n            }\n            .ticker-content {\n                display: flex;\n                animation: ticker 40s linear infinite;\n                padding-left: 120px; /* Label width */\n                white-space: nowrap;\n                height: 100%;\n                align-items: center;\n            }\n            .ticker-item {\n                display: inline-flex;\n                align-items: center;\n                color: #ddd;\n                font-weight: 500;\n                margin-right: 60px;\n                font-size: 0.9rem;\n            }\n            .ticker-item strong {\n                color: #fff;\n                margin-right: 6px;\n                font-weight: 700;\n            }\n            .impact-tag {\n                background: rgba(255,255,255,0.15); \n                padding: 2px 6px; \n                border-radius: 4px; \n                font-size: 0.75rem; \n                margin-left: 8px;\n                color: #4db8ff;\n                font-weight: 600;\n            }\n            .impact-bad { color: #ff6666; }\n            .impact-good { color: #66ff66; }\n        ",document.head.appendChild(e)}const t=[...marketEvents,...marketEvents].map(e=>`\n        <div class="ticker-item">\n            <strong>${e.name}</strong>: \n            ${e.desc||"Piyasa geliÅŸmesi."} \n            ${(e=>{if(!e.effect)return"";let n=[];if(e.effect.sales){const t=Math.round(100*(e.effect.sales-1));n.push(`<span class="${t>0?"impact-good":"impact-bad"}">SatÄ±ÅŸlar ${t>0?"+":""}${t}%</span>`)}if(e.effect.production){const t=Math.round(100*(e.effect.production-1));n.push(`<span class="${t>0?"impact-good":"impact-bad"}">Ãœretim ${t>0?"+":""}${t}%</span>`)}if(e.effect.price){const t=Math.round(100*(e.effect.price-1));n.push(`<span class="${t>0?"impact-good":"impact-bad"}">Fiyatlar ${t>0?"+":""}${t}%</span>`)}if(e.effect.maintenance){const t=Math.round(100*(e.effect.maintenance-1));n.push(`<span class="${t<0?"impact-good":"impact-bad"}">Maliyet ${t>0?"+":""}${t}%</span>`)}return 0===n.length?"":` <span class="impact-tag">[${n.join(", ")}]</span>`})(e)}\n        </div>\n    `).join("");e.innerHTML=`\n        <div class="news-ticker-wrap">\n            <div class="news-label">PÄ°YASA</div>\n            <div class="ticker-content" style="animation-duration: ${Math.max(25,12*marketEvents.length)}s;">\n                ${t}\n            </div>\n        </div>\n    `}function switchBusinessTab(e){document.querySelectorAll(".business-sub-content").forEach(e=>e.classList.add("hidden")),document.querySelectorAll(".sub-tab-btn").forEach(e=>e.classList.remove("active"));const n=document.getElementById("business-sub-"+e);n&&n.classList.remove("hidden"),event.target.classList.add("active"),"my-businesses"===e?loadMyBusinesses():"new-business"===e?renderBusinessTypes():"licenses"===e?renderLicenses():"market-prices"===e?renderMarketPrices():"warehouse"===e?loadWarehouseInfo():"rnd"===e&&loadRnDUpgrades()}async function loadMyBusinesses(){if(!currentUser)return;const e=document.getElementById("my-businesses-list");e.innerHTML='<div style="text-align:center; padding:40px;"><div class="loader"></div></div>';try{const n=await fetch(`/api/business/my-businesses?username=${encodeURIComponent(currentUser)}`),t=await n.json();if(!t.success||!t.businesses||0===t.businesses.length)return void(e.innerHTML='\n                <div style="grid-column: 1/-1; text-align:center; padding:60px; opacity:0.5;">\n                    <i class="fas fa-store-slash" style="font-size:4rem; margin-bottom:20px;"></i>\n                    <p>HenÃ¼z iÅŸletmen yok. Yeni bir iÅŸletme kurmak iÃ§in "â• Yeni Ä°ÅŸletme" sekmesine git.</p>\n                </div>');userLicenses=t.licenses||[];const a={retail:{name:"ğŸ›’ Perakende Ä°ÅŸletmeler",businesses:[],icon:"ğŸª"},production:{name:"ğŸ­ Ãœretim Tesisleri",businesses:[],icon:"ğŸ­"},farming:{name:"ğŸŒ¾ TarÄ±m Ä°ÅŸletmeleri",businesses:[],icon:"ğŸŒ¾"},livestock:{name:"ğŸ„ HayvancÄ±lÄ±k Ä°ÅŸletmeleri",businesses:[],icon:"ğŸ„"},special:{name:"â­ Ã–zel Ä°ÅŸletmeler",businesses:[],icon:"âš¡"}};for(const e of t.businesses){const n=e.typeData?.category||"retail";a[n]&&a[n].businesses.push(e)}e.innerHTML="";for(const[n,t]of Object.entries(a)){if(0===t.businesses.length)continue;const n=document.createElement("div");n.style.cssText="grid-column: 1/-1; margin:30px 0 15px 0; padding:15px 20px; background:linear-gradient(90deg, rgba(0,255,136,0.1), transparent); border-left:4px solid var(--primary); border-radius:8px;",n.innerHTML=`\n                <h3 style="margin:0; font-size:1.3rem; font-weight:800;">${t.name}</h3>\n                <div style="font-size:0.85rem; color:#888; margin-top:5px;">${t.businesses.length} iÅŸletme</div>\n            `,e.appendChild(n);for(const n of t.businesses){const t=document.createElement("div");t.className="glass-panel",t.style.cssText="padding:20px; border-radius:16px;";const a=n.health>70?"#00ff88":n.health>30?"#ffaa00":"#ff4444",i=n.typeData||{},r=(n.levelData,Object.entries(n.inventory||{}).filter(([e,n])=>n>0).map(([e,n])=>`${productData[e]?.icon||""} ${n}`).slice(0,5).join(" "));t.innerHTML=`\n                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:15px;">\n                    <div>\n                        <div style="font-size:2rem; margin-bottom:5px;">${i.icon||"ğŸª"}</div>\n                        <h3 style="margin:0; font-size:1.2rem;">${sanitizeHTML(n.name)}</h3>\n                        <div style="font-size:0.8rem; color:#888;">${i.name} â€¢ ${n.city}</div>\n                    </div>\n                    <div style="text-align:right;">\n                        <div style="font-size:0.75rem; color:#888;">SEVÄ°YE</div>\n                        <div style="font-size:1.5rem; font-weight:900; color:var(--primary);">${n.level}</div>\n                    </div>\n                </div>\n                \n                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">\n                    <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:8px;">\n                        <div style="font-size:0.7rem; color:#888;">ğŸ”§ SAÄLIK</div>\n                        <div style="height:6px; background:#333; border-radius:3px; margin-top:5px; overflow:hidden;">\n                            <div style="height:100%; width:${n.health}%; background:${a}; border-radius:3px;"></div>\n                        </div>\n                        <div style="font-size:0.75rem; color:${a}; margin-top:3px;">${Math.floor(n.health)}%</div>\n                    </div>\n                    <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:8px;">\n                        <div style="font-size:0.7rem; color:#888;">ğŸ“¦ DEPO</div>\n                        <div style="font-size:0.85rem; margin-top:5px;">${r||"BoÅŸ"}</div>\n                    </div>\n                </div>\n                \n                <div style="display:flex; gap:8px; flex-wrap:wrap;">\n                    ${i.produces?`<button onclick="businessProduce('${n.id}')" class="btn-sm" style="background:linear-gradient(135deg, #00ff88, #00cc66);">âš™ï¸ Ãœret</button>`:""}\n                    <button onclick="showBusinessSellModal('${n.id}')" class="btn-sm" style="background:linear-gradient(135deg, #4488ff, #2266cc);">ğŸ’° Sat</button>\n                    <button onclick="businessMaintain('${n.id}')" class="btn-sm" style="background:linear-gradient(135deg, #ff8800, #cc6600);">ğŸ”§ BakÄ±m</button>\n                    <button onclick="businessUpgrade('${n.id}')" class="btn-sm" style="background:linear-gradient(135deg, #aa44ff, #8822cc);">â¬†ï¸ YÃ¼kselt</button>\n                </div>\n                \n                <div style="margin-top:15px; padding-top:15px; border-top:1px solid rgba(255,255,255,0.1); font-size:0.75rem; color:#666;">\n                    Toplam SatÄ±ÅŸ: ${(n.total_sales||0).toLocaleString()} adet â€¢ Gelir: ${(n.total_revenue||0).toLocaleString()} ğŸ’°\n                </div>\n            `,e.appendChild(t)}}}catch(n){console.error("My businesses load error:",n),e.innerHTML='<div style="text-align:center; padding:40px; color:#ff4444;">Ä°ÅŸletmeler yÃ¼klenemedi.</div>'}}let currentBusinessFilter="all";function filterBusinessTypes(e,n){currentBusinessFilter=e,document.querySelectorAll(".filter-btn").forEach(e=>{e.classList.remove("active"),e.style.background="rgba(255,255,255,0.05)",e.style.color="#aaa"}),n&&(n.classList.add("active"),n.style.background="rgba(255,255,255,0.1)",n.style.color="#fff"),renderBusinessTypes()}function renderBusinessTypes(){const e=document.getElementById("business-types-grid");if(!e)return;const n={retail:{name:"ğŸ›’ Perakende",items:[]},production:{name:"ğŸ­ Ãœretim",items:[]},farming:{name:"ğŸŒ¾ TarÄ±m",items:[]},livestock:{name:"ğŸ„ HayvancÄ±lÄ±k",items:[]},special:{name:"âš¡ Ã–zel Ä°ÅŸletmeler",items:[]}};for(const[e,t]of Object.entries(businessTypes))"all"!==currentBusinessFilter&&t.category!==currentBusinessFilter||n[t.category]&&n[t.category].items.push({code:e,...t});let t="";for(const[e,a]of Object.entries(n))if(0!==a.items.length){t+=`<div style="grid-column: 1/-1; margin-top:20px; margin-bottom:10px;">\n            <h3 style="margin:0; font-size:1.2rem;">${a.name}</h3>\n        </div>`;for(const e of a.items){const n=e.requiredLicense&&!userLicenses.includes(e.requiredLicense),a=e.requiredLicense?licenseData[e.requiredLicense]:null;t+=`\n                <div class="glass-panel" style="padding:20px; border-radius:16px; ${n?"opacity:0.6;":""}">\n                    <div style="font-size:2.5rem; text-align:center; margin-bottom:10px;">${e.icon}</div>\n                    <h4 style="margin:0 0 5px 0; text-align:center;">${e.name}</h4>\n                    <div style="text-align:center; font-size:0.85rem; color:var(--primary); font-weight:bold; margin-bottom:10px;">\n                        ${e.setupCost.toLocaleString()} ğŸ’°\n                    </div>\n                    \n                    <div style="font-size:0.75rem; color:#888; margin-bottom:5px;">\n                        ${e.produces?`Ãœretim: ${e.produces.map(e=>productData[e]?.icon||e).join(" ")}`:`SatÄ±ÅŸ: ${e.products?.map(e=>productData[e]?.icon||e).join(" ")||""}`}\n                    </div>\n                    ${e.requires&&e.requires.length>0?`\n                    <div style="font-size:0.75rem; color:#aaa; margin-bottom:10px;">\n                        Gereksinim: ${e.requires.map(e=>productData[e]?.name||e).join(", ")}\n                    </div>\n                    `:""}\n                    \n                    ${n?`<div style="font-size:0.75rem; color:#ff8800; margin-bottom:10px;">ğŸ”’ ${a?.name||"Lisans"} gerekli</div>`:""}\n                    \n                    <button onclick="showCreateBusinessModal('${e.code}')" class="buy-btn" style="width:100%; ${n?"opacity:0.5; pointer-events:none;":""}">\n                        ${n?"ğŸ”’ Lisans Gerekli":"ğŸ—ï¸ Kur"}\n                    </button>\n                </div>\n            `}}e.innerHTML=t}async function renderLicenses(){const e=document.getElementById("licenses-grid");if(e){e.innerHTML='<div class="loader"></div>';try{const[n,t,a,i]=await Promise.all([fetch(`/api/business-license/info?username=${encodeURIComponent(currentUser)}`).then(e=>e.json()),fetch(`/api/farming-license/info?username=${encodeURIComponent(currentUser)}`).then(e=>e.json()),fetch(`/api/livestock-license/info?username=${encodeURIComponent(currentUser)}`).then(e=>e.json()),fetch(`/api/special-license/info?username=${encodeURIComponent(currentUser)}`).then(e=>e.json())]);let r="";const s=(e,n,t,a)=>{const i=t.level||1,r=t.maxBusinesses||t.maxFarms||t.maxLivestock||t.maxSpecial||0,s=t.currentBusinesses||0,o=t.nextLevelCost,d=!o;return`\n            <div class="glass-panel" style="padding:20px; border-radius:16px; position:relative; overflow:hidden;">\n                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:15px;">\n                    <div>\n                        <div style="font-size:2rem; margin-bottom:5px;">${n}</div>\n                        <h3 style="margin:0; font-size:1.1rem;">${e}</h3>\n                        <div style="font-size:0.8rem; color:#aaa;">Seviye ${i}: ${t.levelData?.name||"Bilinmiyor"}</div>\n                    </div>\n                    <div style="text-align:right;">\n                        <div style="font-size:0.7rem; color:#888; font-weight:700;">LÄ°MÄ°T</div>\n                        <div style="font-size:1.4rem; font-weight:800; color:white;">${s} / ${r}</div>\n                    </div>\n                </div>\n\n                <div class="progress-bar" style="height:6px; background:rgba(255,255,255,0.1); margin-bottom:15px;">\n                    <div class="progress-fill" style="width:${Math.min(s/r*100,100)}%;"></div>\n                </div>\n\n                ${d?'<button disabled class="buy-btn" style="opacity:0.5; background:#333; color:#aaa;">MAKSÄ°MUM SEVÄ°YE</button>':`<button onclick="upgradeLicense('${a}', ${o})" class="buy-btn" style="background:linear-gradient(45deg, var(--primary), #00cc66);">\n                        YÃœKSELT <br> <span style="font-size:0.8em; opacity:0.9;">${o.toLocaleString()} ğŸ’°</span>\n                    </button>`}\n            </div>\n            `};r+=s("Ä°ÅŸletme LisansÄ±","ğŸ¢",n,"business"),r+=s("TarÄ±m LisansÄ±","ğŸŒ¾",t,"farming"),r+=s("HayvancÄ±lÄ±k LisansÄ±","ğŸ„",a,"livestock"),r+=s("Ã–zel Ãœretim Ä°zni","âš¡",i,"special"),r+='\n            <div style="grid-column: 1/-1; margin-top:30px; margin-bottom:15px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">\n                <h3 style="margin:0; font-size:1.2rem; color:var(--primary);">ğŸ“œ Mesleki Belgeler & Ruhsatlar</h3>\n                <p style="font-size:0.85rem; color:#aaa;">Belirli iÅŸletmeleri aÃ§mak iÃ§in gereken zorunlu sertifikalar.</p>\n            </div>\n        ';for(const[e,n]of Object.entries(licenseData)){const t=userLicenses.includes(e),a=n.requiresEdu?`ğŸ“š EÄŸitim: ${n.requiresEdu}. Seviye`:"";r+=`\n                <div class="glass-panel" style="padding:15px; border-radius:12px; display:flex; flex-direction:column; justify-content:space-between; ${t?"border:1px solid rgba(0,255,136,0.3); background:rgba(0,255,136,0.05);":""}">\n                    <div>\n                        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">\n                            <div style="font-size:1.8rem;">${n.icon||"ğŸ“„"}</div>\n                            <div>\n                                <h4 style="margin:0; font-size:1rem;">${n.name}</h4>\n                                <div style="font-size:0.75rem; color:#888;">${a}</div>\n                            </div>\n                        </div>\n                    </div>\n                    \n                    ${t?'<button disabled class="buy-btn" style="background:transparent; border:1px solid var(--primary); color:var(--primary); cursor:default; width:100%;">âœ… SAHÄ°PSÄ°N</button>':`<button onclick="buyLicense('${e}')" class="buy-btn" style="width:100%;">\n                            SATIN AL <br> <span style="font-size:0.9em; opacity:0.8;">${n.price.toLocaleString()} ğŸ’°</span>\n                        </button>`}\n                </div>\n            `}e.innerHTML=r}catch(n){console.error("Lisans yÃ¼kleme hatasÄ±:",n),e.innerHTML='<div style="color:red; text-align:center;">Lisans bilgileri yÃ¼klenemedi!</div>'}}}async function upgradeLicense(e,n){showConfirm("Lisans YÃ¼kseltme",`Lisans seviyesini yÃ¼kseltmek iÃ§in ${n.toLocaleString()} ğŸ’° Ã¶demeyi onaylÄ±yor musun?`).then(async n=>{if(n)try{const n=await fetch(`/api/${e}-license/upgrade`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser})}),t=await n.json();showToast(t.message||t.error,t.success?"success":"error"),t.success&&(renderLicenses(),renderBusinessTypes())}catch(e){showToast("Hata: "+e.message,"error")}})}function renderMarketPrices(){const e=document.getElementById("product-prices-table");if(!e)return;const n={raw:"ğŸŒ¿ Hammadde",processed:"âš™ï¸ Ä°ÅŸlenmiÅŸ",fresh:"ğŸ¥¬ Taze",animal:"ğŸ¥© Hayvansal",premium:"ğŸ’ Premium",ready:"ğŸ½ï¸ HazÄ±r"},t={1:{name:"Ã‡ok DÃ¼ÅŸÃ¼k",color:"#ff4444"},2:{name:"DÃ¼ÅŸÃ¼k",color:"#ff9944"},3:{name:"Orta",color:"#ffdd44"},4:{name:"YÃ¼ksek",color:"#99ff44"},5:{name:"Ã‡ok YÃ¼ksek",color:"#00ff88"}};let a="";for(const[e,i]of Object.entries(n)){const n=Object.entries(productData).filter(([n,t])=>t.category===e);if(0!==n.length){a+=`<div style="grid-column: 1/-1; margin-top:15px; font-weight:bold; color:var(--primary);">${i}</div>`;for(const[e,i]of n){if("sebze"===e||"meyve"===e)continue;const n=(marketPrices[e]||i.basePrice)/i.basePrice;let r=3;r=n<.6?1:n<.9?2:n<1.1?3:n<1.4?4:5;const s=t[r];a+=`\n                <div style="background:rgba(0,0,0,0.3); padding:12px 15px; border-radius:10px; display:flex; justify-content:space-between; align-items:center; border-left:3px solid ${s.color};">\n                    <div>\n                        <span>${i.icon} ${i.name}</span>\n                        <span style="font-size:0.75rem; color:#888; margin-left:5px;">(${i.unit||"adet"})</span>\n                    </div>\n                    <span style="font-weight:800; color:${s.color}; font-size:0.95rem;">${s.name}</span>\n                </div>\n            `}}}e.innerHTML=a||'<div style="text-align:center; padding:40px; opacity:0.5;">Piyasa verileri yÃ¼kleniyor...</div>'}async function showCreateBusinessModal(e){const n=businessTypes[e];if(n)try{const t=await fetch("/api/user/"+currentUser),a=await t.json();let i=(a.user||a).properties||[];Array.isArray(i)||(i=Object.values(i));const r="retail"===n.category?"shop":"land",s=i.map((e,n)=>({...e,originalIndex:n})).filter(e=>e.category===r&&!e.usedBy);if(0===s.length)return showToast(`Ä°ÅŸletme kurmak iÃ§in boÅŸ bir ${"shop"===r?"DÃ¼kkan":"Arazi"} sahibi olmalÄ±sÄ±n! Emlak sekmesine gÃ¶z at.`,"error");const o=s.map(e=>`<option value="${e.originalIndex}">${e.city||e.cityId} - ${e.name}</option>`).join("");showConfirm(`\n            <h3>${n.icon} ${n.name} Kur</h3>\n            <div style="margin:15px 0; text-align:left;">\n                <label style="display:block; font-size:0.85rem; color:#aaa; margin-bottom:8px;">Ä°ÅŸletme AdÄ±:</label>\n                <input type="text" id="new-biz-name" placeholder="Ã–rn: Ã–rnek ${n.name}" class="borsa-input" style="width:100%; margin-bottom:15px;">\n                \n                <label style="display:block; font-size:0.85rem; color:#aaa; margin-bottom:8px;">Kurulacak MÃ¼lk SeÃ§imi:</label>\n                <select id="new-biz-prop-index" class="borsa-input" style="width:100%; margin-bottom:15px;">\n                    ${o}\n                </select>\n                \n                ${n.requires&&n.requires.length>0?`\n                <div style="background:rgba(255, 255, 255, 0.05); padding:10px; border-radius:8px; margin-bottom:10px;">\n                    <p style="margin:0; font-size:0.8rem; color:#aaa;">Gerekli Hammaddeler:</p>\n                    <p style="margin:5px 0 0 0; font-size:0.9rem; color:#fff;">${n.requires.map(e=>"â€¢ "+(productData[e]?.name||e)).join("<br>")}</p>\n                </div>\n                `:""}\n\n                <div style="background:rgba(5, 234, 106, 0.1); padding:10px; border-radius:8px; border:1px solid rgba(5, 234, 106, 0.2);">\n                    <p style="margin:0; font-size:0.85rem; color:#ccc;">ğŸ’° KuruluÅŸ Bedeli: <b style="color:var(--primary);">${n.setupCost.toLocaleString()}</b></p>\n                </div>\n            </div>\n        `,async()=>{const n=document.getElementById("new-biz-name").value.trim(),t=document.getElementById("new-biz-prop-index").value,a=s.find(e=>e.originalIndex.toString()===t);if(!n)return showToast("Ä°ÅŸletme adÄ± gerekli!","error");if(!a)return showToast("MÃ¼lk seÃ§imi geÃ§ersiz!","error");const i=await fetch("/api/business/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser,businessType:e,city:a.city||a.cityId,name:n,propertyId:a.originalIndex.toString()})}),r=await i.json();showToast(r.message||r.error,r.success?"success":"error"),r.success&&(loadMyBusinesses(),switchBusinessTab("my-businesses"),loadProfile())})}catch(e){showToast("MÃ¼lk bilgileri alÄ±namadÄ±!","error"),console.error(e)}}async function buyLicense(e){showConfirm("Bu lisansÄ± satÄ±n almak istediÄŸine emin misin?",async()=>{try{const n=await fetch("/api/business/buy-license",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser,licenseCode:e})}),t=await n.json();showToast(t.message||t.error,t.success?"success":"error"),t.success&&(userLicenses.push(e),renderLicenses(),renderBusinessTypes())}catch(e){showToast("Hata: "+e.message,"error")}})}async function businessProduce(e){try{const n=await fetch(`/api/business/my-businesses?username=${encodeURIComponent(currentUser)}`),t=await n.json();if(!t.success)return void showToast("Ä°ÅŸletme bilgisi alÄ±namadÄ±!","error");const a=t.businesses.find(n=>n.id===e);if(!a)return void showToast("Ä°ÅŸletme bulunamadÄ±!","error");const i=(businessTypes[a.type]||{}).produces||[];if(0===i.length)return void showToast("Bu iÅŸletme Ã¼retim yapmaz!","error");1===i.length?doProductionRequest(e,i[0]):showConfirm(`\n                <h3>âš™ï¸ ÃœrÃ¼n SeÃ§imi</h3>\n                <p style="margin:10px 0; color:#888;">Hangi Ã¼rÃ¼nÃ¼ Ã¼retmek istiyorsun?</p>\n                <select id="produce-select" class="borsa-input" style="width:100%;">\n                    ${i.map(e=>{const n=productData[e];return`<option value="${e}">${n?.icon||""} ${n?.name||e}</option>`}).join("")}\n                </select>\n            `,()=>{const n=document.getElementById("produce-select").value;doProductionRequest(e,n)})}catch(e){showToast("Hata: "+e.message,"error")}}async function doProductionRequest(e,n){try{const t=await fetch("/api/business/produce",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser,businessId:e,selectedProduct:n})}),a=await t.json();showToast(a.message||a.error,a.success?"success":"error"),a.success&&loadMyBusinesses()}catch(e){showToast("Hata: "+e.message,"error")}}async function businessMaintain(e){try{const n=await fetch(`/api/business/my-businesses?username=${encodeURIComponent(currentUser)}`),t=await n.json();if(!t.success)return showToast("Ä°ÅŸletme bilgisi alÄ±namadÄ±!","error");const a=t.businesses.find(n=>n.id===e);if(!a)return showToast("Ä°ÅŸletme bulunamadÄ±!","error");const i=businessTypes[a.type]||{},r=100-(a.health||100);if(r<=0)return showToast("Ä°ÅŸletme zaten tam saÄŸlÄ±klÄ±!","info");const s=(i.baseMaintenance||5e3)/10,o=Math.floor(s*r);if(!await showConfirm("ğŸ”§ Ä°ÅŸletme BakÄ±mÄ±",`\n            <div style="text-align:left;">\n                <p><b>${i.name||a.type}</b></p>\n                <p>Mevcut SaÄŸlÄ±k: <span style="color:${a.health<50?"#ff4444":"#44ff44"}">%${a.health||100}</span></p>\n                <p>OnarÄ±m: <b>%${r}</b></p>\n                <hr style="border-color:rgba(255,255,255,0.1); margin:10px 0;">\n                <p style="font-size:1.2rem; color:var(--primary);">ğŸ’° Maliyet: <b>${o.toLocaleString()}</b></p>\n            </div>\n        `))return;const d=await fetch("/api/business/maintain",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser,businessId:e})}),c=await d.json();showToast(c.message||c.error,c.success?"success":"error"),c.success&&loadMyBusinesses()}catch(e){showToast("Hata: "+e.message,"error")}}async function businessUpgrade(e){try{const n=await fetch(`/api/business/my-businesses?username=${encodeURIComponent(currentUser)}`),t=await n.json();if(!t.success)return showToast("Ä°ÅŸletme bilgisi alÄ±namadÄ±!","error");const a=t.businesses.find(n=>n.id===e);if(!a)return showToast("Ä°ÅŸletme bulunamadÄ±!","error");const i=businessTypes[a.type]||{},r=a.level||1,s=r+1,o={2:.5,3:1,4:2,5:4,6:8,7:16,8:32}[s];if(!o)return showToast("Maksimum seviyeye ulaÅŸtÄ±n!","info");const d=Math.floor((i.setupCost||5e5)*o);if(!await showConfirm("â¬†ï¸ Ä°ÅŸletme YÃ¼kseltme",`\n            <div style="text-align:left;">\n                <p><b>${i.name||a.type}</b></p>\n                <p>Mevcut Seviye: <span style="color:var(--secondary);">${r}</span></p>\n                <p>Yeni Seviye: <span style="color:var(--primary);">${s}</span></p>\n                <hr style="border-color:rgba(255,255,255,0.1); margin:10px 0;">\n                <p style="font-size:0.85rem; color:#aaa;">+%${Math.round(10*o)} Ãœretim Bonusu</p>\n                <p style="font-size:1.2rem; color:var(--primary);">ğŸ’° Maliyet: <b>${d.toLocaleString()}</b></p>\n            </div>\n        `))return;const c=await fetch("/api/business/upgrade",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser,businessId:e})}),l=await c.json();showToast(l.message||l.error,l.success?"success":"error"),l.success&&loadMyBusinesses()}catch(e){showToast("Hata: "+e.message,"error")}}async function showBusinessSellModal(e){try{const n=await fetch(`/api/business/my-businesses?username=${encodeURIComponent(currentUser)}`),t=await n.json();if(!t.success)return showToast("Ä°ÅŸletme bilgisi alÄ±namadÄ±!","error");const a=t.businesses.find(n=>n.id===e);if(!a)return showToast("Ä°ÅŸletme bulunamadÄ±!","error");const i=businessTypes[a.type]||{},r=i.setupCost||5e5,s={2:.5,3:1,4:2,5:4,6:8,7:16,8:32};let o=r;for(let e=2;e<=(a.level||1);e++)o+=r*(s[e]||0);const d=Math.floor(.5*o);if(!await showConfirm("ğŸ·ï¸ Ä°ÅŸletmeyi Sat",`\n            <div style="text-align:left;">\n                <p><b>${i.name||a.type}</b> (Seviye ${a.level||1})</p>\n                <p>Åehir: ${a.city}</p>\n                <hr style="border-color:rgba(255,255,255,0.1); margin:10px 0;">\n                <p style="color:#888;">Toplam YatÄ±rÄ±m: ${o.toLocaleString()} ğŸ’°</p>\n                <p style="font-size:1.2rem; color:var(--secondary);">ğŸ’µ SatÄ±ÅŸ FiyatÄ±: <b>${d.toLocaleString()}</b> (%50)</p>\n                <p style="font-size:0.8rem; color:#ff6666; margin-top:10px;">âš ï¸ Bu iÅŸlem geri alÄ±namaz!</p>\n            </div>\n        `))return;sellBusiness(e)}catch(e){showToast("Hata: "+e.message,"error")}}async function sellBusiness(e){try{const n=await fetch("/api/business/sell",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser,bizId:e})}),t=await n.json();t.success?(showToast(t.message,"success"),loadMyBusinesses(),loadProfile()):showToast(t.error||"Hata oluÅŸtu","error")}catch(e){showToast("BaÄŸlantÄ± hatasÄ±","error")}}function onBusinessTabOpen(){loadBusinessData().then(()=>{loadMyBusinesses()})}function getQualityColor(e){return e>=75?"#00ff88":e>=50?"#ffaa00":e>=25?"#ff8800":"#ff4444"}function getQualityName(e){return e>=90?"MÃ¼kemmel":e>=75?"Ä°yi":e>=50?"Orta":e>=25?"DÃ¼ÅŸÃ¼k":"Ã‡ok DÃ¼ÅŸÃ¼k"}let gangChatInterval=null,lastGangId=null;function initGangChat(e){gangChatInterval&&clearInterval(gangChatInterval),lastGangId=e,refreshGangChat(),gangChatInterval=setInterval(refreshGangChat,5e3)}async function refreshGangChat(){if(lastGangId&&!document.getElementById("gang-dashboard").classList.contains("hidden"))try{const e=await fetch(`/api/gang/chat/list?gangId=${lastGangId}&limit=50`),n=await e.json(),t=document.getElementById("gang-chat-messages");if(!t)return;if(n.success){const e=Object.values(n.messages||{});if(0===e.length)return void(t.innerHTML='<div style="text-align:center; color:#666; font-size:0.8rem; margin-top:20px;">HenÃ¼z mesaj yok. Ä°lk mesajÄ± sen yaz!</div>');t.innerHTML=e.map(e=>{const n=e.sender.toLowerCase()===currentUser.toLowerCase(),t=new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return`\n                    <div style="display:flex; flex-direction:column; align-items:${n?"flex-end":"flex-start"};">\n                        <div style="display:flex; align-items:center; gap:5px; margin-bottom:2px;">\n                            <span style="font-size:0.7rem; color:${n?"#00ff88":"#aaa"}; font-weight:700;">\n                                ${"leader"===e.rank?"ğŸ‘‘":"officer"===e.rank?"âš”ï¸":""} ${e.sender}\n                            </span>\n                            <span style="font-size:0.6rem; color:#666;">${t}</span>\n                        </div>\n                        <div style="\n                            background:${n?"rgba(0, 255, 136, 0.1)":"rgba(255, 255, 255, 0.05)"}; \n                            border:1px solid ${n?"rgba(0, 255, 136, 0.2)":"rgba(255, 255, 255, 0.1)"};\n                            padding:8px 12px; \n                            border-radius:12px; \n                            border-${n?"top-right":"top-left"}-radius:0;\n                            color:#ddd; \n                            font-size:0.9rem;\n                            max-width:85%;\n                            word-wrap:break-word;\n                        ">\n                            ${e.text}\n                        </div>\n                    </div>\n                `}).join(""),t.scrollTop=t.scrollHeight}}catch(e){console.error("Chat refresh error",e)}}async function sendGangChat(){const e=document.getElementById("gang-chat-input"),n=e.value.trim();if(n&&lastGangId){e.value="";try{const e=await fetch("/api/gang/chat/send",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser,gangId:lastGangId,message:n})}),t=await e.json();t.success?refreshGangChat():showToast("Mesaj gÃ¶nderilemedi: "+t.error,"error")}catch(e){showToast("Hata oluÅŸtu!","error")}}}function switchMarketTab(e){document.querySelectorAll(".market-sub-content").forEach(e=>e.classList.add("hidden")),document.getElementById("market-sub-"+e).classList.remove("hidden"),document.querySelectorAll(".sub-tab-btn").forEach(e=>e.classList.remove("active")),window.event&&window.event.currentTarget.classList.add("active"),"browse"===e&&loadMarketListings(1),"my-listings"===e&&loadMyListings(),"create"===e&&loadUserInventoryForListing()}function populateMarketCities(){const e=document.getElementById("market-city-filter"),n=document.getElementById("new-listing-city"),t=EMLAK_CITIES.sort((e,n)=>e.name.localeCompare(n.name,"tr")).map(e=>`<option value="${e.name}">${e.name}</option>`).join("");e&&e.children.length<=2&&(e.innerHTML='<option value="">TÃ¼m Åehirler</option>'+t),n&&n.children.length<=1&&(n.innerHTML='<option value="" disabled selected>Åehir SeÃ§</option>'+t)}async function loadMarketListings(e=1){populateMarketCities();try{const n=document.getElementById("market-search").value,t=document.getElementById("market-category-filter").value,a=`/api/marketplace/listings?page=${e}&q=${n}&category=${t}&city=${document.getElementById("market-city-filter").value}&shopType=${document.getElementById("market-shop-filter")?.value||"all"}`,i=await fetch(a),r=await i.json(),s=document.getElementById("marketplace-listings"),o=document.getElementById("market-pagination");if(!r.success||0===r.listings.length)return s.innerHTML='<div style="grid-column:1/-1; text-align:center; padding:60px; opacity:0.5;"><div style="font-size:4rem; margin-bottom:20px;">ğŸª</div><p>AradÄ±ÄŸÄ±n kriterlere uygun ilan bulunamadÄ±.</p></div>',void(o.innerHTML="");let d="";for(const e of r.listings){const n=productData[e.productCode]||{name:e.productCode,icon:"ğŸ“¦",unit:"adet"},t=e.isSystem;if("sebze"===e.productCode||"meyve"===e.productCode)continue;const a=e.quality||0,i=a>=75?"#00ff88":a>=50?"#ffaa00":a>=25?"#ff8800":"#ff4444";d+=`\n                <div class="glass-panel" style="padding:20px; border-radius:16px; border:1px solid ${t?"var(--primary)":"rgba(255,255,255,0.1)"};">\n                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:15px;">\n                        <div style="font-size:2rem;">${n.icon}</div>\n                        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:5px;">\n                            ${t?'<span style="background:var(--primary); color:black; font-size:0.6rem; padding:3px 8px; border-radius:10px; font-weight:900;">SÄ°STEM</span>':""}\n                            <span style="background:${i}22; color:${i}; font-size:0.6rem; padding:3px 8px; border-radius:10px; font-weight:700;">Kalite: %${a}</span>\n                        </div>\n                    </div>\n                    <h4 style="margin:0 0 5px 0;">${n.name}</h4>\n                    <div style="font-size:0.8rem; color:#888; margin-bottom:12px;">\n                        SatÄ±cÄ±: <span style="color:#fff;">${e.seller}</span> | Åehir: <span style="color:var(--secondary);">${e.city}</span>\n                    </div>\n                    <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; margin-bottom:15px; display:flex; justify-content:space-between;">\n                        <div>\n                            <div style="font-size:0.65rem; color:#888; text-transform:uppercase;">Mevcut Stok</div>\n                            <div style="font-size:1.1rem; font-weight:800;">${e.quantity.toLocaleString()} <span style="font-size:0.75rem; font-weight:400; color:#888;">${n.unit||"adet"}</span></div>\n                        </div>\n                        <div style="text-align:right;">\n                            <div style="font-size:0.65rem; color:#888; text-transform:uppercase;">Birim Fiyat</div>\n                            <div style="font-size:1.1rem; font-weight:800; color:var(--primary);">ğŸ’° ${e.pricePerUnit.toLocaleString()}</div>\n                        </div>\n                    </div>\n                    \n                    <div style="display:flex; gap:10px; margin-bottom:10px;">\n                        <input type="number" id="buy-qty-${e.id}" placeholder="Miktar" value="1" min="1" max="${e.quantity}" \n                            class="inp" style="margin:0; flex:1; text-align:center;">\n                    </div>\n\n                    <button onclick="const q = document.getElementById('buy-qty-${e.id}').value; buyMarketListing('${e.id}', '${e.city}', ${e.pricePerUnit}, q, '${n.name}', '${n.unit||"adet"}')" class="buy-btn" style="width:100%;">SatÄ±n Al</button>\n                </div>\n            `}if(s.innerHTML=d,r.pagination){const{currentPage:e,totalPages:n}=r.pagination;let t="";const a=(e,n=!1)=>`<button class="sub-tab-btn ${n?"active":""}" onclick="loadMarketListings(${e})" style="min-width:40px; margin:0 2px;">${e}</button>`,i=()=>'<button class="sub-tab-btn" disabled style="min-width:40px; margin:0 2px; opacity:0.5; cursor:default;">...</button>';if(n<=7)for(let i=1;i<=n;i++)t+=a(i,i===e);else{t+=a(1,1===e),e>4&&(t+=i());let r=Math.max(2,e-1),s=Math.min(n-1,e+1);e<=4&&(s=5),e>=n-3&&(r=n-4);for(let n=r;n<=s;n++)t+=a(n,n===e);e<n-3&&(t+=i()),t+=a(n,e===n)}o.innerHTML=t}}catch(e){showToast("Pazar yeri yÃ¼klenemedi!","error"),console.error("Marketplace error:",e)}}async function loadMyListings(){try{const e=await fetch("/api/marketplace/listings"),n=await e.json(),t=document.getElementById("my-listings-grid");if(!n.success)return void(t.innerHTML='<div style="grid-column:1/-1; text-align:center; padding:60px; opacity:0.5;"><p>Bir hata oluÅŸtu.</p></div>');const a=n.listings.filter(e=>e.seller===currentUser);if(0===a.length)return void(t.innerHTML='<div style="grid-column:1/-1; text-align:center; padding:60px; opacity:0.5;"><div style="font-size:4rem; margin-bottom:20px;">ğŸ“¦</div><p>HenÃ¼z ilanÄ±n yok. "Ä°lan Ver" sekmesinden ilan oluÅŸtur!</p></div>');let i="";for(const e of a){const n=productData[e.productCode]||{name:e.productCode,icon:"ğŸ“¦",unit:"adet"};i+=`\n                <div class="glass-panel" style="padding:20px; border-radius:16px; border:2px solid rgba(0,255,136,0.2);">\n                    <div style="font-size:2rem; text-align:center; margin-bottom:10px;">${n.icon}</div>\n                    <h4 style="margin:0 0 5px 0; text-align:center;">${n.name}</h4>\n                    <div style="text-align:center; margin-bottom:10px;">\n                        <span style="font-size:1.3rem; font-weight:700;">${e.quantity.toLocaleString()}</span> ${n.unit||"adet"}\n                    </div>\n                    <div style="text-align:center; color:#888; font-size:0.8rem; margin-bottom:5px;">\n                        Birim: ğŸ’° ${e.pricePerUnit.toLocaleString()}\n                    </div>\n                    <div style="text-align:center; font-size:1.1rem; font-weight:700; margin-bottom:15px; color:var(--primary);">\n                        Toplam: ğŸ’° ${e.totalPrice.toLocaleString()}\n                    </div>\n                    <button onclick="cancelMarketListing('${e.id}')" class="logout-btn" style="width:100%;">Ä°lanÄ± Ä°ptal Et</button>\n                </div>\n            `}t.innerHTML=i}catch(e){showToast("Ä°lanlarÄ±nÄ±z yÃ¼klenemedi!","error"),console.error("My listings error:",e)}}async function loadUserInventoryForListing(){try{const e=await fetch("/api/user/"+currentUser),n=await e.json(),t=n.user||n,a=document.getElementById("new-listing-product");a.innerHTML='<option value="">ÃœrÃ¼n SeÃ§</option>';const i=t.inventory||{};for(const[e,n]of Object.entries(i))if(n>0){const t=productData[e]||{name:e,unit:"adet"};a.innerHTML+=`<option value="${e}">${t.name} (${n.toLocaleString()} ${t.unit||"adet"})</option>`}}catch(e){console.error("Inventory load error:",e)}}async function createMarketListing(){const e=document.getElementById("new-listing-product").value,n=parseInt(document.getElementById("new-listing-quantity").value),t=parseInt(document.getElementById("new-listing-price").value);if(!e||!n||!t)return showToast("LÃ¼tfen tÃ¼m alanlarÄ± doldurun!","error");try{const a=await fetch("/api/marketplace/create-listing",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser,productCode:e,quantity:n,pricePerUnit:t,city:"AUTO"})}),i=await a.json();showToast(i.message||i.error,i.success?"success":"error"),i.success&&(document.getElementById("new-listing-quantity").value="",document.getElementById("new-listing-price").value="",document.getElementById("new-listing-product").value="",document.getElementById("listing-preview-qty").textContent="-",document.getElementById("listing-preview-unit").textContent="-",document.getElementById("listing-preview-total").textContent="0 ğŸ’°",switchMarketTab("my-listings"))}catch(e){showToast("Hata: "+e.message,"error")}}async function buyMarketListing(e,n,t,a,i,r){if(!currentUser)return showToast("GiriÅŸ yapmalÄ±sÄ±n!","error");const s=parseInt(a);if(isNaN(s)||s<=0)return showToast("GeÃ§ersiz miktar!","error");try{const a=await fetch(`/api/warehouse/info?username=${currentUser}`),o=await a.json();if(!o.success||!o.baseCity)return showToast("SatÄ±n alÄ±m yapabilmek iÃ§in Ã¶nce DEPO sekmesinden bir ANA ÃœS (Åehir) seÃ§melisin!","error");const d=o.baseCity,c=t*s,l=calculateCityDistance(n,d);let u=s/100;u<1&&(u=1);const m=Math.round(25*l*u),p=n===d?0:Math.max(500,m);if(!await showConfirm("ğŸ›’ SatÄ±n Alma OnayÄ±",`\n            <div style="text-align:left;">\n                <p><b>${s} ${r} ${i}</b></p>\n                <p>Birim Fiyat: ${t.toLocaleString()} ğŸ’°</p>\n                <p>ÃœrÃ¼n Toplam: <b>${c.toLocaleString()} ğŸ’°</b></p>\n                <p>Kargo (${n} â” ${d}): <b style="color:${p>0?"#ffa500":"#00ff88"};">${p>0?p.toLocaleString()+" ğŸ’°":"ÃœCRETSÄ°Z"}</b></p>\n                <hr style="border:1px solid rgba(255,255,255,0.1); margin:10px 0;">\n                <p>GENEL TOPLAM: <b style="font-size:1.2rem; color:var(--primary);">${(c+p).toLocaleString()} ğŸ’°</b></p>\n            </div>\n        `))return;const y=await fetch("/api/marketplace/buy-listing",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser,listingId:e,targetCity:d,buyQty:s})}),g=await y.json();g.success?(showToast(g.message||"SatÄ±n alma baÅŸarÄ±lÄ±!","success"),loadMarketListings(),loadProfile()):showToast(g.error||"Hata oluÅŸtu!","error")}catch(e){showToast("Hata: "+e.message,"error")}}async function cancelMarketListing(e){showConfirm("Ä°lan Ä°ptali","Ä°lanÄ± iptal etmek istediÄŸine emin misin? ÃœrÃ¼nler stokuna geri dÃ¶ner.").then(async n=>{if(n)try{const n=await fetch("/api/marketplace/cancel-listing",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser,listingId:e})}),t=await n.json();showToast(t.message||t.error,t.success?"success":"error"),t.success&&loadMyListings()}catch(e){showToast("Hata: "+e.message,"error")}})}async function renderDynamicTabs(){try{const e=await fetch("/api/shop-tabs"),n=await e.json();if(!n.success)return;const t=document.querySelector(".tabs-nav");if(!t)return;window.shopTabsConfig=n.tabs;const a=Object.entries(n.tabs).sort((e,n)=>(e[1].order||0)-(n[1].order||0));let i="";if(a.forEach(([e,n])=>{if(!n.enabled)return;const t=n.showNew?'\n                <span style="background:linear-gradient(90deg, #00ff88, #00ccff); color:black; font-size:0.6rem; padding:2px 6px; border-radius:4px; margin-left:8px; font-weight:800; box-shadow: 0 0 10px rgba(0,255,136,0.3); animation: pulse-new 2s infinite;">YENÄ°</span>\n            ':"";i+=`\n                <button class="tab-btn ${"career"===e?"active":""}" id="tab-btn-${e}" onclick="switchTab('${e}')">\n                    ${n.text} ${t}\n                </button>\n            `}),t.innerHTML=i,!document.getElementById("pulse-anim-style")){const e=document.createElement("style");e.id="pulse-anim-style",e.textContent="\n                @keyframes pulse-new {\n                    0% { transform: scale(1); filter: brightness(1); }\n                    50% { transform: scale(1.05); filter: brightness(1.2); }\n                    100% { transform: scale(1); filter: brightness(1); }\n                }\n            ",document.head.appendChild(e)}}catch(e){console.error("Tabs error:",e)}}async function loadWarehouseInfo(){try{const e=await fetch("/api/warehouse/info?username="+currentUser),n=await e.json();if(n.success){const e=n.level||1,t=n.capacity||5e3,a=n.currentUsage||0,i=n.baseCity,r=n.nextLevelCost||0,s=document.getElementById("warehouse-level"),o=document.getElementById("warehouse-capacity"),d=document.getElementById("warehouse-base-container"),c=document.getElementById("warehouse-upgrade-btn");if(s&&(s.textContent=e),o&&(o.textContent=`${a.toLocaleString()} / ${t.toLocaleString()}`),d)if(i)d.innerHTML=`<div style="padding:20px; background:linear-gradient(135deg, rgba(0,255,136,0.1), rgba(0,0,0,0.3)); border-radius:12px; border:1px solid rgba(0,255,136,0.3); display:flex; align-items:center; gap:15px; box-shadow:0 4px 15px rgba(0,255,136,0.1);">\n                        <div style="font-size:2.5rem; background:rgba(0,0,0,0.3); width:60px; height:60px; display:flex; align-items:center; justify-content:center; border-radius:50%;">ğŸ“</div>\n                        <div>\n                            <div style="font-size:0.75rem; color:var(--primary); font-weight:700; text-transform:uppercase; letter-spacing:1px; margin-bottom:5px;">MERKEZ LOJÄ°STÄ°K ÃœSSÃœ</div>\n                            <div style="font-size:1.8rem; font-weight:900; color:white; line-height:1;">${i}</div>\n                            <div style="font-size:0.85rem; color:#aaa; margin-top:5px;">TÃ¼m kargo operasyonlarÄ± bu merkezden yÃ¶netiliyor.</div>\n                        </div>\n                    </div>`;else{const e=EMLAK_CITIES.sort((e,n)=>e.name.localeCompare(n.name,"tr"));let n="";e.forEach(e=>{n+=`\n                            <div class="city-select-card" onclick="selectBaseCityCard('${e.name}', this)" \n                                 style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:8px; padding:10px; cursor:pointer; text-align:center; transition:all 0.2s; min-height:80px; display:flex; flex-direction:column; justify-content:center; align-items:center;">\n                                <div style="font-size:1.2rem; margin-bottom:5px;">ğŸ™ï¸</div>\n                                <div style="font-weight:600; font-size:0.85rem;">${e.name}</div>\n                            </div>\n                         `});const t=EMLAK_CITIES.sort((e,n)=>e.name.localeCompare(n.name,"tr")).map(e=>`<option value="${e.name}">${e.name}</option>`).join("");d.innerHTML=`\n                        <div style="background:rgba(255,255,255,0.05); padding:20px; border-radius:12px; text-align:center;">\n                            <div style="font-size:3rem; margin-bottom:15px;">ğŸ—ï¸</div>\n                            <h3 style="margin-bottom:10px;">Merkez Lojistik ÃœssÃ¼nÃ¼ Kur</h3>\n                            <p style="color:#aaa; font-size:0.9rem; margin-bottom:20px;">\n                                Depolama ve daÄŸÄ±tÄ±m aÄŸÄ±nÄ± yÃ¶netmek iÃ§in bir ÅŸehir seÃ§melisin.<br>\n                                <span style="color:#f39c12; font-size:0.8rem;">(DÄ°KKAT: Bu seÃ§im kalÄ±cÄ±dÄ±r!)</span>\n                            </p>\n                            \n                            <div style="display:flex; gap:10px; justify-content:center; max-width:400px; margin:0 auto;">\n                                <select id="base-city-select" class="borsa-input" style="flex:1; padding:12px; font-size:1rem; border-radius:8px;">\n                                    <option value="" disabled selected>Åehir SeÃ§iniz...</option>\n                                    ${t}\n                                </select>\n                                <button onclick="saveBaseCity()" class="buy-btn" style="width:120px; border-radius:8px;">KUR</button>\n                            </div>\n                        </div>\n                    `}c&&(r>0?(c.innerHTML=`YÃœKSELT <span style="font-size:0.8em; opacity:0.8;">(${r.toLocaleString()} ğŸ’°)</span>`,c.disabled=!1,c.onclick=()=>upgradeWarehouse(r)):(c.innerHTML="MAKSÄ°MUM SEVÄ°YE",c.disabled=!0,c.onclick=null));const l=document.getElementById("warehouse-inventory-list"),u=n.inventory||[];if(l)if(0===u.length)l.innerHTML='\n                        <div style="text-align:center; padding:30px; color:#888;">\n                            <div style="font-size:3rem; margin-bottom:10px;">ğŸ“­</div>\n                            <div>Depoda henÃ¼z Ã¼rÃ¼n yok</div>\n                        </div>\n                    ';else{let e='<div style="display:grid; gap:10px;">';for(const n of u){const t=n.quality>=80?"#4ade80":n.quality>=60?"#60a5fa":n.quality>=40?"#fbbf24":n.quality>=20?"#f97316":"#ef4444";e+=`\n                            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; background:rgba(255,255,255,0.05); border-radius:8px; border:1px solid rgba(255,255,255,0.1);">\n                                <div style="display:flex; align-items:center; gap:10px;">\n                                    <span style="font-size:1.5rem;">${n.icon}</span>\n                                    <div>\n                                        <div style="font-weight:600;">${n.name}</div>\n                                        <div style="font-size:0.8rem; color:${t};">Kalite: %${n.quality}</div>\n                                    </div>\n                                </div>\n                                <div style="text-align:right;">\n                                    <div style="font-size:1.2rem; font-weight:700;">${n.amount.toLocaleString()}</div>\n                                    <div style="font-size:0.75rem; color:#888;">adet</div>\n                                </div>\n                            </div>\n                        `}e+="</div>",l.innerHTML=e}}}catch(e){console.error("Depo yÃ¼kleme hatasÄ±:",e)}}async function saveBaseCity(){const e=document.getElementById("base-city-select");if(!e||!e.value)return showToast("LÃ¼tfen bir ÅŸehir seÃ§in!","error");const n=e.value;if(await showConfirm(`\n        <h3>Merkez Ãœs: ${n}</h3>\n        <p>Depo merkezinizi <b>${n}</b> ÅŸehrine kurmak Ã¼zeresiniz.</p>\n        <p style="color:#f39c12; margin-top:10px; font-size:0.9rem;">Bu iÅŸlem geri alÄ±namaz!</p>\n    `))try{const e=await fetch("/api/warehouse/set-base",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser,city:n})}),t=await e.json();t.success?(showToast("Merkez Ã¼s baÅŸarÄ±yla kuruldu!","success"),loadWarehouseInfo()):showToast(t.error||"Hata oluÅŸtu","error")}catch(e){console.error(e),showToast("BaÄŸlantÄ± hatasÄ±","error")}}async function upgradeWarehouse(e){showConfirm("Depo YÃ¼kseltme",`Depoyu yÃ¼kseltmek iÃ§in ${e?.toLocaleString()} ğŸ’° Ã¶demeyi onaylÄ±yor musun?`).then(async e=>{if(e)try{const e=await fetch("/api/warehouse/upgrade",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser})}),n=await e.json();showToast(n.message||n.error,n.success?"success":"error"),n.success&&(loadWarehouseInfo(),loadProfile())}catch(e){showToast("Hata: "+e.message,"error")}})}async function loadRnDUpgrades(){try{const e=await getUserData(),n=e.inventory||{},t=e.researchQualities||{},a=document.getElementById("rnd-upgrades-container");let i="";const r=Object.entries(n).filter(([e,n])=>n>0);if(0===r.length)return void(a.innerHTML='<div style="grid-column:1/-1; text-align:center; padding:60px; opacity:0.5;"><p>Deponuzda Ã¼rÃ¼n bulunmuyor. AR-GE yapabilmek iÃ§in Ã¶nce Ã¼rÃ¼n stoklamalÄ±sÄ±nÄ±z!</p></div>');for(const[e,n]of r){const a=productData[e]||{name:e,icon:"ğŸ“¦"},r=t[e]||0,s=5,o=5e4+2e3*r,d=18e5+10*r*60*1e3,c=Math.floor(d/36e5),l=Math.floor(d%36e5/6e4),u=c>0?`${c}s ${l}dk`:`${l} dk`,m=r>=100;i+=`\n                <div class="glass-panel" style="padding:20px; border-radius:16px; border:1px solid rgba(255,255,255,0.05);">\n                    <div style="font-size:2.5rem; text-align:center; margin-bottom:10px;">${a.icon}</div>\n                    <h4 style="margin:0 0 5px 0; text-align:center;">${a.name}</h4>\n                    <p style="font-size:0.8rem; color:#888; text-align:center; margin-bottom:10px;">Stokta: ${n} adet</p>\n                    <div style="text-align:center; margin-bottom:15px;">\n                        <div style="font-size:0.75rem; color:#aaa; text-transform:uppercase;">Mevcut Kalite</div>\n                        <div style="font-size:1.8rem; font-weight:800; color:var(--secondary);">%${r}</div>\n                    </div>\n                    ${m?'<div style="text-align:center; color:var(--primary); font-weight:700;">âœ… MAKSÄ°MUM</div>':`<div style="text-align:center; margin-bottom:10px;">\n                        <span style="font-size:0.75rem; color:#888;">â±ï¸ SÃ¼re: <b style="color:#fff;">${u}</b></span>\n                    </div>\n                    <button onclick="buyRnDUpgrade('${e}', ${o}, '${u}')" class="buy-btn" style="width:100%;">ğŸ§¬ %${r+s} Yap (ğŸ’° ${o.toLocaleString()})</button>`}\n                </div>\n            `}a.innerHTML=i}catch(e){console.error("R&D load error:",e),document.getElementById("rnd-upgrades-container").innerHTML='<div style="grid-column:1/-1; text-align:center; padding:60px; opacity:0.5;"><p>YÃ¼klenemedi.</p></div>'}}async function buyRnDUpgrade(e,n,t){if(await showConfirm("ğŸ§¬ AR-GE AraÅŸtÄ±rmasÄ±",`\n        <div style="text-align:left;">\n            <p>Bu Ã¼rÃ¼nÃ¼n kalitesini <b>%5</b> artÄ±rmak istiyorsun.</p>\n            <hr style="border-color:rgba(255,255,255,0.1); margin:10px 0;">\n            <p>ğŸ’° Maliyet: <b>${n?.toLocaleString()||"?"}</b></p>\n            <p>â±ï¸ SÃ¼re: <b>${t||"?"}</b></p>\n            <p style="font-size:0.8rem; color:#888; margin-top:10px;">AraÅŸtÄ±rma sÃ¼resi boyunca baÅŸka araÅŸtÄ±rma baÅŸlatamazsÄ±n.</p>\n        </div>\n    `))try{const n=await fetch("/api/arge/upgrade-quality",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:currentUser,productCode:e})}),t=await n.json();showToast(t.message||t.error,t.success?"success":"error"),t.success&&loadRnDUpgrades()}catch(e){showToast("Hata: "+e.message,"error")}}function calculateCityDistance(e,n){if(!e||!n)return 500;if(e===n)return 0;const t=e=>CLIENT_CITIES.find(n=>n.name===e||n.id===e.toUpperCase()||n.name.toLowerCase()===e.toLowerCase()),a=t(e),i=t(n);if(!a||!i)return 500;const r=16*(i.x-a.x),s=6*(i.y-a.y);return Math.round(Math.sqrt(r*r+s*s))}