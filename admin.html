<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AloskeGangBOT | Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0c;
            --card: #151518;
            --primary: #00ff88;
            --secondary: #00e1ff;
            --danger: #ff4a4a;
            --text: #ffffff;
            --muted: #888;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            overflow-x: hidden;
        }

        /* Login */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: 0.5s;
        }

        .login-box {
            background: var(--card);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 350px;
            text-align: center;
        }

        .login-box h2 {
            margin-bottom: 20px;
            color: var(--primary);
        }

        .inp {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            background: #000;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            text-align: center;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: 800;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn:hover {
            transform: scale(1.05);
            filter: brightness(1.2);
        }

        .btn-danger {
            background: var(--danger);
            color: #fff;
        }

        /* Dashboard */
        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            display: none;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        .tab-btn {
            background: none;
            border: none;
            color: var(--muted);
            font-size: 1.1rem;
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 8px;
            transition: 0.3s;
        }

        .tab-btn.active {
            background: rgba(0, 255, 136, 0.1);
            color: var(--primary);
            font-weight: 600;
        }

        /* Content Sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Channel Cards */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--card);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #222;
        }

        .card h3 {
            color: var(--secondary);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: var(--primary);
            border-radius: 50%;
            display: inline-block;
        }

        .toggle-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .toggle-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.9rem;
            background: #000;
            padding: 8px;
            border-radius: 5px;
        }

        /* Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--primary);
        }

        input:checked+.slider:before {
            transform: translateX(14px);
        }

        /* User Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            text-align: left;
            padding: 15px;
            border-bottom: 1px solid #222;
        }

        th {
            color: var(--muted);
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .action-btn {
            padding: 5px 10px;
            font-size: 0.8rem;
            width: auto;
        }
    </style>
</head>

<body>

    <!-- AUTH -->
    <div id="login-overlay">
        <div class="login-box">
            <h2>üîê G√úVENLƒ∞K</h2>
            <input type="password" id="adminKey" class="inp" placeholder="Admin Anahtarƒ±">
            <button class="btn" onclick="login()">Gƒ∞Rƒ∞≈û YAP</button>
            <p id="error-log" style="color:var(--danger); margin-top:10px;"></p>
        </div>
    </div>

    <!-- MAIN PANEL -->
    <div class="container" id="admin-panel">
        <header>
            <h1>AloskeGang<span style="color:var(--primary)">BOT</span></h1>
            <button class="btn btn-danger" style="width: auto;" onclick="location.reload()">√áIKI≈û</button>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('channels')">üì° Kanallar</button>
            <button class="tab-btn" onclick="showTab('users')">üë• Kullanƒ±cƒ±lar</button>
            <button class="tab-btn" onclick="showTab('troll')">ü§° Troll & Aksiyon</button>
            <button class="tab-btn" onclick="showTab('global')">‚öôÔ∏è Genel</button>
        </div>

        <!-- CHANNEL MANAGEMENT -->
        <div id="channels" class="section active">
            <div class="grid" id="channel-list">
                <!-- Kanallar Burada Listelenecek (JS ile) -->
                <p>Kanallar y√ºkleniyor...</p>
            </div>
        </div>

        <!-- USERS MANAGEMENT -->
        <div id="users" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; gap:10px;">
                <h2 style="margin:0;">üë§ Kullanƒ±cƒ± Y√∂netimi (Son 1000)</h2>
                <div style="display:flex; gap:10px; flex:1; max-width:400px;">
                    <input type="text" id="usersearch" placeholder="Kullanƒ±cƒ± Ara..." class="inp"
                        style="margin:0; height:35px;" oninput="filterUsers()">
                    <button class="btn" style="width: auto; height:35px;" onclick="loadUsers()">üîÑ Yenile</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Kullanƒ±cƒ±</th>
                            <th>Bakiye</th>
                            <th>Son G√∂r√ºlme</th>
                            <th>ƒ∞≈ülem</th>
                        </tr>
                    </thead>
                    <tbody id="user-list"></tbody>
                </table>
            </div>
        </div>

        <!-- TROLL & ACTION -->
        <div id="troll" class="section">
            <div class="main-grid">

                <div class="panel">
                    <h2>üíå Rigged Ship (A≈ük Ayarla)</h2>
                    <input type="text" id="rigUser" class="inp" placeholder="Kullanƒ±cƒ± (√ñrn: omegacyr)">
                    <input type="text" id="rigTarget" class="inp" placeholder="Partner (√ñrn: adrianalima)">
                    <input type="number" id="rigPercent" class="inp" placeholder="Y√ºzde (0-100)" value="100">
                    <button class="btn" onclick="setRigShip()">AYARLA</button>
                </div>

                <div class="panel">
                    <h2>üé∞ Kumar Sonucu Ayarla</h2>
                    <input type="text" id="gambleUser" class="inp" placeholder="Kullanƒ±cƒ± Adƒ±">
                    <div style="display:flex; gap:10px;">
                        <button class="btn" style="background:var(--primary)" onclick="setGamble('win')">KAZANSIN
                            ü§ë</button>
                        <button class="btn btn-danger" onclick="setGamble('lose')">KAYBETSƒ∞N üìâ</button>
                    </div>
                </div>

                <div class="panel" style="grid-column: span 2;">
                    <h2>üõ°Ô∏è Chat ƒ∞≈ülemleri (T√ºm Kanallar)</h2>
                    <p style="color:#666; font-size:0.8rem; margin-bottom:15px">Aktif olan ilk kanalda i≈ülem yapar.</p>
                    <div style="display:flex; gap:10px;">
                        <button class="btn" onclick="chatAction('clear')">Temizle (Clear)</button>
                        <button class="btn" onclick="chatAction('slow')">Slow Mod (10s)</button>
                        <button class="btn" onclick="chatAction('slowoff')">Slow Mod Kapat</button>
                    </div>
                </div>

            </div>
        </div>

        <div id="global" class="section">
            <div class="card">
                <h3>üì¢ Kanal Duyurusu</h3>
                <p style="margin-bottom:10px; color:#888;">Se√ßili kanala mesaj g√∂nder.</p>
                <select id="targetChannel" class="inp" style="margin-bottom:10px;">
                    <option value="">Kanal Se√ßin...</option>
                </select>
                <textarea id="channelMsg" class="inp" style="height:100px; resize:none"
                    placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..."></textarea>
                <button class="btn" onclick="sendToChannel()">MESAJ G√ñNDER</button>
            </div>
        </div>
    </div>

    <!-- BAN STATS MODAL -->
    <div id="banModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div class="card" style="width:400px; max-width:90%;">
            <h3 style="margin-bottom:15px; color:var(--primary);">üö´ Ban Detaylarƒ±</h3>
            <div id="banModalContent" style="margin-bottom:20px; color:#ddd; font-size:0.9rem;"></div>
            <button class="btn" onclick="document.getElementById('banModal').style.display='none'">KAPAT</button>
        </div>
    </div>

    <script>
        let sessionKey = "";
        let allUsers = {};
        const COMMANDS = ['slot', 'yazitura', 'kutu', 'duello', 'soygun', 'fal', 'ship', 'hava', 'zenginler'];

        async function login() {
            const key = document.getElementById('adminKey').value;
            const res = await fetch('/admin-api/check', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key })
            });
            const data = await res.json();
            if (data.success) {
                sessionKey = key;
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                loadChannels();
                loadUsers();
            } else {
                document.getElementById('error-log').innerText = "Hatalƒ± Anahtar!";
            }
        }

        function showTab(id) {
            document.querySelectorAll('.section').forEach(d => d.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        let cachedUsers = {};

        async function loadUsers() {
            const res = await fetch('/admin-api/all-users', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key: sessionKey })
            });
            cachedUsers = await res.json();
            renderUsers(cachedUsers);
        }

        function filterUsers() {
            const search = document.getElementById('usersearch').value.toLowerCase().trim();
            if (!search) {
                renderUsers(cachedUsers);
                return;
            }
            const filtered = {};
            Object.entries(cachedUsers).forEach(([username, data]) => {
                if (username.toLowerCase().includes(search)) {
                    filtered[username] = data;
                }
            });
            renderUsers(filtered);
        }

        function renderUsers(users) {
            const list = document.getElementById('user-list');
            list.innerHTML = "";

            // Bakiyeye g√∂re sƒ±rala (Azalan)
            const sortedUsers = Object.entries(users).sort((a, b) => (b[1].balance || 0) - (a[1].balance || 0));

            sortedUsers.forEach(([username, data]) => {
                const date = data.last_seen ? new Date(data.last_seen).toLocaleDateString('tr-TR') : '-';
                list.innerHTML += `
                    <tr>
                        <td><b>${username}</b></td>
                        <td>${(data.balance || 0).toLocaleString()} üí∞</td>
                        <td>${date}</td>
                        <td>
                            <button class="btn" style="padding:4px 8px; font-size:0.75rem; background:#222;" onclick="editBalance('${username}', ${data.balance || 0})">üí∞</button>
                            <button class="btn" style="padding:4px 8px; font-size:0.75rem; background:#555;" onclick="showBanStats('${username}')">üö´</button>
                            <button class="btn btn-danger" style="padding:4px 8px; font-size:0.75rem;" onclick="resetUser('${username}')">üîÑ</button>
                        </td>
                    </tr>
                `;
            });

            if (Object.keys(users).length === 0) {
                list.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#666; padding:20px;">Kullanƒ±cƒ± bulunamadƒ±.</td></tr>';
            }
        }

        async function loadChannels() {
            const res = await fetch('/admin-api/channels', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: sessionKey })
            });
            const channels = await res.json();
            const container = document.getElementById('channel-list');
            container.innerHTML = "";

            if (Object.keys(channels).length === 0) {
                container.innerHTML = "<p>Hi√ßbir kanal baƒülƒ± deƒüil.</p>";
                return;
            }

            // Kanal dropdown'unu doldur (Global sekmesi i√ßin)
            const dropdown = document.getElementById('targetChannel');
            dropdown.innerHTML = '<option value="">Kanal Se√ßin...</option>';

            for (const [id, data] of Object.entries(channels)) {
                // Dropdown'a ekle
                dropdown.innerHTML += `<option value="${id}">${data.username || id}</option>`;

                let toggles = "";
                COMMANDS.forEach(cmd => {
                    const isChecked = data.settings && data.settings[cmd] !== false ? "checked" : "";
                    toggles += `
                        <div class="toggle-item">
                            <span>!${cmd}</span>
                            <label class="switch">
                                <input type="checkbox" ${isChecked} onchange="toggleCmd('${id}', '${cmd}', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                    `;
                });

                // WinRate Sliders (Varsayƒ±lan deƒüerler)
                const wrSlot = data.settings && data.settings.wr_slot ? data.settings.wr_slot : 30;
                const wrYazitura = data.settings && data.settings.wr_yazitura ? data.settings.wr_yazitura : 50;
                const wrKutu = data.settings && data.settings.wr_kutu ? data.settings.wr_kutu : 40;
                const wrSoygun = data.settings && data.settings.wr_soygun ? data.settings.wr_soygun : 40;
                const soygunReward = data.settings && data.settings.soygun_reward ? data.settings.soygun_reward : 30000;
                const slotLimit = data.settings && data.settings.slot_limit ? data.settings.slot_limit : 10;
                const soygunLimit = data.settings && data.settings.soygun_limit ? data.settings.soygun_limit : 3;

                const ttsCost = data.settings && data.settings.tts_cost ? data.settings.tts_cost : 2500;
                const soundCost = data.settings && data.settings.sound_cost ? data.settings.sound_cost : 1000;
                const muteCost = data.settings && data.settings.mute_cost ? data.settings.mute_cost : 10000;
                const dailyRew = data.settings && data.settings.daily_reward ? data.settings.daily_reward : 500;
                const passiveRew = data.settings && data.settings.passive_reward ? data.settings.passive_reward : 100;

                const ttsVol = data.settings && data.settings.tts_volume !== undefined ? data.settings.tts_volume : 100;
                const soundVol = data.settings && data.settings.sound_volume !== undefined ? data.settings.sound_volume : 80;

                const mSlot3 = data.settings && data.settings.slot_mult_3 ? data.settings.slot_mult_3 : 5;
                const mSlot2 = data.settings && data.settings.slot_mult_2 ? data.settings.slot_mult_2 : 1.5;
                const mYT = data.settings && data.settings.yt_mult ? data.settings.yt_mult : 2;
                const mKutu = data.settings && data.settings.kutu_mult ? data.settings.kutu_mult : 3;

                const overlayUrl = `${window.location.origin}/overlay?key=${data.overlay_key || 'YOK'}`;

                const html = `
                    <div class="card">
                        <h3>${data.username} <span class="status-dot"></span></h3>
                        <p style="font-size:0.8rem; color:#666;">ID: ${id}</p>

                        <div style="margin: 15px 0; padding:10px; background:#000; border:1px solid #333; border-radius:8px;">
                            <h4 style="margin-bottom:10px; color:var(--primary); font-size:0.9rem;">üîó Overlay Linki</h4>
                            <input type="text" readonly value="${overlayUrl}" class="inp" 
                                style="margin:0; font-size:0.7rem; color:var(--muted); height:30px;" onclick="this.select(); document.execCommand('copy'); alert('Kopyalandƒ±!')">
                            <button class="btn action-btn" style="width:100%; margin-top:5px; height:25px; padding:0; font-size:0.7rem;" 
                                onclick="resetOverlayKey('${id}')">YENƒ∞ ANAHTAR OLU≈ûTUR</button>
                        </div>

                        <div style="margin: 15px 0; padding:10px; background:#000; border:1px solid #333; border-radius:8px;">
                            <h4 style="margin-bottom:10px; color:var(--primary); font-size:0.9rem;">üí∞ Toplu Para Daƒüƒ±t</h4>
                            <div style="display:flex; gap:5px;">
                                <input type="number" id="dist-amt-${id}" placeholder="Miktar (√ñrn: 1000)" class="inp" 
                                    style="margin:0; font-size:0.7rem; height:30px; flex:1;">
                                <button class="btn" style="width:60px; height:30px; padding:0; font-size:0.7rem;" 
                                    onclick="distributeBalance('${id}')">G√ñNDER</button>
                            </div>
                        </div>
                        
                        <div style="margin: 15px 0; padding:10px; background:#f0f0f0; border-radius:8px;">
                            <h4 style="margin-bottom:10px; color:#333; font-size:0.9rem;">üé∞ Kazanma Oranlarƒ± (%)</h4>
                            
                            <div style="margin-bottom:8px;">
                                <label style="font-size:0.8rem;">Slot: %<span id="val-slot-${id}">${wrSlot}</span></label>
                                <input type="range" class="inp" min="0" max="100" value="${wrSlot}" 
                                    oninput="document.getElementById('val-slot-${id}').innerText = this.value"
                                    onchange="toggleCmd('${id}', 'wr_slot', parseInt(this.value))">
                            </div>

                            <div style="margin-bottom:8px;">
                                <label style="font-size:0.8rem;">Yazƒ± Tura: %<span id="val-yt-${id}">${wrYazitura}</span></label>
                                <input type="range" class="inp" min="0" max="100" value="${wrYazitura}" 
                                    oninput="document.getElementById('val-yt-${id}').innerText = this.value"
                                    onchange="toggleCmd('${id}', 'wr_yazitura', parseInt(this.value))">
                            </div>

                            <div style="margin-bottom:8px;">
                                <label style="font-size:0.8rem;">Kutu: %<span id="val-kutu-${id}">${wrKutu}</span></label>
                                <input type="range" class="inp" min="0" max="100" value="${wrKutu}" 
                                    oninput="document.getElementById('val-kutu-${id}').innerText = this.value"
                                    onchange="toggleCmd('${id}', 'wr_kutu', parseInt(this.value))">
                            </div>

                            <div style="margin-bottom:8px;">
                                <label style="font-size:0.8rem;">Soygun: %<span id="val-soy-${id}">${wrSoygun}</span></label>
                                <input type="range" class="inp" min="0" max="100" value="${wrSoygun}" 
                                    oninput="document.getElementById('val-soy-${id}').innerText = this.value"
                                    onchange="toggleCmd('${id}', 'wr_soygun', parseInt(this.value))">
                            </div>

                            <div style="margin-bottom:8px;">
                                <label style="font-size:0.8rem;">Soygun Toplam √ñd√ºl: <span id="val-soy-rew-${id}">${soygunReward.toLocaleString()}</span> üí∞</label>
                                <input type="number" class="inp" value="${soygunReward}" step="1000"
                                    style="margin-top:5px; height:35px; background:#000; border-color:#333;"
                                    onchange="toggleCmd('${id}', 'soygun_reward', parseInt(this.value)); document.getElementById('val-soy-rew-${id}').innerText = parseInt(this.value).toLocaleString()">
                            </div>

                            <h4 style="margin: 15px 0 10px 0; color:#333; font-size:0.9rem;">üö´ Saatlik Limitler</h4>

                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                <div>
                                    <label style="font-size:0.75rem;">Slot Limiti:</label>
                                    <input type="number" class="inp" value="${slotLimit}" min="1" max="100"
                                        style="height:35px; background:#000; border-color:#333;"
                                        onchange="toggleCmd('${id}', 'slot_limit', parseInt(this.value))">
                                </div>
                                <div>
                                    <label style="font-size:0.75rem;">Soygun Limiti:</label>
                                    <input type="number" class="inp" value="${soygunLimit}" min="1" max="24"
                                        style="height:35px; background:#000; border-color:#333;"
                                        onchange="toggleCmd('${id}', 'soygun_limit', parseInt(this.value))">
                                </div>
                                <div>
                                    <label style="font-size:0.75rem;">Ses √úcreti:</label>
                                    <input type="number" class="inp" value="${soundCost}" step="100"
                                        style="height:35px; background:#000; border-color:#333;"
                                        onchange="toggleCmd('${id}', 'sound_cost', parseInt(this.value))">
                                </div>
                                <div>
                                    <label style="font-size:0.75rem;">Sustur √úcreti:</label>
                                    <input type="number" class="inp" value="${muteCost}" step="500"
                                        style="height:35px; background:#000; border-color:#333;"
                                        onchange="toggleCmd('${id}', 'mute_cost', parseInt(this.value))">
                                </div>
                                <div>
                                    <label style="font-size:0.75rem;">G√ºnl√ºk √ñd√ºl:</label>
                                    <input type="number" class="inp" value="${dailyRew}" step="100"
                                        style="height:35px; background:#000; border-color:#333;"
                                        onchange="toggleCmd('${id}', 'daily_reward', parseInt(this.value))">
                                </div>
                                <div style="grid-column: span 2;">
                                    <label style="font-size:0.75rem;">Pasif Gelir (10dk):</label>
                                    <input type="number" class="inp" value="${passiveRew}" step="10"
                                        style="height:35px; background:#000; border-color:#333;"
                                        onchange="toggleCmd('${id}', 'passive_reward', parseInt(this.value))">
                                </div>
                            </div>

                            <h4 style="margin: 15px 0 10px 0; color:#333; font-size:0.9rem;">üìà Kazan√ß √áarpanlarƒ±</h4>
                            
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                <div>
                                    <label style="font-size:0.75rem;">Slot 3'l√º:</label>
                                    <input type="number" class="inp" value="${mSlot3}" step="0.5" 
                                        style="height:30px; padding:5px; background:#000; border-color:#333;"
                                        onchange="toggleCmd('${id}', 'slot_mult_3', parseFloat(this.value))">
                                </div>
                                <div>
                                    <label style="font-size:0.75rem;">Slot 2'li:</label>
                                    <input type="number" class="inp" value="${mSlot2}" step="0.1" 
                                        style="height:30px; padding:5px; background:#000; border-color:#333;"
                                        onchange="toggleCmd('${id}', 'slot_mult_2', parseFloat(this.value))">
                                </div>
                                <div>
                                    <label style="font-size:0.75rem;">Yazƒ±-Tura:</label>
                                    <input type="number" class="inp" value="${mYT}" step="0.1" 
                                        style="height:30px; padding:5px; background:#000; border-color:#333;"
                                        onchange="toggleCmd('${id}', 'yt_mult', parseFloat(this.value))">
                                </div>
                                <div>
                                    <label style="font-size:0.75rem;">Kutu Win:</label>
                                    <input type="number" class="inp" value="${mKutu}" step="0.5" 
                                        style="height:30px; padding:5px; background:#000; border-color:#333;"
                                        onchange="toggleCmd('${id}', 'kutu_mult', parseFloat(this.value))">
                                </div>
                            </div>

                            <h4 style="margin: 15px 0 10px 0; color:#333; font-size:0.9rem;">üíé Etkile≈üim √úcretleri</h4>

                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                <div>
                                    <label style="font-size:0.75rem;">TTS √úcreti:</label>
                                    <input type="number" class="inp" value="${ttsCost}" step="100"
                                        style="height:35px; background:#000; border-color:#333;"
                                        onchange="toggleCmd('${id}', 'tts_cost', parseInt(this.value))">
                                </div>
                                <div>
                                    <label style="font-size:0.75rem;">Sustur √úcreti:</label>
                                    <input type="number" class="inp" value="${muteCost}" step="500"
                                        style="height:35px; background:#000; border-color:#333;"
                                        onchange="toggleCmd('${id}', 'mute_cost', parseInt(this.value))">
                                </div>
                                <div>
                                    <label style="font-size:0.75rem;">G√ºnl√ºk √ñd√ºl:</label>
                                    <input type="number" class="inp" value="${dailyRew}" step="100"
                                        style="height:35px; background:#000; border-color:#333;"
                                        onchange="toggleCmd('${id}', 'daily_reward', parseInt(this.value))">
                                </div>
                                <div>
                                    <label style="font-size:0.75rem;">Pasif Gelir (10dk):</label>
                                    <input type="number" class="inp" value="${passiveRew}" step="10"
                                        style="height:35px; background:#000; border-color:#333;"
                                        onchange="toggleCmd('${id}', 'passive_reward', parseInt(this.value))">
                                </div>
                            </div>

                            <h4 style="margin: 15px 0 10px 0; color:#333; font-size:0.9rem;">üîä Ses Seviyeleri</h4>
                            
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                                <div>
                                    <label style="font-size:0.75rem;">TTS Sesi: %<span id="val-tts-vol-${id}">${ttsVol}</span></label>
                                    <input type="range" min="0" max="100" value="${ttsVol}" 
                                        oninput="document.getElementById('val-tts-vol-${id}').innerText = this.value"
                                        onchange="toggleCmd('${id}', 'tts_volume', parseInt(this.value))" style="width:100%;">
                                </div>
                                <div>
                                    <label style="font-size:0.75rem;">Ses Efekti: %<span id="val-snd-vol-${id}">${soundVol}</span></label>
                                    <input type="range" min="0" max="100" value="${soundVol}" 
                                        oninput="document.getElementById('val-snd-vol-${id}').innerText = this.value"
                                        onchange="toggleCmd('${id}', 'sound_volume', parseInt(this.value))" style="width:100%;">
                                </div>
                            </div>

                            <h4 style="margin: 15px 0 10px 0; color:#333; font-size:0.9rem;">üîä Ses Y√∂netimi</h4>
                            <div id="sound-list-${id}" style="font-size:0.8rem; background:#000; padding:10px; border-radius:8px; margin-bottom:10px; max-height:150px; overflow-y:auto;">
                                <!-- Sesler JS ile dolacak -->
                            </div>
                            <div style="display:grid; gap:5px; margin-bottom:10px;">
                                <div style="display:flex; gap:5px;">
                                    <input type="text" id="snd-name-${id}" placeholder="Komut (√∂rn: gol)" class="inp" style="margin:0; height:30px; font-size:0.7rem; flex:1;">
                                    <input type="number" id="snd-cost-${id}" placeholder="√úcret" class="inp" style="margin:0; height:30px; width:70px; font-size:0.7rem;">
                                </div>
                                <div style="display:flex; gap:5px;">
                                    <input type="text" id="snd-url-${id}" placeholder="MP3 URL veya Dosya Y√ºkle" class="inp" style="margin:0; height:30px; font-size:0.7rem; flex:1;">
                                    <input type="file" id="snd-file-${id}" style="display:none;" onchange="uploadSoundFile('${id}')" accept="audio/*">
                                    <button class="btn" style="width:30px; height:30px; padding:0; background:#333; border:1px solid #444;" onclick="document.getElementById('snd-file-${id}').click()">üìÇ</button>
                                    <button class="btn" style="width:40px; height:30px; padding:0;" onclick="addSound('${id}')">EKLE</button>
                                </div>
                            </div>
                        </div>

                        <div class="toggle-group">
                            ${toggles}
                        </div>
                        <button class="btn btn-danger action-btn" style="margin-top:15px; width:100%" onclick="deleteChannel('${id}')">BAƒûLANTIYI KES (Sƒ∞L)</button>
                    </div>
                `;
                container.innerHTML += html;
                renderSoundList(id, data.settings?.custom_sounds || {});
            }
        }

        function renderSoundList(channelId, sounds) {
            const container = document.getElementById(`sound-list-${channelId}`);
            if (!container) return;
            container.innerHTML = "";
            Object.entries(sounds).forEach(([name, data]) => {
                container.innerHTML += `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px; padding-bottom:5px; border-bottom:1px solid #222;">
                        <span>!ses ${name} (${data.cost} üí∞)</span>
                        <button onclick="removeSound('${channelId}', '${name}')" style="background:none; border:none; color:var(--danger); cursor:pointer;">‚úñ</button>
                    </div>
                `;
            });
            if (Object.keys(sounds).length === 0) container.innerHTML = "<p style='color:#555;'>Ses eklenmemi≈ü.</p>";
        }

        async function addSound(channelId) {
            const name = document.getElementById(`snd-name-${channelId}`).value.toLowerCase().trim();
            const url = document.getElementById(`snd-url-${channelId}`).value.trim();
            const cost = parseInt(document.getElementById(`snd-cost-${channelId}`).value) || 1000;

            if (!name || !url) return alert("Ad ve URL bo≈ü olamaz!");

            // Mevcut ayarlarƒ± √ßek
            const res = await fetch('/admin-api/channels', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key: sessionKey })
            });
            const channels = await res.json();
            const currentSounds = channels[channelId]?.settings?.custom_sounds || {};

            currentSounds[name] = { url, cost };

            await toggleCmd(channelId, 'custom_sounds', currentSounds);
            loadChannels();
        }

        async function uploadSoundFile(id) {
            const fileInp = document.getElementById(`snd-file-${id}`);
            if (!fileInp.files[0]) return;

            const formData = new FormData();
            formData.append('sound', fileInp.files[0]);
            formData.append('key', sessionKey);

            try {
                const res = await fetch('/admin-api/upload-sound', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById(`snd-url-${id}`).value = data.url;
                    alert("Dosya y√ºklendi! ≈ûimdi 'EKLE' butonuna basarak kaydedebilirsin.");
                } else {
                    alert("Hata: " + data.error);
                }
            } catch (e) {
                alert("Y√ºkleme sƒ±rasƒ±nda hata olu≈ütu.");
            }
        }

        async function removeSound(channelId, name) {
            if (!confirm("Sesi silmek istiyor musun?")) return;

            const res = await fetch('/admin-api/channels', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key: sessionKey })
            });
            const channels = await res.json();
            const currentSounds = channels[channelId]?.settings?.custom_sounds || {};

            delete currentSounds[name];

            await toggleCmd(channelId, 'custom_sounds', currentSounds);
            loadChannels();
        }

        async function toggleCmd(channelId, cmd, val) {
            await fetch('/admin-api/toggle-command', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: sessionKey, channelId, command: cmd, value: val })
            });
        }

        async function deleteChannel(channelId) {
            if (!confirm("Bu kanalƒ± silmek istediƒüine emin misin? Bot √ßƒ±kƒ±≈ü yapacak.")) return;
            await fetch('/admin-api/delete-channel', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: sessionKey, channelId })
            });
            loadChannels();
        }

        // Redundant functions removed

        async function editBalance(name, current) {
            const newBal = prompt(`Yeni bakiye gir(${name}): `, current);
            if (newBal !== null) {
                await fetch('/admin-api/update-user', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key: sessionKey, user: name, balance: newBal })
                });
                alert("G√ºncellendi!");
                loadUsers();
            }
        }

        function showBanStats(username) {
            const user = allUsers[username];
            const modal = document.getElementById('banModal');
            const content = document.getElementById('banModalContent');

            if (!user || !user.bans || Object.keys(user.bans).length === 0) {
                content.innerHTML = "<p>Bu kullanƒ±cƒ± hi√ß banlanmamƒ±≈ü. üòá</p>";
            } else {
                let html = "<ul style='list-style:none; padding:0;'>";
                for (const [channelId, count] of Object.entries(user.bans)) {
                    html += `<li style='margin-bottom:5px; padding:5px; background:#444; border-radius:4px;'>
                        <b>Kanal:</b> ${channelId} <br>
                        <b>Ban Sayƒ±sƒ±:</b> ${count}
                    </li>`;
                }
                html += "</ul>";
                content.innerHTML = html;
            }
            modal.style.display = 'flex';
        }

        async function resetUser(name) {
            if (!confirm(`${name} kullanƒ±cƒ±sƒ±nƒ± sƒ±fƒ±rlamak istediƒüine emin misin ? (Bakiye: 1000)`)) return;
            await fetch('/admin-api/update-user', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: sessionKey, user: name, balance: 1000 })
            });
            alert("Kullanƒ±cƒ± sƒ±fƒ±rlandƒ±!");
            loadUsers();
        }

        async function sendToChannel() {
            const channelId = document.getElementById('targetChannel').value;
            const message = document.getElementById('channelMsg').value;
            if (!channelId) return alert("Kanal se√ßmelisin!");
            if (!message.trim()) return alert("Mesaj yazmalƒ±sƒ±n!");

            const res = await fetch('/admin-api/send-message', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: sessionKey, channelId: parseInt(channelId), message })
            });
            const data = await res.json();
            if (data.success) {
                alert("Mesaj g√∂nderildi! ‚úÖ");
                document.getElementById('channelMsg').value = '';
            } else {
                alert("Hata: " + (data.error || "Bilinmeyen"));
            }
        }

        // TROLL ACTIONS
        async function setRigShip() {
            const user = document.getElementById('rigUser').value;
            const target = document.getElementById('rigTarget').value;
            const percent = document.getElementById('rigPercent').value;
            await fetch('/admin-api/rig-ship', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: sessionKey, user, target, percent })
            });
            alert("A≈ûK AYARLANDI! ‚ù§Ô∏è");
        }

        async function setGamble(res) {
            const user = document.getElementById('gambleUser').value;
            await fetch('/admin-api/rig-gamble', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: sessionKey, user, result: res })
            });
            alert("KUMAR AYARLANDI! üé∞");
        }

        async function resetOverlayKey(channelId) {
            if (!confirm("Overlay anahtarƒ±nƒ± sƒ±fƒ±rlamak istiyor musun? Eski link artƒ±k √ßalƒ±≈ümayacaktƒ±r.")) return;
            const res = await fetch('/admin-api/reset-overlay-key', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: sessionKey, channelId })
            });
            const data = await res.json();
            if (data.success) {
                alert("Yeni anahtar olu≈üturuldu!");
                loadChannels();
            }
        }

        async function distributeBalance(channelId) {
            const amt = document.getElementById(`dist-amt-${channelId}`).value;
            if (!amt || amt <= 0) return alert("Hatalƒ± miktar!");

            if (!confirm(`${amt} bakiyeyi bu kanaldaki HERKESE daƒüƒ±tmak √ºzeresin. Emin misin?`)) return;

            const res = await fetch('/admin-api/distribute-balance', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: sessionKey, channelId, amount: amt })
            });
            const data = await res.json();
            if (data.success) {
                alert(`ƒ∞≈ülem Ba≈üarƒ±lƒ±! Toplam ${data.count} ki≈üiye ${amt} üí∞ daƒüƒ±tƒ±ldƒ±.`);
                document.getElementById(`dist-amt-${channelId}`).value = "";
            } else {
                alert("Hata: " + data.error);
            }
        }

        async function chatAction(act) {
            // ƒ∞lk aktif kanalƒ± hedef alalƒ±m (Geli≈ütirilebilir: Kanal se√ßimi eklenebilir)
            const firstChannel = document.querySelector('.card p')?.innerText.replace('ID: ', '');
            if (!firstChannel) return alert("Aktif kanal yok!");

            await fetch('/admin-api/chat-action', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: sessionKey, action: act, channelId: parseInt(firstChannel) })
            });
            alert("DURUM G√úNCELLENDƒ∞! üõ°Ô∏è");
        }
    </script>
</body>

</html>